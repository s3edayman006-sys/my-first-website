<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-lang-key="pageTitle">JO AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0c1521; }
    .container { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    #main-app-container.container { background-color: initial; }

    .control-panel { background: linear-gradient(135deg, #1A2033 0%, #171E2D 100%); border: 1px solid #334155; }
    .button-style {
      background: linear-gradient(145deg, #0f172a 0%, #0c1521 100%); color: white;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden;
      border: 1px solid #4ade80; box-shadow: 0 0 10px #4ade8050;
    }
    .button-style:hover { background: linear-gradient(145deg, #1c2742 0%, #151d2e 100%); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
    .button-style:active { transform: translateY(1px); }
    .button-style::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 300%; height: 300%;
      background-color: rgba(255,255,255,0.15); transition: all 0.6s ease-in-out; border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
    }
    .button-style:hover::before { transform: translate(-50%, -50%) scale(1); }
    .modal-overlay { background-color: rgba(12, 21, 33, 0.8); backdrop-filter: blur(4px); }
    .modal-content { background-color: #1f2937; border: 1px solid #334155; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
    .loading-animation { border-top-color: #4ade80; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .glowing-shadow { box-shadow: 0 0 15px rgba(255,255,255,0.1), 0 0 30px rgba(74,222,128,0.2), 0 0 45px rgba(74,222,128,0.1); }
    .glowing-shadow-green { box-shadow: 0 0 15px rgba(74, 222, 128, 0.2), 0 0 30px rgba(74, 222, 128, 0.1), 0 0 45px rgba(74, 222, 128, 0.05); }
    .glowing-shadow-green:hover { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4), 0 0 40px rgba(74, 222, 128, 0.2), 0 0 60px rgba(74, 222, 128, 0.1); }

    /* Background themes */
    .bg-default {
      background-color: #1f2937;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(74, 222, 128, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(74, 222, 128, 0.08) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(74, 222, 128, 0.03) 0%, rgba(74, 222, 128, 0.03) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(74, 222, 128, 0.03) 0%, rgba(74, 222, 128, 0.03) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }
    .bg-green-trade {
      background-color: #064e3b;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(74, 222, 128, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(74, 222, 128, 0.15) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(74, 222, 128, 0.05) 0%, rgba(74, 222, 128, 0.05) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(74, 222, 128, 0.05) 0%, rgba(74, 222, 128, 0.05) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }
    .bg-red-trade {
      background-color: #7f1d1d;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(252, 165, 165, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(252, 165, 165, 0.1) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(252, 165, 165, 0.03) 0%, rgba(252, 165, 165, 0.03) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(252, 165, 165, 0.03) 0%, rgba(252, 165, 165, 0.03) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }

    /* Multi-image preview (shared) */
    .image-preview-thumbnail { width: 100px; height: 100px; object-fit: cover; border-radius: 0.5rem; border: 2px solid #374151; }
    .remove-image-btn {
      position: absolute; top: -0.5rem; left: -0.5rem;
      background-color: #ef4444; color: white; border-radius: 9999px; width: 1.75rem; height: 1.75rem;
      display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;
    }
    html[dir="ltr"] .remove-image-btn { left: auto; right: -0.5rem; }
    .remove-image-btn:hover { transform: scale(1.1); }

    /* Chat panel styles */
    .chat-panel { background: linear-gradient(135deg, #121a29 0%, #0f1522 100%); border: 1px solid #334155; }
    .chat-messages { max-height: 420px; overflow-y: auto; padding: 0.75rem; }
    .chat-bubble {
      display: inline-block; padding: 0.6rem 0.8rem; border-radius: 0.75rem; line-height: 1.4; font-size: 0.95rem;
      border: 1px solid #303b50;
    }
    .chat-bubble-user { background: #0b1220; color: #e5e7eb; }
    .chat-bubble-assistant { background: #122033; color: #d1d5db; }
    .chat-row { margin: 0.4rem 0; }
    .chat-row.user { text-align: end; }
    .chat-row.assistant { text-align: start; }
    .chat-image-thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #374151; }
  </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center justify-center text-white">
    <!-- Ø£Ø²Ø±Ø§Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© -->
  <div class="fixed top-4 right-4 z-50 flex gap-2">
    <button id="lang-ar" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button id="lang-en" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">English</button>
  </div>

  <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
  <div id="welcome-screen" class="min-h-screen w-full flex flex-col items-center justify-center p-4 text-white bg-gradient-to-br from-[#0c1521] to-[#1a2033] via-[#10192a]">
    <div class="container max-w-4xl p-8 rounded-3xl glowing-shadow text-center md:text-right relative overflow-hidden">
      <div class="relative z-10">
        <h1 class="text-4xl lg:text-5xl font-extrabold mb-8 text-green-400">JO AI <span class="text-gray-200" data-lang-key="featuresTitle">Features</span></h1>
        <ul class="space-y-4 text-lg md:text-xl text-right">
          <li class="flex items-start md:items-center"><span class="text-yellow-400 text-2xl ml-3">ğŸ”</span><span class="font-medium text-gray-300" data-lang-key="feature1">Live Market Insights â€“ Tracks prices, market cap, FDV, and token holders.</span></li>
          <li class="flex items-start md:items-center"><span class="text-blue-400 text-2xl ml-3">ğŸ“ˆ</span><span class="font-medium text-gray-300" data-lang-key="feature2">Token Analytics â€“ Analyzes supply, tokenomics, and unlock schedules.</span></li>
          <li class="flex items-start md:items-center"><span class="text-purple-400 text-2xl ml-3">ğŸ’¡</span><span class="font-medium text-gray-300" data-lang-key="feature3">AI-Powered Insights â€“ Detects trends, sentiment.</span></li>
          <li class="flex items-start md:items-center"><span class="text-green-400 text-2xl ml-3">ğŸ“Š</span><span class="font-medium text-gray-300" data-lang-key="feature4">Technical & Fundamental Analysis â€“ Evaluates price stability, risks, and entry points.</span></li>
          <li class="flex items-start md:items-center"><span class="text-orange-400 text-2xl ml-3">ğŸ’¼</span><span class="font-medium text-gray-300" data-lang-key="feature5">Exchange & Liquidity â€“ Lists exchanges, liquidity scores, and supported wallets.</span></li>
          <li class="flex items-start md:items-center"><span class="text-pink-400 text-2xl ml-3">ğŸŒ</span><span class="font-medium text-gray-300" data-lang-key="feature6">Community Tracking â€“ Monitors Twitter, Telegram, and Discord engagement.</span></li>
          <li class="flex items-start md:items-center"><span class="text-red-400 text-2xl ml-3">ğŸ”’</span><span class="font-medium text-gray-300" data-lang-key="feature7">Security & Audit Reports â€“ Highlights security scores and past audits.</span></li>
        </ul>
        <button id="proceed-to-login-btn" class="button-style mt-12 px-8 py-4 text-xl rounded-full font-bold glowing-shadow-green" data-lang-key="loginButton">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login-form-container" class="hidden w-full max-w-sm">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2" data-lang-key="loginToJOUAI">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ JO AI</h1>
      </div>
      <form id="login-form" class="space-y-6">
        <div>
          <label for="username-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="usernameLabel">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
          <input type="text" id="username-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <div>
          <label for="password-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="passwordLabel">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
          <input type="password" id="password-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <button type="submit" class="w-full p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="loginSubmit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </form>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© -->
  <div id="waiting-screen" class="hidden w-full max-w-sm text-center">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="waitingForApprovalTitle">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h2>
      <p class="text-gray-400" data-lang-key="waitingForApprovalText">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</p>
      <div class="mt-6"><div class="loading-animation w-12 h-12 border-4 rounded-full mx-auto"></div></div>
    </div>
  </div>
    <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="main-app-container" class="container w-full max-w-4xl p-8 rounded-3xl glowing-shadow hidden bg-default">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">JO AI</h1>
      <p class="text-gray-400" data-lang-key="mainAppSubtitle">Ø£Ø¯Ø§Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
      <p id="user-id-display" class="text-xs text-gray-500 mt-2" data-lang-key="idPrefix">Ø§Ù„Ù…Ø¹Ø±Ù: </p>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ -->
    <div class="control-panel p-6 rounded-3xl mb-6">
      <!-- Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ + Ø§Ù„Ù…ÙØ§ØªÙŠØ­ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="provider-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="providerLabel">Ù…ÙˆÙÙ‘Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:</label>
          <select id="provider-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
            <option value="gemini" selected data-lang-key="providerGemini">Google Gemini</option>
            <option value="openai" data-lang-key="providerOpenAI">OpenAI (ChatGPT)</option>
          </select>
        </div>
        <div>
          <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="apiKeyLabel">Ù…ÙØªØ§Ø­ API:</label>
          <input type="text" id="api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Google AI Studio" data-lang-key="apiKeyPlaceholder" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="openai-api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="openaiApiKeyLabel">Ù…ÙØªØ§Ø­ OpenAI:</label>
          <input type="password" id="openai-api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
          <p class="text-xs text-gray-500 mt-1" data-lang-key="openaiNote">Ù„Ù† ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± OpenAI.</p>
        </div>
      </div>

      <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØµÙˆØ± -->
      <div class="grid grid-cols-1 gap-6">
        <div>
          <textarea id="input-query" rows="4" class="w-full p-4 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ø³ÙˆÙ‚... Ø£ÙŠ Ø´ÙŠØ¡. Ø£Ù†Ø§ Ø£Ø¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©." data-lang-key="inputQueryPlaceholder"></textarea>
          <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
          <div id="image-preview-container" class="hidden mt-4 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
            <div id="image-previews-wrapper" class="flex flex-wrap gap-4"></div>
          </div>
        </div>

        <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨ + Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="trading-style-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="tradingStyleLabel">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨:</label>
            <select id="trading-style-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
              <option value="Ø³ÙƒØ§Ù„Ø¨ÙŠÙ†Ø¬" data-lang-key="scalpingOption">Ø³ÙƒØ§Ù„Ø¨ÙŠÙ†Ø¬ (Scalping)</option>
              <option value="Ø³ÙˆÙŠÙ†Øº" selected data-lang-key="swingOption">Ø³ÙˆÙŠÙ†Øº (Swing)</option>
              <option value="Ø§Ø³ØªØ«Ù…Ø§Ø±" data-lang-key="investmentOption">Ø§Ø³ØªØ«Ù…Ø§Ø± (Investment)</option>
            </select>
          </div>
          <div>
            <label for="school-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="schoolLabel">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©:</label>
            <select id="school-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
              <option value="ICT" selected data-lang-key="schoolICT">Ù…Ø¯Ø±Ø³Ø© ICT</option>
              <option value="SMC" data-lang-key="schoolSMC">Ù…Ø¯Ø±Ø³Ø© SMC</option>
              <option value="Ø§Ù„Ø²Ù…Ù†ÙŠØ©" data-lang-key="schoolTime">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</option>
              <option value="Ø§Ù„Ù…ÙˆØ¬ÙŠØ© (Ø¥Ù„ÙŠÙˆØª)" data-lang-key="schoolElliott">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…ÙˆØ¬ÙŠØ© (Ø¥Ù„ÙŠÙˆØª)</option>
            </select>
          </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <button id="analyze-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="technicalAnalysisBtn">ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ</button>
            <button id="fundamental-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="fundamentalAnalysisBtn">ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠ</button>
            <button id="direct-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="directTradeBtn">ØªÙˆØµÙŠØ© ØªØ¯Ø§ÙˆÙ„</button>
            <button id="high-conviction-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="highConvictionBtn">ØªÙˆØµÙŠØ© Ø°Ø§Øª Ù‚Ù†Ø§Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©</button>
          </div>
          <div class="mt-4 flex justify-center gap-3">
            <button id="upload-btn" class="w-2/3 p-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105" data-lang-key="uploadImageBtn">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
    <div id="output-section" class="relative bg-gray-800 rounded-lg p-4 min-h-[200px] border border-gray-700 shadow-inner">
      <div id="loading-spinner" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        <div class="loading-animation w-12 h-12 border-4 rounded-full"></div>
      </div>
      <div id="output-text" class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed"></div>
      <div class="flex justify-end mt-4">
        <button id="save-btn" class="hidden px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold text-sm rounded-lg transition-all duration-300 transform hover:scale-105" data-lang-key="saveButton">Ø­ÙØ¸</button>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù‘Ù… -->
    <div id="chat-panel" class="chat-panel p-6 rounded-3xl mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-white" data-lang-key="chatTitle">Ø´Ø§Øª GPT Ù…ØªÙ‚Ø¯Ù‘Ù…</h2>
        <div class="flex items-center gap-2 text-xs text-gray-400">
          <span class="hidden md:inline" data-lang-key="chatHint">ÙŠØ¯Ø¹Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„ØµÙˆØ± â€¢ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</span>
        </div>
      </div>

      <div id="chat-messages" class="chat-messages bg-gray-900/40 rounded-lg border border-gray-700"></div>

      <div class="mt-4">
        <textarea id="chat-input" rows="3" class="w-full p-3 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." data-lang-key="chatPlaceholder"></textarea>

        <!-- Ù…Ø±ÙÙ‚Ø§Øª ØµÙˆØ± Ø§Ù„Ø´Ø§Øª -->
        <input type="file" id="chat-image-upload" accept="image/*" class="hidden" multiple>
        <div id="chat-image-preview-container" class="hidden mt-3 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
          <div id="chat-image-previews-wrapper" class="flex flex-wrap gap-3"></div>
        </div>

        <div class="flex items-center gap-3 mt-3">
          <button id="chat-upload-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="uploadImageChatBtn">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±</button>
          <button id="chat-clear-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="clearChat">ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
          <div class="ml-auto flex items-center gap-2">
            <div id="chat-loading" class="hidden loading-animation w-6 h-6 border-2 rounded-full"></div>
            <button id="chat-send-btn" class="px-6 py-2 button-style rounded-lg font-semibold" data-lang-key="sendButton">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
    <div id="admin-panel" class="hidden mt-6 p-6 bg-gray-900 rounded-2xl shadow-inner border border-gray-700">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="pendingRequestsTitle">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
      <div id="requests-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="noPendingRequests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>
      </div>
      <h2 class="text-2xl font-bold text-white mb-4 mt-8" data-lang-key="manageUsersTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <div id="users-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="loadingUsers">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
      </div>
    </div>
  </div>
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
  <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <div class="text-center">
        <p id="modal-text" class="text-lg text-white mb-4"></p>
        <button id="close-modal-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="okButton">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠØ© Ø°Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© -->
  <div id="invincible-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-lg">
      <div class="text-center">
        <h3 class="text-2xl font-bold text-green-400 mb-4" data-lang-key="highConvictionModalTitle">ØªÙˆØµÙŠØ© Ø°Ø§Øª Ù‚Ù†Ø§Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©</h3>
        <p class="text-gray-300 mb-6" data-lang-key="highConvictionModalText">ØªØ­Ù„ÙŠÙ„Ø§ØªÙŠ Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ Ø­ØµØ± Ù„Ù‡Ø§ØŒ ÙˆÙ‡Ø°Ù‡ Ø§Ù„ØªÙˆØµÙŠØ© ØªØªÙ…ØªØ¹ Ø¨Ø£Ø¹Ù„Ù‰ Ù‚Ù†Ø§Ø¹Ø© Ù…Ù…ÙƒÙ†Ø©. ÙˆÙ…Ø¹ Ø°Ù„ÙƒØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø¶Ù…Ø§Ù† Ù„Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚. Ù‡Ù„ Ø£Ù†Øª Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¶ÙŠ Ù‚Ø¯Ù…Ø§Ù‹ØŸ</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-invincible-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="yesImReady">Ù†Ø¹Ù…ØŒ Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø²</button>
          <button id="cancel-invincible-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù -->
  <div id="confirm-delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <div class="text-center">
        <h3 class="text-xl font-bold text-red-400 mb-4" data-lang-key="confirmDeleteTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
        <p id="confirm-delete-text" class="text-lg text-white mb-6" data-lang-key="confirmDeleteText">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="yesDelete">Ù†Ø¹Ù…, Ø­Ø°Ù</button>
          <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>
    <script type="module">
    // Firebase & Google AI + App logic (with Chat + School + Providers)

    // Firebase (CDN) - v12.2.1
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    let userId = null;
    let userRole = 'user';
    let currentImagesData = []; // analysis images
    let currentChatImagesData = []; // chat images
    const MAX_RETRIES = 3;
    let userToDeleteId = null;
    const appId = 'default-app-id';
    let currentLanguage = localStorage.getItem('appLang') || 'ar';

    // ØªØ±Ø¬Ù…Ø§Øª
    const translations = {
      'ar': {
        pageTitle: 'JO AI',
        featuresTitle: 'Ø§Ù„Ù…ÙŠØ²Ø§Øª',
        feature1: 'Ø±Ø¤Ù‰ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­ÙŠØ© â€“ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©ØŒ FDVØŒ ÙˆØ­Ø§Ù…Ù„ÙŠ Ø§Ù„Ø±Ù…ÙˆØ².',
        feature2: 'ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ù…ÙˆØ² â€“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ§Øª Ø§Ù„Ø±Ù…ÙˆØ²ØŒ ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙØªØ­.',
        feature3: 'Ø±Ø¤Ù‰ Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â€“ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§ØªØŒ Ø§Ù„Ù…Ø¹Ù†ÙˆÙŠØ§Øª.',
        feature4: 'ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ÙˆØ£Ø³Ø§Ø³ÙŠ â€“ ØªÙ‚ÙŠÙŠÙ… Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ÙˆÙ†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„.',
        feature5: 'Ø§Ù„ØªØ¨Ø§Ø¯Ù„ ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø© â€“ Ø³Ø±Ø¯ Ø§Ù„ØªØ¨Ø§Ø¯Ù„Ø§ØªØŒ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø©ØŒ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©.',
        feature6: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ â€“ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„Ù‰ ØªÙˆÙŠØªØ±ØŒ ØªÙ„ØºØ±Ø§Ù…ØŒ ÙˆØ¯ÙŠØ³ÙƒÙˆØ±Ø¯.',
        feature7: 'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚ â€“ ØªØ³Ù„ÙŠØ· Ø§Ù„Ø¶ÙˆØ¡ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.',
        loginButton: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        loginToJOUAI: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ JO AI',
        usernameLabel: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:',
        passwordLabel: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:',
        loginSubmit: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        waitingForApprovalTitle: 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©',
        waitingForApprovalText: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.',
        mainAppSubtitle: 'Ø£Ø¯Ø§Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
        idPrefix: 'Ø§Ù„Ù…Ø¹Ø±Ù: ',
        apiKeyLabel: 'Ù…ÙØªØ§Ø­ API:',
        apiKeyPlaceholder: 'Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Google AI Studio',
        providerLabel: 'Ù…ÙˆÙÙ‘Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'Ù…ÙØªØ§Ø­ OpenAI:',
        openaiNote: 'Ù„Ù† ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± OpenAI.',
        inputQueryPlaceholder: 'Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ø³ÙˆÙ‚... Ø£ÙŠ Ø´ÙŠØ¡. Ø£Ù†Ø§ Ø£Ø¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.',
        tradingStyleLabel: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨:',
        scalpingOption: 'Ø³ÙƒØ§Ù„Ø¨ÙŠÙ†Ø¬ (Scalping)',
        swingOption: 'Ø³ÙˆÙŠÙ†Øº (Swing)',
        investmentOption: 'Ø§Ø³ØªØ«Ù…Ø§Ø± (Investment)',
        schoolLabel: 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©:',
        schoolICT: 'Ù…Ø¯Ø±Ø³Ø© ICT',
        schoolSMC: 'Ù…Ø¯Ø±Ø³Ø© SMC',
        schoolTime: 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©',
        schoolElliott: 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…ÙˆØ¬ÙŠØ© (Ø¥Ù„ÙŠÙˆØª)',
        technicalAnalysisBtn: 'ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ',
        fundamentalAnalysisBtn: 'ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠ',
        directTradeBtn: 'ØªÙˆØµÙŠØ© ØªØ¯Ø§ÙˆÙ„',
        highConvictionBtn: 'ØªÙˆØµÙŠØ© Ø°Ø§Øª Ù‚Ù†Ø§Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©',
        uploadImageBtn: 'ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±',
        saveButton: 'Ø­ÙØ¸',
        pendingRequestsTitle: 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©',
        noPendingRequests: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.',
        manageUsersTitle: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
        loadingUsers: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...',
        okButton: 'Ù…ÙˆØ§ÙÙ‚',
        highConvictionModalTitle: 'ØªÙˆØµÙŠØ© Ø°Ø§Øª Ù‚Ù†Ø§Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©',
        highConvictionModalText: 'ØªØ­Ù„ÙŠÙ„Ø§ØªÙŠ Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ Ø­ØµØ± Ù„Ù‡Ø§ØŒ ÙˆÙ‡Ø°Ù‡ Ø§Ù„ØªÙˆØµÙŠØ© ØªØªÙ…ØªØ¹ Ø¨Ø£Ø¹Ù„Ù‰ Ù‚Ù†Ø§Ø¹Ø© Ù…Ù…ÙƒÙ†Ø©. ÙˆÙ…Ø¹ Ø°Ù„ÙƒØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø¶Ù…Ø§Ù† Ù„Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚. Ù‡Ù„ Ø£Ù†Øª Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¶ÙŠ Ù‚Ø¯Ù…Ø§Ù‹ØŸ',
        yesImReady: 'Ù†Ø¹Ù…ØŒ Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø²',
        cancelButton: 'Ø¥Ù„ØºØ§Ø¡',
        confirmDeleteTitle: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        confirmDeleteText: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
        yesDelete: 'Ù†Ø¹Ù…, Ø­Ø°Ù',
        unknown: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
        approveButton: 'Ù…ÙˆØ§ÙÙ‚Ø©',
        denyButton: 'Ø±ÙØ¶',
        suspendButton: 'ØªØ¹Ù„ÙŠÙ‚',
        reactivateButton: 'Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„',
        deleteButton: 'Ø­Ø°Ù',
        buyKeyword: 'Ø´Ø±Ø§Ø¡',
        sellKeyword: 'Ø¨ÙŠØ¹',

        // Ø´Ø§Øª
        chatTitle: 'Ø´Ø§Øª GPT Ù…ØªÙ‚Ø¯Ù‘Ù…',
        chatPlaceholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...',
        sendButton: 'Ø¥Ø±Ø³Ø§Ù„',
        clearChat: 'ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
        uploadImageChatBtn: 'Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±',
        chatHint: 'ÙŠØ¯Ø¹Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„ØµÙˆØ± â€¢ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰',

        // Ø±Ø³Ø§Ø¦Ù„ ÙˆØ£Ø®Ø·Ø§Ø¡
        firebaseInitFail: 'ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase: ',
        dbConnectionError: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.',
        requestAlreadyPending: 'Ø·Ù„Ø¨ Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„.',
        loginRequestError: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„.',
        requestApproved: 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ! Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
        requestDenied: 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',
        requestCancelled: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',
        approvalFailed: 'ÙØ´Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.',
        denialFailed: 'ÙØ´Ù„ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.',
        noRegisteredUsers: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ†.',
        accountSuspended: 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ù„Ù‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.',
        unknownAccountStatus: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©.',
        loginFlowError: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.',
        deleteUserSuccess: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.',
        deleteUserFailed: 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….',
        updateUserStatusFailed: 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….',
        noAnalysisToSave: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ø­ÙØ¸.',
        sessionSaveFailed: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„.',
        sessionSavedSuccess: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.',
        noDbOrUserForSave: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„.',
        apiKeyRequired: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',
        openaiApiKeyRequired: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ OpenAI.',
        queryOrImageRequired: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©.',
        apiRetryFailed: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØ§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©. ',
        apiBlocked: 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ø£Ø³Ø¨Ø§Ø¨ ØªØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©: ',

        // Prompts
        highConvictionSystemPrompt: 'Ø¨ØµÙØªÙƒ "JO AI"ØŒ Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø£Ø³ÙˆØ§Ù‚ Ù…Ø§Ù„ÙŠØ© Ø¹Ø§Ù„Ù…ÙŠ Ù„Ø§ ÙŠÙØ¹Ù„Ù‰ Ø¹Ù„ÙŠÙ‡... Ø£Ø³Ù„ÙˆØ¨ ØªØ¯Ø§ÙˆÙ„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ù‹Ø§ ÙˆØªÙˆØµÙŠØ© ØªØ¯Ø§ÙˆÙ„ Ø°Ø§Øª Ù‚Ù†Ø§Ø¹Ø© Ù„Ø§ ØªØªØ²Ø¹Ø²Ø¹ Ù„Ù€ "',
        highConvictionUserQuerySuffix: '". Ø§Ø³ØªÙ†Ø¯ Ø¥Ù„Ù‰ Ø£Ø¹Ù…Ù‚ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠ... Ù‚Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø¸Ù… Ù„Ù„ØºØ§ÙŠØ©...',
        imageAnalysisQuery: 'Ø­Ù„Ù„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ù…Ù†Ø¸ÙˆØ± Ù…Ø§Ù„ÙŠ ÙˆØªØ¯Ø§ÙˆÙ„ÙŠ. Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø£Ùˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ù„Ø§ØµÙ‡Ø§ Ù…Ù†Ù‡Ø§ØŸ',
        imageReferenceSuffixSingle: 'Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© ÙƒÙ…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ Ù„ØªØ­Ù„ÙŠÙ„Ùƒ.',
        imageReferenceSuffixMultiple: 'Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø© ÙƒÙ…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ Ù„ØªØ­Ù„ÙŠÙ„Ùƒ.',

        // Chat system prompt
        chatSystemPrompt: 'Ø£Ù†Øª "JO GPT"ØŒ Ù…Ø³Ø§Ø¹Ø¯ ØªØ¯Ø§ÙˆÙ„ ÙˆØ§Ø³ØªØ«Ù…Ø§Ø± ÙØ§Ø¦Ù‚ Ø§Ù„ØªØ·ÙˆØ±. ØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø·Ù„Ø§Ù‚Ø© ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙˆØ§Ø«Ù‚. Ù‚Ø¯Ù‘Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø°ÙƒÙŠØ© Ù…ÙˆØ¬Ø²Ø© ÙˆØ¹Ù…ÙŠÙ‚Ø©ØŒ Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ù…Ù†Ø·Ù‚ Ù…ØªÙ…Ø§Ø³Ùƒ ÙˆÙ…ÙÙ„Ø§Ø¦Ù…Ø© Ù„Ù„Ø³ÙŠØ§Ù‚. Ø§Ù„ØªØ²Ù… Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: Ù„Ø§ ÙˆØ¹ÙˆØ¯ØŒ Ù„Ø§ Ù†ØµØ§Ø¦Ø­ Ù…Ø§Ù„ÙŠØ© Ù…Ù„Ø²Ù…Ø©ØŒ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø©. Ù†Ù…Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ "${tradingStyle}" ÙˆØ§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…ÙØ¶Ù‘Ù„ Ù‡Ùˆ "${school}".'
      },
      'en': {
        pageTitle: 'JO AI',
        featuresTitle: 'Features',
        feature1: 'Live Market Insights â€“ Tracks prices, market cap, FDV, and token holders.',
        feature2: 'Token Analytics â€“ Analyzes supply, tokenomics, and unlock schedules.',
        feature3: 'AI-Powered Insights â€“ Detects trends, sentiment.',
        feature4: 'Technical & Fundamental Analysis â€“ Evaluates price stability, risks, and entry points.',
        feature5: 'Exchange & Liquidity â€“ Lists exchanges, liquidity scores, and supported wallets.',
        feature6: 'Community Tracking â€“ Monitors Twitter, Telegram, and Discord engagement.',
        feature7: 'Security & Audit Reports â€“ Highlights security scores and past audits.',
        loginButton: 'Login',
        loginToJOUAI: 'Login to JO AI',
        usernameLabel: 'Username:',
        passwordLabel: 'Password:',
        loginSubmit: 'Login',
        waitingForApprovalTitle: 'Awaiting Approval',
        waitingForApprovalText: 'Your login request has been sent. Please wait for an administrator to approve it.',
        mainAppSubtitle: 'AI-Powered Market Analysis Tool',
        idPrefix: 'ID: ',
        apiKeyLabel: 'API Key:',
        apiKeyPlaceholder: 'Enter your Google AI Studio API key',
        providerLabel: 'Model Provider:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'OpenAI Key:',
        openaiNote: 'This field appears only when OpenAI is selected.',
        inputQueryPlaceholder: 'Ask me about the market... anything. I know the answer.',
        tradingStyleLabel: 'Trading Style:',
        scalpingOption: 'Scalping',
        swingOption: 'Swing',
        investmentOption: 'Investment',
        schoolLabel: 'Analytical School:',
        schoolICT: 'ICT School',
        schoolSMC: 'SMC School',
        schoolTime: 'Time-based School',
        schoolElliott: 'Elliott Wave School',
        technicalAnalysisBtn: 'Technical Analysis',
        fundamentalAnalysisBtn: 'Fundamental Analysis',
        directTradeBtn: 'Direct Trade Recommendation',
        highConvictionBtn: 'High Conviction Recommendation',
        uploadImageBtn: 'Upload Images',
        saveButton: 'Save',
        pendingRequestsTitle: 'Pending Login Requests',
        noPendingRequests: 'No pending requests currently.',
        manageUsersTitle: 'User Management',
        loadingUsers: 'Loading users...',
        okButton: 'OK',
        highConvictionModalTitle: 'High Conviction Recommendation',
        highConvictionModalText: 'My analysis is based on countless data points... Are you ready to proceed?',
        yesImReady: 'Yes, I\'m Ready',
        cancelButton: 'Cancel',
        confirmDeleteTitle: 'Confirm Deletion',
        confirmDeleteText: 'Are you sure you want to delete this user? This action cannot be undone.',
        yesDelete: 'Yes, Delete',
        unknown: 'Unknown',
        approveButton: 'Approve',
        denyButton: 'Deny',
        suspendButton: 'Suspend',
        reactivateButton: 'Reactivate',
        deleteButton: 'Delete',
        buyKeyword: 'Buy',
        sellKeyword: 'Sell',

        // Chat
        chatTitle: 'Advanced GPT Chat',
        chatPlaceholder: 'Type your message...',
        sendButton: 'Send',
        clearChat: 'Clear Chat',
        uploadImageChatBtn: 'Attach Images',
        chatHint: 'Context + images supported â€¢ Choose provider above',

        // Errors
        firebaseInitFail: 'Firebase initialization failed: ',
        dbConnectionError: 'Database connection error. Please try again later.',
        requestAlreadyPending: 'A login request for this username is already pending.',
        loginRequestError: 'An error occurred while sending the login request.',
        requestApproved: 'Your request has been approved! Please log in again.',
        requestDenied: 'Your login request has been denied.',
        requestCancelled: 'Your login request has been cancelled.',
        approvalFailed: 'Failed to approve request.',
        denialFailed: 'Failed to deny request.',
        noRegisteredUsers: 'No registered users.',
        accountSuspended: 'Your account is suspended. Please contact an administrator.',
        unknownAccountStatus: 'Unknown account status.',
        loginFlowError: 'An error occurred during the login attempt.',
        deleteUserSuccess: 'User deleted successfully.',
        deleteUserFailed: 'Failed to delete user.',
        updateUserStatusFailed: 'Failed to update user status.',
        noAnalysisToSave: 'No analysis to save.',
        sessionSaveFailed: 'An error occurred while saving the analysis.',
        sessionSavedSuccess: 'Analysis saved successfully.',
        noDbOrUserForSave: 'Cannot save session. Connection error or user not logged in.',
        apiKeyRequired: 'Please enter your API key.',
        openaiApiKeyRequired: 'Please enter your OpenAI API key.',
        queryOrImageRequired: 'Please enter a query or upload an image.',
        apiRetryFailed: 'An error occurred after multiple attempts to connect to the API. Please check your API key and network connection. ',
        apiBlocked: 'Response was blocked due to safety reasons: ',

        highConvictionSystemPrompt: 'As "JO AI", you are an unparalleled global financial market expert... Your current trading style is "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'Provide an unwavering high-conviction trading analysis and recommendation for "',
        highConvictionUserQuerySuffix: '". Base your analysis on the deepest levels... Present this information in a highly organized format...',
        imageAnalysisQuery: 'Analyze the provided images from a financial and trading perspective. What patterns, indicators, or information can you extract from them?',
        imageReferenceSuffixSingle: 'Use the attached image as an additional reference for your analysis.',
        imageReferenceSuffixMultiple: 'Use the attached images as an additional reference for your analysis.',

        chatSystemPrompt: 'You are "JO GPT", an ultra-advanced trading/investment assistant. Respond in a professional, confident tone. Provide concise, deep, and context-aware answers with coherent reasoning. No guarantees, no binding financial advice; mention risks when relevant. Current trading style: "${tradingStyle}", preferred technical school: "${school}".'
      }
    };

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCD_WhxL_TzGl4iHfAMFpR7wlYb-3rjK-Y",
      authDomain: "soso-ai-b2c99.firebaseapp.com",
      projectId: "soso-ai-b2c99",
      storageBucket: "soso-ai-b2c99.appspot.com",
      messagingSenderId: "726550376016",
      appId: "1:726550376016:web:42b9ed1bc576873754ab55",
      measurementId: "G-ZVJBJ02Q71"
    };

    // Initialize Firebase
    let app, analytics, auth, db, storage;
    try {
      app = initializeApp(firebaseConfig);
      try { analytics = getAnalytics(app); } catch(e){ console.debug("Analytics not initialized (likely localhost).", e); }
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
    } catch (e) {
      console.error("Firebase init error:", e);
      showMessageModal(`${translations[localStorage.getItem('appLang') || 'ar']['firebaseInitFail']}${e.message}.`);
    }

    // Helpers
    const imageToBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
    });

    const formatMarkdown = (text) => {
      if(!text) return '';
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    };

    const showMessageModal = (message) => {
      const el = document.getElementById('message-modal');
      document.getElementById('modal-text').textContent = message;
      el.classList.remove('hidden');
    };

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        const ud = document.getElementById('user-id-display');
        if (ud) ud.textContent = `${translations[currentLanguage]['idPrefix']}${userId}`;
        console.debug("Authenticated as:", userId);
      }
    });

    // Language update
    const updateLanguage = (lang) => {
      currentLanguage = lang;
      document.documentElement.setAttribute('lang', lang);
      document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

      document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[lang] && translations[lang][key]) {
          if ((element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') && element.hasAttribute('placeholder')) {
            element.setAttribute('placeholder', translations[lang][key]);
          } else {
            element.textContent = translations[lang][key];
          }
        }
      });

      // Document title
      if (translations[lang]?.pageTitle) document.title = translations[lang].pageTitle;

      // Update select options
      document.querySelectorAll('#trading-style-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#school-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#provider-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });

      const userIdDisplay = document.getElementById('user-id-display');
      if (userIdDisplay) userIdDisplay.textContent = `${translations[currentLanguage]['idPrefix']}${userId || ''}`;

      // Update admin button labels
      document.querySelectorAll('.approve-btn').forEach(btn => btn.textContent = translations[currentLanguage]['approveButton']);
      document.querySelectorAll('.deny-btn').forEach(btn => btn.textContent = translations[currentLanguage]['denyButton']);
      document.querySelectorAll('.delete-user-btn').forEach(btn => btn.textContent = translations[currentLanguage]['deleteButton']);
      document.querySelectorAll('.user-action-btn').forEach(btn => {
        const currentStatus = btn.dataset.status;
        const buttonTextKey = currentStatus === 'active' ? 'suspendButton' : 'reactivateButton';
        btn.textContent = translations[currentLanguage][buttonTextKey];
      });

      const requestsList = document.getElementById('requests-list');
      if(requestsList && requestsList.querySelector('p.text-gray-500')) {
        requestsList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['noPendingRequests'];
      }
      const usersList = document.getElementById('users-list');
      if(usersList && usersList.querySelector('p.text-gray-500')) {
        usersList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['loadingUsers'];
      }
    };

    // ===== Providers: Gemini + OpenAI =====
    // Gemini single-turn (analysis)
    const getGeminiResponse = async (systemPrompt, userQuery, apiKey, imagesBase64 = []) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };

      const parts = [];
      if (imagesBase64?.length) {
        imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
      }
      parts.push({ text: userQuery });

      const payload = { contents: [{ parts }], systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          console.error(`Attempt ${i + 1} failed:`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // Gemini multi-turn (chat)
    const getGeminiChatResponse = async (systemPrompt, history, apiKey) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };

      // Convert history -> contents
      const contents = history.map(msg => {
        const role = msg.role === 'assistant' ? 'model' : 'user';
        const parts = [];
        if (msg.imagesBase64?.length) {
          msg.imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
        }
        parts.push({ text: msg.text });
        return { role, parts };
      });

      const payload = { contents, systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          console.error(`Attempt ${i + 1} failed (Gemini Chat):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // OpenAI chat (analysis + chat)
    const getOpenAIChatResponse = async (systemPrompt, messages, openaiKey, model = 'gpt-4o-mini') => {
      const url = 'https://api.openai.com/v1/chat/completions';
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` };
      const payload = { model, messages, temperature: 0.3 };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`OpenAI Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`OpenAI Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const data = await resp.json();
          return data.choices?.[0]?.message?.content || '';
        } catch (error) {
          console.error(`Attempt ${i + 1} failed (OpenAI):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // Unified provider for analysis
    const getProviderUnifiedResponse = async ({ provider, systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64 }) => {
      if (provider === 'openai') {
        const content = [{ type: 'text', text: userQuery }];
        if (imagesBase64?.length) {
          imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` } }));
        }
        const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content }];
        return await getOpenAIChatResponse(systemPrompt, messages, openaiKey);
      } else {
        return await getGeminiResponse(systemPrompt, userQuery, geminiKey, imagesBase64);
      }
    };

    // ===== Login/Requests/Admin (unchanged except for language hooks) =====
    const submitLoginRequest = async (username) => {
      if (!db) { showMessageModal(translations[currentLanguage]['dbConnectionError']); return; }
      try {
        const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
        const q = query(requestsRef, where("username", "==", username), where("status", "==", "pending"));
        const existingRequests = await getDocs(q);
        if (!existingRequests.empty) {
          showMessageModal(translations[currentLanguage]['requestAlreadyPending']);
          document.getElementById('login-form-container').classList.add('hidden');
          document.getElementById('waiting-screen').classList.remove('hidden');
          listenForApproval(existingRequests.docs[0].id);
          return;
        }
        const docRef = await addDoc(requestsRef, { username, status: 'pending', createdAt: serverTimestamp() });
        sessionStorage.setItem('loginRequestId', docRef.id);
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('waiting-screen').classList.remove('hidden');
        listenForApproval(docRef.id);
      } catch (error) {
        console.error("Error submitting login request:", error);
        showMessageModal(translations[currentLanguage]['loginRequestError']);
      }
    };

    const listenForApproval = (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const unsubscribe = onSnapshot(requestDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const requestData = docSnap.data();
          if (requestData.status === 'approved') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestApproved']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          } else if (requestData.status === 'denied') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestDenied']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          }
        } else {
          unsubscribe();
          sessionStorage.removeItem('loginRequestId');
          showMessageModal(translations[currentLanguage]['requestCancelled']);
          document.getElementById('waiting-screen').classList.add('hidden');
          document.getElementById('login-form-container').classList.remove('hidden');
          document.getElementById('login-form').reset();
        }
      }, (error) => console.error("Error listening for approval:", error));
    };

    const loadLoginRequests = () => {
      const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
      const q = query(requestsRef, where("status", "==", "pending"));
      onSnapshot(q, (snapshot) => {
        const requestsList = document.getElementById('requests-list');
        requestsList.innerHTML = '';
        if (snapshot.empty) {
          requestsList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noPendingRequests']}</p>`;
          return;
        }
        snapshot.forEach((docItem) => {
          const request = docItem.data();
          const requestId = docItem.id;
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const requestDate = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US') : translations[currentLanguage]['unknown'];
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${request.username}</p>
              <p class="text-xs text-gray-400">${requestDate}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${requestId}" data-username="${request.username}" class="approve-btn px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['approveButton']}</button>
              <button data-id="${requestId}" class="deny-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['denyButton']}</button>
            </div>
          `;
          requestsList.appendChild(el);
        });
        document.querySelectorAll('.approve-btn').forEach(button => button.addEventListener('click', (e) => approveRequest(e.target.dataset.id, e.target.dataset.username)));
        document.querySelectorAll('.deny-btn').forEach(button => button.addEventListener('click', (e) => denyRequest(e.target.dataset.id)));
      }, (error) => console.error("Error loading login requests:", error));
    };

    const approveRequest = async (requestId, username) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      try {
        await addDoc(usersRef, { username, status: 'active', createdAt: serverTimestamp() });
        await updateDoc(requestDocRef, { status: 'approved' });
      } catch (error) {
        console.error("Error approving request:", error);
        showMessageModal(translations[currentLanguage]['approvalFailed']);
      }
    };

    const denyRequest = async (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      try { await updateDoc(requestDocRef, { status: 'denied' }); }
      catch (error) { console.error("Error denying request:", error); showMessageModal(translations[currentLanguage]['denialFailed']); }
    };

    const loadUsers = () => {
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      onSnapshot(usersRef, (snapshot) => {
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        if(snapshot.empty){
          usersList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noRegisteredUsers']}</p>`;
          return;
        }
        snapshot.forEach(docItem => {
          const user = docItem.data();
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const statusClass = user.status === 'active' ? 'text-green-400' : 'text-red-400';
          const buttonTextKey = user.status === 'active' ? 'suspendButton' : 'reactivateButton';
          const buttonText = translations[currentLanguage][buttonTextKey];
          const buttonClass = user.status === 'active' ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700';
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${user.username}</p>
              <p class="text-sm ${statusClass}">${user.status}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${docItem.id}" data-status="${user.status}" class="user-action-btn px-3 py-1 text-white text-sm font-semibold rounded-md ${buttonClass}">${buttonText}</button>
              <button data-id="${docItem.id}" class="delete-user-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['deleteButton']}</button>
            </div>
          `;
          usersList.appendChild(el);
        });
        document.querySelectorAll('.user-action-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const currentStatus = e.target.dataset.status;
          const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
          updateUserStatus(id, newStatus);
        }));
        document.querySelectorAll('.delete-user-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          showConfirmDeleteModal(id);
        }));
      }, (error) => console.error("Error loading users:", error));
    };

    const updateUserStatus = async (userDocId, newStatus) => {
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await updateDoc(userDocRef, { status: newStatus }); }
      catch(error) { console.error("Error updating user status:", error); showMessageModal(translations[currentLanguage]['updateUserStatusFailed']); }
    };

    const showConfirmDeleteModal = (userDocId) => { userToDeleteId = userDocId; document.getElementById('confirm-delete-modal').classList.remove('hidden'); };
    const hideConfirmDeleteModal = () => { userToDeleteId = null; document.getElementById('confirm-delete-modal').classList.add('hidden'); };
    const deleteUser = async (userDocId) => {
      if (!userDocId) return;
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await deleteDoc(userDocRef); showMessageModal(translations[currentLanguage]['deleteUserSuccess']); }
      catch(error) { console.error("Error deleting user:", error); showMessageModal(translations[currentLanguage]['deleteUserFailed']); }
    };

    // ===== UI rendering for image previews (analysis + chat) =====
    const renderImagePreviews = () => {
      const previewContainer = document.getElementById('image-preview-container');
      const wrapper = document.getElementById('image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentImagesData.length) { previewContainer.classList.add('hidden'); return; }
      currentImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Preview ${index + 1}" class="image-preview-thumbnail">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentImagesData.splice(indexToRemove, 1);
        document.getElementById('image-upload').value = '';
        renderImagePreviews();
      }));
      previewContainer.classList.remove('hidden');
    };

    const renderChatImagePreviews = () => {
      const container = document.getElementById('chat-image-preview-container');
      const wrapper = document.getElementById('chat-image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentChatImagesData.length) { container.classList.add('hidden'); return; }
      currentChatImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Chat Preview ${index+1}" class="chat-image-thumb">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentChatImagesData.splice(indexToRemove, 1);
        document.getElementById('chat-image-upload').value = '';
        renderChatImagePreviews();
      }));
      container.classList.remove('hidden');
    };

    // ===== MAIN EVENTS =====
    document.addEventListener('DOMContentLoaded', () => {
      const welcomeScreen = document.getElementById('welcome-screen');
      const loginFormContainer = document.getElementById('login-form-container');
      const proceedToLoginBtn = document.getElementById('proceed-to-login-btn');
      const loginForm = document.getElementById('login-form');
      const mainAppContainer = document.getElementById('main-app-container');

      // Set language
      updateLanguage(currentLanguage);
      if (currentLanguage === 'ar') {
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      } else {
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      }

      // Show welcome
      welcomeScreen.classList.remove('hidden');
      loginFormContainer.classList.add('hidden');
      document.getElementById('waiting-screen').classList.add('hidden');
      mainAppContainer.classList.add('hidden');

      // Welcome -> Login
      proceedToLoginBtn.addEventListener('click', () => {
        welcomeScreen.classList.add('hidden');
        loginFormContainer.classList.remove('hidden');
      });

      // Login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();

        if (username === 'admin' && password === 'admin') {
          userRole = 'admin';
          await signInAnonymously(auth).catch(()=>{});
          loginFormContainer.classList.add('hidden');
          mainAppContainer.classList.remove('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          loadLoginRequests(); loadUsers();
          return;
        }

        try {
          const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
          const q = query(usersRef, where("username", "==", username));
          const userSnapshot = await getDocs(q);
          if (userSnapshot.empty) {
            loginFormContainer.classList.add('hidden');
            submitLoginRequest(username);
          } else {
            const userData = userSnapshot.docs[0].data();
            if(userData.status === 'active'){
              await signInAnonymously(auth).catch(()=>{});
              loginFormContainer.classList.add('hidden');
              mainAppContainer.classList.remove('hidden');
            } else if (userData.status === 'suspended'){
              showMessageModal(translations[currentLanguage]['accountSuspended']);
              loginFormContainer.classList.remove('hidden');
            } else {
              showMessageModal(translations[currentLanguage]['unknownAccountStatus']);
              loginFormContainer.classList.remove('hidden');
            }
          }
        } catch (err) {
          console.error("Login flow error:", err);
          showMessageModal(translations[currentLanguage]['loginFlowError']);
          loginFormContainer.classList.remove('hidden');
        }
      });

      // Language buttons
      document.getElementById('lang-ar').addEventListener('click', () => {
        updateLanguage('ar'); localStorage.setItem('appLang', 'ar');
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      });
      document.getElementById('lang-en').addEventListener('click', () => {
        updateLanguage('en'); localStorage.setItem('appLang', 'en');
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      });

      // Provider toggle: show/hide OpenAI key
      const providerSelect = document.getElementById('provider-select');
      const openaiKeyInput = document.getElementById('openai-api-key-input');
      const openaiLabel = document.querySelector('label[for="openai-api-key-input"]');
      const openaiNote = document.querySelector('[data-lang-key="openaiNote"]');
      const setOpenAIVisibility = () => {
        const isOpenAI = providerSelect.value === 'openai';
        openaiKeyInput.parentElement.classList.toggle('hidden', !isOpenAI);
        openaiLabel?.classList.toggle('hidden', !isOpenAI);
        openaiNote?.classList.toggle('hidden', !isOpenAI);
      };
      setOpenAIVisibility();
      providerSelect.addEventListener('change', setOpenAIVisibility);

      // Analysis buttons
      document.getElementById('analyze-btn').addEventListener('click', () => handleAnalysis('technical'));
      document.getElementById('fundamental-btn').addEventListener('click', () => handleAnalysis('fundamental'));
      document.getElementById('direct-trade-btn').addEventListener('click', () => handleAnalysis('direct'));
      document.getElementById('high-conviction-trade-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.remove('hidden');
      });
      document.getElementById('confirm-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
        handleAnalysis('high-conviction');
      });
      document.getElementById('cancel-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
      });
      document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('message-modal').classList.add('hidden');
      });

      // Analysis image upload
      document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('image-upload').click());
      document.getElementById('image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentImagesData.push(...newImageData);
          renderImagePreviews();
        }
      });

      // Save (disabled)
      document.getElementById('save-btn').addEventListener('click', () => {
        const query = document.getElementById('input-query').value.trim();
        const analysis = document.getElementById('output-text').innerText;
        if(query && analysis){
          showMessageModal("ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±");
        } else {
          showMessageModal(translations[currentLanguage]['noAnalysisToSave']);
        }
      });

      document.getElementById('confirm-delete-btn').addEventListener('click', () => { deleteUser(userToDeleteId); hideConfirmDeleteModal(); });
      document.getElementById('cancel-delete-btn').addEventListener('click', hideConfirmDeleteModal);

      // Chat events
      document.getElementById('chat-upload-btn').addEventListener('click', () => document.getElementById('chat-image-upload').click());
      document.getElementById('chat-image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentChatImagesData.push(...newImageData);
          renderChatImagePreviews();
        }
      });
      document.getElementById('chat-clear-btn').addEventListener('click', () => {
        chatHistory.length = 0;
        renderChatMessages();
        currentChatImagesData.length = 0;
        renderChatImagePreviews();
      });
      document.getElementById('chat-send-btn').addEventListener('click', handleChatSend);
    });

    // ===== Analysis handler =====
    const handleAnalysis = async (analysisType) => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const queryText = document.getElementById('input-query').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const outputText = document.getElementById('output-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const mainAppContainer = document.getElementById('main-app-container');

      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }
      if (!queryText && currentImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }

      loadingSpinner.classList.remove('hidden');
      outputText.innerHTML = '';
      mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade');
      mainAppContainer.classList.add('bg-default');

      let systemPrompt = '';
      let fullQuery = '';

      if (analysisType === 'high-conviction') {
        systemPrompt = translations[currentLanguage]['highConvictionSystemPrompt']
                        .replace('${tradingStyle}', tradingStyle)
                      + (currentLanguage === 'ar'
                          ? ` Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠ: "${school}".`
                          : ` Methodological focus: "${school}".`);
      } else if (currentLanguage === 'ar') {
        systemPrompt = `Ø£Ù†Øª "JO AI"ØŒ Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø£Ø³ÙˆØ§Ù‚ Ù…Ø§Ù„ÙŠØ© Ù…ØªÙ…Ø±Ø³. ØªØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ø­ØªØ±Ø§Ù ÙˆØ«Ù‚Ø©. Ù‚Ø¯Ù‘Ù… ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙˆØ¬Ø²Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°. Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ¯Ø§ÙˆÙ„: "${tradingStyle}". Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©: "${school}".`;
      } else {
        systemPrompt = `You are "JO AI", a seasoned market analyst. Provide accurate, concise, actionable analyses. Trading style: "${tradingStyle}". Analytical school: "${school}".`;
      }

      if (currentLanguage === 'ar') {
        switch (analysisType) {
          case 'technical':
            fullQuery = `Ø¨ØµÙØªÙƒ Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ÙˆÙÙ‚ Ù…Ø¯Ø±Ø³Ø© "${school}", Ù‚Ø¯Ù‘Ù… ØªØ­Ù„ÙŠÙ„Ù‹Ø§ ÙÙ†ÙŠÙ‹Ø§ Ù„Ù€ "${queryText}" Ù…ØªÙˆØ§ÙÙ‚Ù‹Ø§ Ù…Ø¹ Ø£Ø³Ù„ÙˆØ¨ "${tradingStyle}". Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø³Ø¹Ø±ÙŠØ©ØŒ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©ØŒ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø·Ù„Ø¨/Ø§Ù„Ø¹Ø±Ø¶ØŒ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©ØŒ ÙˆØ§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¥Ù† Ù„Ø²Ù….`;
            break;
          case 'fundamental':
            fullQuery = `Ù‚Ø¯Ù‘Ù… ØªØ­Ù„ÙŠÙ„Ù‹Ø§ Ø£Ø³Ø§Ø³ÙŠÙ‹Ø§ Ù„Ù€ "${queryText}" Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ÙƒÙ„ÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©. Ø¥Ù† ÙˆÙØ¬Ø¯ ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ù…Ø¯Ø±Ø³Ø© "${school}" ÙØ§Ø°ÙƒØ± ÙƒÙŠÙ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙÙƒÙ…Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙÙ†ÙŠØ©. Ø§Ù„Ø£Ø³Ù„ÙˆØ¨: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `Ù‚Ø¯Ù‘Ù… ØªÙˆØµÙŠØ© ØªØ¯Ø§ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø´Ø±Ø§Ø¡/Ø¨ÙŠØ¹/Ø§Ù†ØªØ¸Ø§Ø±) Ù„Ù€ "${queryText}" Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ ÙˆÙˆÙ‚Ù Ø®Ø³Ø§Ø±Ø© Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙˆØ±Ø§Ø¹Ù Ù…Ù†Ù‡Ø¬ "${school}" ÙˆØ£Ø³Ù„ÙˆØ¨ "${tradingStyle}". Ø¶Ø¹ Ø§Ù„ØªÙˆØµÙŠØ© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø¯.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù†Ù‡Ø¬ "${school}" Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚Ø±Ø§Ø±.`;
            break;
        }
      } else {
        switch (analysisType) {
          case 'technical':
            fullQuery = `As a technical analyst using the "${school}" methodology, provide a technical analysis for "${queryText}" aligned with "${tradingStyle}". Emphasize structure, liquidity, supply/demand zones, S/R, and time metrics if applicable.`;
            break;
          case 'fundamental':
            fullQuery = `Provide a fundamental analysis for "${queryText}". If applicable, mention how the "${school}" approach complements the technical picture. Style: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `Provide a direct trade recommendation (buy/sell/hold) for "${queryText}" with specific entries/exits/stop-loss, aligned with the "${school}" methodology and "${tradingStyle}" style. Put the recommendation at the top.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} Leverage "${school}" to refine decision levels.`;
            break;
        }
      }

      if (currentImagesData.length > 0) {
        if (!queryText) {
          fullQuery = translations[currentLanguage]['imageAnalysisQuery'] + (currentLanguage === 'ar' ? ` ÙˆØ·Ø¨Ù‘Ù‚ Ù…Ø¨Ø§Ø¯Ø¦ "${school}".` : ` and apply "${school}" principles.`);
        } else {
          const suffixKey = currentImagesData.length === 1 ? 'imageReferenceSuffixSingle' : 'imageReferenceSuffixMultiple';
          fullQuery += ` ${translations[currentLanguage][suffixKey]}`;
        }
      }

      const imagesBase64 = currentImagesData.map(d => d.base64);
      const result = await getProviderUnifiedResponse({
        provider: provider,
        systemPrompt: systemPrompt,
        userQuery: fullQuery,
        geminiKey: geminiKey,
        openaiKey: openaiKey,
        imagesBase64
      });

      loadingSpinner.classList.add('hidden');
      document.getElementById('output-text').innerHTML = formatMarkdown(result);

      if (result.includes(translations[currentLanguage]['buyKeyword'])) {
        mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-green-trade');
      } else if (result.includes(translations[currentLanguage]['sellKeyword'])) {
        mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-red-trade');
      } else {
        mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade'); mainAppContainer.classList.add('bg-default');
      }
    };

    // ===== Chat logic =====
    const chatHistory = []; // { role: 'user'|'assistant', text: string, imagesBase64?: [] }

    const renderChatMessages = () => {
      const box = document.getElementById('chat-messages');
      box.innerHTML = '';
      chatHistory.forEach(msg => {
        const row = document.createElement('div');
        row.className = `chat-row ${msg.role}`;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant'}`;
        bubble.innerHTML = formatMarkdown(msg.text || '');
        row.appendChild(bubble);
        // show thumbs if exist
        if (msg.imagesBase64?.length) {
          const thumbs = document.createElement('div');
          thumbs.className = 'mt-2 flex gap-2';
          msg.imagesBase64.forEach(b64 => {
            const img = document.createElement('img');
            img.src = `data:image/jpeg;base64,${b64}`;
            img.className = 'chat-image-thumb';
            thumbs.appendChild(img);
          });
          row.appendChild(thumbs);
        }
        box.appendChild(row);
      });
      box.scrollTop = box.scrollHeight;
    };

    const handleChatSend = async () => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const chatInput = document.getElementById('chat-input');
      const text = chatInput.value.trim();
      const chatLoading = document.getElementById('chat-loading');

      if (!text && currentChatImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }
      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }

      const systemPrompt = translations[currentLanguage]['chatSystemPrompt']
                            .replace('${tradingStyle}', tradingStyle)
                            .replace('${school}', school);

      // Push user message
      const imagesBase64 = currentChatImagesData.map(d => d.base64);
      chatHistory.push({ role: 'user', text, imagesBase64 });
      renderChatMessages();

      // Clear input and previews
      chatInput.value = '';
      currentChatImagesData.length = 0;
      renderChatImagePreviews();

      chatLoading.classList.remove('hidden');

      let assistantReply = '';
      if (provider === 'openai') {
        // Build OpenAI messages with multimodal last turn
        const messages = [{ role: 'system', content: systemPrompt }];
        for (const msg of chatHistory) {
          if (msg.role === 'assistant') {
            messages.push({ role: 'assistant', content: msg.text });
          } else {
            if (msg.imagesBase64?.length) {
              const content = [{ type: 'text', text: msg.text }];
              msg.imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}));
              messages.push({ role: 'user', content });
            } else {
              messages.push({ role: 'user', content: msg.text });
            }
          }
        }
        assistantReply = await getOpenAIChatResponse(systemPrompt, messages, openaiKey);
      } else {
        // Gemini multi-turn
        assistantReply = await getGeminiChatResponse(systemPrompt, chatHistory, geminiKey);
      }

      chatLoading.classList.add('hidden');
      chatHistory.push({ role: 'assistant', text: assistantReply });
      renderChatMessages();
    };

    // ===== Expose some to window if needed (debug) =====
    window._JOAI = { chatHistory };

  </script>
</body>
</html>
