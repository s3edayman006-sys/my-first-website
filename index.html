<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-lang-key="pageTitle">JO AI</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- Performance preconnect/dns-prefetch -->
  <link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin/>
  <link rel="dns-prefetch" href="https://generativelanguage.googleapis.com"/>
  <link rel="preconnect" href="https://api.openai.com" crossorigin/>
  <link rel="dns-prefetch" href="https://api.openai.com"/>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin/>
  <link rel="dns-prefetch" href="https://www.gstatic.com"/>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0c1521; }

    /* Containers + Shadows */
    .container { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    #main-app-container.container { background-color: initial; }
    .glowing-shadow { box-shadow: 0 0 15px rgba(255,255,255,0.1), 0 0 30px rgba(74,222,128,0.2), 0 0 45px rgba(74,222,128,0.1); }

    /* Panels */
    .control-panel { background: linear-gradient(135deg, #1A2033 0%, #171E2D 100%); border: 1px solid #334155; }
    .chat-panel { background: linear-gradient(135deg, #121a29 0%, #0f1522 100%); border: 1px solid #334155; }

    /* Buttons */
    .button-style {
      background: linear-gradient(145deg, #0f172a 0%, #0c1521 100%); color: white;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden;
      border: 1px solid #4ade80; box-shadow: 0 0 10px #4ade8050;
    }
    .button-style:hover { background: linear-gradient(145deg, #1c2742 0%, #151d2e 100%); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
    .button-style:active { transform: translateY(1px); }
    .button-style::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 300%; height: 300%;
      background-color: rgba(255,255,255,0.15); transition: all 0.6s ease-in-out; border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
    }
    .button-style:hover::before { transform: translate(-50%, -50%) scale(1); }
    .glowing-shadow-green { box-shadow: 0 0 15px rgba(74, 222, 128, 0.2), 0 0 30px rgba(74, 222, 128, 0.1), 0 0 60px rgba(74, 222, 128, 0.05); }
    .glowing-shadow-green:hover { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4), 0 0 40px rgba(74, 222, 128, 0.2), 0 0 60px rgba(74, 222, 128, 0.1); }
        /* Chat */
    .chat-messages { max-height: 420px; overflow-y: auto; padding: 0.75rem; }
    .chat-bubble { display: inline-block; padding: 0.6rem 0.8rem; border-radius: 0.75rem; line-height: 1.4; font-size: 0.95rem; border: 1px solid #303b50; }
    .chat-bubble-user { background: #0b1220; color: #e5e7eb; }
    .chat-bubble-assistant { background: #122033; color: #d1d5db; }
    .chat-row { margin: 0.4rem 0; }
    .chat-row.user { text-align: end; }
    .chat-row.assistant { text-align: start; }
    .chat-image-thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #374151; }

    /* Status bar */
    .status-bar { background: linear-gradient(135deg, #0f1626 0%, #0d1524 100%); border: 1px solid #334155; }
    .status-pill { border: 1px solid #334155; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    .loading-animation { border-top-color: #4ade80; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* AI Power badge */
    .ai-badge { border: 1px solid rgba(168,85,247,0.35); background: linear-gradient(135deg,#1b1430 0%,#141126 100%); box-shadow: 0 0 12px rgba(168,85,247,0.15); }
    .ai-badge-strong { border-color: rgba(168,85,247,0.6); box-shadow: 0 0 18px rgba(168,85,247,0.25); }

    /* Grid layout */
    .app-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 1024px) { .app-grid { grid-template-columns: 1fr 1.4fr; gap: 1.25rem; } }
        /* Progress bar for image compression */
    .compress-progress { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: #374151; border-radius: 0 0 0.5rem 0.5rem; overflow: hidden; }
    .compress-progress-bar { height: 100%; background: linear-gradient(90deg, #4ade80, #3b82f6); transition: width 0.3s ease; }

    /* Extra: image previews + remove button */
    .image-preview-thumbnail { width: 72px; height: 72px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #374151; }
    .remove-image-btn {
      position: absolute; top: -8px; right: -8px; width: 22px; height: 22px;
      border-radius: 9999px; background: #ef4444; color: #fff; border: 1px solid #7f1d1d;
      display: grid; place-items: center; font-weight: 700; line-height: 1; cursor: pointer;
    }
    .remove-image-btn:hover { background: #dc2626; }

    /* Analysis result background states */
    .bg-default { background: transparent; }
    .bg-green-trade { background: linear-gradient(135deg, #102016 0%, #0c1521 100%); box-shadow: inset 0 0 24px rgba(16,185,129,0.25), 0 0 22px rgba(16,185,129,0.25); }
    .bg-red-trade { background: linear-gradient(135deg, #1f0f12 0%, #0c1521 100%); box-shadow: inset 0 0 24px rgba(239,68,68,0.25), 0 0 22px rgba(239,68,68,0.25); }

    /* Prose fallback (if typography plugin not present) */
    .prose { line-height: 1.65; }
    .prose-invert { color: #d1d5db; }
    .prose strong { color: #e5e7eb; }
    .prose em { color: #cbd5e1; }

    /* Brand buttons hover polish */
    .brand-ig, .brand-wa { background: rgba(17,24,39,0.6); border: 1px solid #334155; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .brand-ig:hover, .brand-wa:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
  </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center justify-center text-white">
  <!-- ุชุจุฏูู ุงููุบุฉ -->
  <div class="fixed top-4 right-4 z-50 flex gap-2">
    <button id="lang-ar" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">ุงูุนุฑุจูุฉ</button>
    <button id="lang-en" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">English</button>
  </div>
    <!-- ุงูุดุงุดุฉ ุงูุชุฑุญูุจูุฉ -->
  <div id="welcome-screen" class="min-h-screen w-full flex flex-col items-center justify-center p-4 text-white bg-gradient-to-br from-[#0c1521] to-[#1a2033] via-[#10192a]">
    <div class="container max-w-4xl p-8 rounded-3xl glowing-shadow text-center md:text-right relative overflow-hidden">
      <div class="relative z-10">
        <h1 class="text-4xl lg:text-5xl font-extrabold mb-8 text-green-400">JO AI <span class="text-gray-200" data-lang-key="featuresTitle">Features</span></h1>
                <!-- AI Power Feature cards -->
        <div class="ai-badge ai-badge-strong mb-6 rounded-2xl p-4 text-right">
          <div class="flex items-center gap-3">
            <span class="text-purple-400 text-2xl">โก</span>
            <div>
              <p class="text-lg font-bold text-purple-300" data-lang-key="aiPowerTitle">ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Ultra AI (ููุฒุฉ)</p>
              <p class="text-sm text-gray-300 mt-1" data-lang-key="aiPowerDesc">ูุถุน ูุงุฆู ูุฌูุน ุชููุงุฆููุง ุจูู Gemini ูOpenAI ููุทุจูู ุชูููุญูุง ุฐุงุชููุง ูุจู ุงูุฅุฎุฑุงุฌุ ูุชุญุณูู ุงูุฏูุฉ ูุงููุถูุญ. ููุนูู ุฏุงุฆููุง โ ููุณ ุฒุฑูุง.</p>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-3" data-lang-key="aiPowerHint">ุชูุจูู: ุงูุฃุฏุงุก ุนุงูู ููู ูุง ููุฌุฏ ุถูุงูุงุช ูููุชุงุฆุฌุ ููุฐู ููุณุช ูุตูุญุฉ ูุงููุฉ.</p>
        </div>

        <div class="ai-badge mb-6 rounded-2xl p-4 text-right">
          <div class="flex items-center gap-3">
            <span class="text-purple-400 text-2xl">๐</span>
            <div>
              <p class="text-lg font-bold text-purple-300" data-lang-key="aiProTitle">ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Ultra AI Pro (ููุฒุฉ)</p>
              <p class="text-sm text-gray-300 mt-1" data-lang-key="aiProDesc">ูุณุฎุฉ ุงุญุชุฑุงููุฉ ุชูุญุณูู Ultra AI ุจุชูุฑูุฑ ุชูููุญ ูุฒุฏูุฌ ููุญุต ุงุชุณุงู ูุจู ุงูุฅุฎุฑุงุฌ. ุชููุนูู ุชููุงุฆููุง ุนูุฏ ุชูุนูู ุงูุชูุฑุจู ูุชููุฑ ููุชุงุญู Gemini ูOpenAI.</p>
            </div>
          </div>
        </div>

        <div class="ai-badge mb-6 rounded-2ุต p-4 text-right">
          <div class="flex items-center gap-3">
            <span class="text-purple-400 text-2xl">๐ก๏ธ</span>
            <div>
              <p class="text-lg font-bold text-purple-300" data-lang-key="aiSuperTitle">ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Super Ultra AI (ููุฒุฉ)</p>
              <p class="text-sm text-gray-300 mt-1" data-lang-key="aiSuperDesc">ุฃูุตู ูุถุน: ุฏูุฌ ูุณูุฏุงุช ูุชุนุฏุฏ + ุชุฏููู ููุงุฆู ุตุงุฑู ูุชูููู ุงูุฃุฎุทุงุก ูุตูู ุงูุจููุฉ. ูููุนูู ุชููุงุฆููุง ูุน ูุถุน ุงูุชูุฑุจู ูุฃูุถุงุน ุงูุณุฑุนุฉ ุงูุนุงููุฉ.</p>
            </div>
          </div>
        </div>
                <!-- ูุงุฆูุฉ ุงูููุฒุงุช -->
        <ul class="space-y-4 text-lg md:text-xl text-right">
          <li class="flex items-start md:items-center"><span class="text-yellow-400 text-2xl ml-3">๐</span><span class="font-medium text-gray-300" data-lang-key="feature1">Live Market Insights โ Tracks prices, market cap, FDV, and token holders.</span></li>
          <li class="flex items-start md:items-center"><span class="text-blue-400 text-2xl ml-3">๐</span><span class="font-medium text-gray-300" data-lang-key="feature2">Token Analytics โ Analyzes supply, tokenomics, and unlock schedules.</span></li>
          <li class="flex items-start md:items-center"><span class="text-purple-400 text-2xl ml-3">๐ก</span><span class="font-medium text-gray-300" data-lang-key="feature3">AI-Powered Insights โ Detects trends, sentiment.</span></li>
          <li class="flex items-start md:items-center"><span class="text-green-400 text-2xl ml-3">๐</span><span class="font-medium text-gray-300" data-lang-key="feature4">Technical & Fundamental Analysis โ Evaluates price stability, risks, and entry points.</span></li>
          <li class="flex items-start md:items-center"><span class="text-orange-400 text-2ุต ml-3">๐ผ</span><span class="font-medium text-gray-300" data-lang-key="feature5">Exchange & Liquidity โ Lists exchanges, liquidity scores, and supported wallets.</span></li>
          <li class="flex items-start md:items-center"><span class="text-pink-400 text-2ุต ml-3">๐</span><span class="font-medium text-gray-300" data-lang-key="feature6">Community Tracking โ Monitors Twitter, Telegram, and Discord engagement.</span></li>
          <li class="flex items-start md:items-center"><span class="text-red-400 text-2ุต ml-3">๐</span><span class="font-medium text-gray-300" data-lang-key="feature7">Security & Audit Reports โ Highlights security scores and past audits.</span></li>
        </ul>
                <!-- ุชูุงุตู ูุน ุงููุณุคูู -->
        <div class="mt-10 border-t border-gray-700 pt-6">
          <h2 class="text-xl font-bold text-green-400 mb-2" data-lang-key="contactAdminTitle">ุชูุงุตู ูุน ุงููุณุคูู</h2>
          <p class="text-gray-300 text-sm mb-4" data-lang-key="contactAdminDesc">ุจุญุงุฌุฉ ููุณุงุนุฏุฉ ุฃู ููุงููุฉ ุฃุณุฑุนุ ุชูุงุตู ุนุจุฑ:</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <a href="https://instagram.com/_sn8d" target="_blank" rel="noopener noreferrer" class="p-3 rounded-lg font-semibold flex items-center justify-center gap-2 brand-ig">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#E1306C" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M7 2C4.24 2 2 4.24 2 7v10c0 2.76 2.24 5 5 5h10c2.76 0 5-2.24 5-5V7c0-2.76-2.24-5-5-5H7zm10 2c1.66 0 3 1.34 3 3v10c0 1.66-1.34 3-3 3H7c-1.66 0-3-1.34-3-3V7c0-1.66 1.34-3 3-3h10zm-5 3.5A5.5 5.5 0 1 0 17.5 13 5.507 5.507 0 0 0 12 7.5zm0 2A3.5 3.5 0 1 1 8.5 13 3.5 3.5 0 0 1 12 9.5zM18 6.3a1 1 0 1 0 1 1 1.001 1.001 0 0 0-1-1z"/>
              </svg>
              <span data-lang-key="instagramLabel">ุฅูุณุชุบุฑุงู</span>
              <span class="text-gray-300" dir="ltr">_sn8d</span>
            </a>

            <a href="https://wa.me/962782643348" target="_blank" rel="noopener noreferrer" class="p-3 rounded-lg font-semibold flex items-center justify-center gap-2 brand-wa">
              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path fill="#25D366" d="M20.52 3.48A11.77 11.77 0 0 0 12.01 0C5.4 0 .03 5.37.03 11.98c0 2.11.55 4.17 1.6 5.99L0 24l6.2-1.6a11.94 11.94 0 0 0 5.8 1.48h.01c6.61 0 11.98-5.37 11.98-11.98a11.94 11.94 0 0 0-3.47-8.42zM12 21.5h-.01a9.53 9.53 0 0 1-4.86-1.31l-.35-.2-3.68.95.98-3.58-.23-.37A9.5 9.5 0 1 1 21.5 12a9.48 9.48 0 0 1-2.78 6.76A9.45 9.45 0 0 1 12 21.5zm4.01-10.1c-.27-.14-1.62-.8-1.87-.89-.25-.09-.44-.14-.62.13-.18.27-.71.89-.87 1.07-.16.18-.32.21-.6.07-.27-.13-1.15-.42-2.19-1.35-.81-.72-1.36-1.61-1.52-1.88-.16-.27-.02-.42.12-.56.13-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.62-1.49-.85-2.04-.22-.54-.45-.47-.62-.48l-.53-.01c-.18 0-.48.07-.73.34-.25.27-.96.94-.96 2.29 0 1.34.99 2.66 1.13 2.84.14.19 1.94 2.97 4.71 4.16.66.28 1.17.45 1.57.58.66.21 1.26.18 1.73.11.53-.08 1.62-.66 1.85-1.3.23-.64.23-1.18.16-1.3-.07-.12-.25-.19-.52-.33z"/>
              </svg>
              <span data-lang-key="whatsappLabel">ูุงุชุณุงุจ</span>
              <span class="text-gray-300" dir="ltr">+962782643348</span>
            </a>
          </div>
        </div>

        <button id="proceed-to-login-btn" class="button-style mt-12 px-8 py-4 text-xl rounded-full font-bold glowing-shadow-green" data-lang-key="loginButton">ุชุณุฌูู ุงูุฏุฎูู</button>
      </div>
    </div>
  </div>
    <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="login-form-container" class="hidden w-full max-w-sm">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2" data-lang-key="loginToJOUAI">ุชุณุฌูู ุงูุฏุฎูู ุฅูู JO AI</h1>
      </div>

      <form id="login-form" class="space-y-6">
        <div>
          <label for="username-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="usernameLabel">ุงุณู ุงููุณุชุฎุฏู:</label>
          <input type="text" id="username-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <div>
          <label for="password-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="passwordLabel">ูููุฉ ุงููุฑูุฑ:</label>
          <input type="password" id="password-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <button type="submit" class="w-full p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="loginSubmit">ุชุณุฌูู ุงูุฏุฎูู</button>
      </form>
    </div>
  </div>
    <!-- ุดุงุดุฉ ุงูุชุธุงุฑ ุงูููุงููุฉ -->
  <div id="waiting-screen" class="hidden w-full max-w-sm text-center">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="waitingForApprovalTitle">ูู ุงูุชุธุงุฑ ุงูููุงููุฉ</h2>
      <p class="text-gray-400" data-lang-key="waitingForApprovalText">ุชู ุฅุฑุณุงู ุทูุจ ุงูุฏุฎูู ุงูุฎุงุต ุจู. ูุฑุฌู ุงูุงูุชุธุงุฑ ุญุชู ุชุชู ุงูููุงููุฉ ุนููู ูู ูุจู ุงููุณุคูู.</p>
      <div class="mt-6"><div class="loading-animation w-12 h-12 border-4 rounded-full mx-auto"></div></div>
    </div>
  </div>
    <!-- ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ -->
  <div id="main-app-container" class="container w-full max-w-6xl p-6 md:p-8 rounded-3xl glowing-shadow hidden bg-default">
    <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-white mb-2">JO AI</h1>
      <p class="text-gray-400" data-lang-key="mainAppSubtitle">ุฃุฏุงุฉ ุชุญููู ุงูุณูู ุงููุฏุนููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</p>
      <p id="user-id-display" class="text-xs text-gray-500 mt-2" data-lang-key="idPrefix">ุงููุนุฑู: </p>
    </div>

    <!-- ุดุฑูุท ุงูุญุงูุฉ -->
    <div class="status-bar p-4 rounded-2xl mb-6 flex flex-col md:flex-row gap-4 items-start md:items-center">
      <div class="flex items-center gap-2">
        <span class="status-pill text-gray-300" id="status-badge">Idle</span>
        <span class="text-xs text-gray-400" id="status-warmup"></span>
        <span id="ai-power-pill" class="status-pill text-purple-300 border-purple-500/40 bg-purple-900/20 ml-2">โก <span id="ai-power-label">Ultra AI</span> โข <span data-lang-key="aiAlwaysOn">ููุนูู ุฏุงุฆููุง</span></span>
      </div>
      <div class="flex-1 grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
        <div class="bg-gray-900/40 border border-gray-700 rounded-lg p-2">
          <div class="text-gray-400" data-lang-key="latencyLabel">ุงูุฒูู</div>
          <div class="text-green-300 font-semibold" id="status-latency">โ</div>
        </div>
        <div class="bg-gray-900/40 border border-gray-700 rounded-lg p-2">
          <div class="text-gray-400" data-lang-key="avgLatencyLabel">ุงููุชูุณุท</div>
          <div class="text-green-300 font-semibold" id="status-avg-latency">โ</div>
        </div>
        <div class="bg-gray-900/40 border border-gray-700 rounded-lg p-2">
          <div class="text-gray-400" data-lang-key="analysisQueueLabel">ุทุงุจูุฑ ุงูุชุญููู</div>
          <div class="text-blue-300 font-semibold" id="status-queue-analysis">0</div>
        </div>
        <div class="bg-gray-900/40 border border-gray-700 rounded-lg p-2">
          <div class="text-gray-400" data-lang-key="chatQueueLabel">ุทุงุจูุฑ ุงูุดุงุช</div>
          <div class="text-blue-300 font-semibold" id="status-queue-chat">0</div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="cancel-analysis-btn" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md" data-lang-key="cancelAnalysis">ุฅูุบุงุก ุงูุชุญููู</button>
          <button id="cancel-chat-btn" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md" data-lang-key="cancelChat">ุฅูุบุงุก ุงูุดุงุช</button>
        </div>
      </div>
    </div>
        <!-- ุดุจูุฉ ุงูุชุทุจูู -->
    <div class="app-grid">
      <!-- ููุญุฉ ุงูุชุญูู -->
      <div class="control-panel p-6 rounded-3xl space-y-6">
        <section class="space-y-4">
          <h3 class="text-lg font-bold text-green-400">1) <span data-lang-key="providerLabel">ููููุฑ ุงููููุฐุฌ:</span> & <span data-lang-key="apiKeyLabel">ููุชุงุญ API:</span></h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="provider-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="providerLabel">ููููุฑ ุงููููุฐุฌ:</label>
              <select id="provider-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
                <option value="gemini" selected data-lang-key="providerGemini">Google Gemini</option>
                <option value="openai" data-lang-key="providerOpenAI">OpenAI (ChatGPT)</option>
              </select>
            </div>
            <div>
              <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="apiKeyLabel">ููุชุงุญ API:</label>
              <input type="text" id="api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="ุฃุฏุฎู ููุชุงุญ API ุงูุฎุงุต ุจู ูู Google AI Studio" data-lang-key="apiKeyPlaceholder" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="openai-api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="openaiApiKeyLabel">ููุชุงุญ OpenAI:</label>
              <input type="password" id="openai-api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="ุฃุฏุฎู ููุชุงุญ OpenAI (ุงุฎุชูุงุฑู)" />
              <p class="text-xs text-gray-500" data-lang-key="openaiNote">ูู ูุธูุฑ ูุฐุง ุงูุญูู ุฅูุง ุนูุฏ ุงุฎุชูุงุฑ OpenAI.</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="performanceLabel">ุงูุฃุฏุงุก:</label>
              <div class="flex flex-col gap-2">
                <label class="inline-flex items-center gap-2 text-sm text-gray-300">
                  <input id="fast-mode-toggle" type="checkbox" class="accent-green-500" checked>
                  <span data-lang-key="fastModeLabel">ุชุณุฑูุน ุงูุงุณุชุฌุงุจุฉ</span>
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-300">
                  <input id="highload-mode-toggle" type="checkbox" class="accent-green-500" checked>
                  <span data-lang-key="highLoadLabel">ุชุญููู ุงูุถุบุท ุงูุนุงูู</span>
                </label>
                <!-- ูุถุน ุงูุชูุฑุจู -->
                <label class="inline-flex items-center gap-2 text-sm text-gray-300">
                  <input id="turbo-mode-toggle" type="checkbox" class="accent-green-500">
                  <span data-lang-key="turboModeLabel">ูุถุน ุชูุฑุจู (ุฃูุตู ุณุฑุนุฉ)</span>
                </label>
                <p class="text-xs text-gray-500" data-lang-key="performanceHint">ูููู ูุฐุง ุจุชุญุณูู ุฒูู ุงูุงุณุชุฌุงุจุฉุ ุฅุฏุงุฑุฉ ุงูุทูุงุจูุฑุ ูุงููFallback ุงูุชููุงุฆู ุนูุฏ ุงูุถุบุท.</p>
              </div>
            </div>
          </div>
        </section>
                <section class="space-y-4">
          <h3 class="text-lg font-bold text-green-400">2) <span data-lang-key="strategyTitle">ุงูุงุณุชุฑุงุชูุฌูุฉ</span></h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="trading-style-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="tradingStyleLabel">ุทุฑููุฉ ุงููุนุจ:</label>
              <select id="trading-style-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
                <option value="ุณูุงูุจููุฌ" data-lang-key="scalpingOption">ุณูุงูุจููุฌ (Scalping)</option>
                <option value="ุณูููุบ" selected data-lang-key="swingOption">ุณูููุบ (Swing)</option>
                <option value="ุงุณุชุซูุงุฑ" data-lang-key="investmentOption">ุงุณุชุซูุงุฑ (Investment)</option>
              </select>
            </div>
            <div>
              <label for="school-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="schoolLabel">ุงููุฏุฑุณุฉ ุงูุชุญููููุฉ:</label>
              <select id="school-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
                <option value="ICT" selected data-lang-key="schoolICT">ูุฏุฑุณุฉ ICT</option>
                <option value="SMC" data-lang-key="schoolSMC">ูุฏุฑุณุฉ SMC</option>
                <option value="ุงูุฒูููุฉ" data-lang-key="schoolTime">ุงููุฏุฑุณุฉ ุงูุฒูููุฉ</option>
                <option value="ุงูููุฌูุฉ (ุฅูููุช)" data-lang-key="schoolElliott">ุงููุฏุฑุณุฉ ุงูููุฌูุฉ (ุฅูููุช)</option>
              </select>
            </div>
          </div>
        </section>

        <section class="space-y-4">
          <h3 class="text-lg font-bold text-green-400">3) <span data-lang-key="inputSectionTitle">ุงูุฅุฏุฎุงู ูุงูุตูุฑ</span></h3>
          <div>
            <textarea id="input-query" rows="4" class="w-full p-4 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="ุงุณุฃููู ุนู ุงูุณูู... ุฃู ุดูุก. ุฃูุง ุฃุนุฑู ุงูุฅุฌุงุจุฉ." data-lang-key="inputQueryPlaceholder"></textarea>
          </div>
          <div>
            <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
            <div class="flex justify-start">
              <button id="upload-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="uploadImageBtn">ุชุญููู ุตูุฑ</button>
            </div>
            <div id="image-preview-container" class="hidden mt-4 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
              <div id="image-previews-wrapper" class="flex flex-wrap gap-4"></div>
            </div>
          </div>
        </section>
                <section class="space-y-3">
          <h3 class="text-lg font-bold text-green-400">4) <span data-lang-key="actionsTitle">ุงูุฃูุงูุฑ ุงูุณุฑูุนุฉ</span></h3>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <button id="analyze-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="technicalAnalysisBtn">ุชุญููู ููู</button>
            <button id="fundamental-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="fundamentalAnalysisBtn">ุชุญููู ุฃุณุงุณู</button>
            <button id="direct-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="directTradeBtn">ุชูุตูุฉ ุชุฏุงูู</button>
            <button id="high-conviction-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="highConvictionBtn">ุชูุตูุฉ ุฐุงุช ููุงุนุฉ ุนุงููุฉ</button>
          </div>
        </section>
      </div>
            <!-- ูููู: ุงููุฎุฑุฌุงุช + ุงูุดุงุช -->
      <div class="space-y-6">
        <section id="output-section" class="relative bg-gray-800 rounded-lg p-4 min-h-[200px] border border-gray-700 shadow-inner">
          <div id="loading-spinner" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
            <div class="loading-animation w-12 h-12 border-4 rounded-full"></div>
          </div>
          <div id="output-text" class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed"></div>
          <div class="flex justify-end mt-4">
            <button id="save-btn" class="hidden px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold text-sm rounded-lg transition-all duration-300 transform hover:scale-105" data-lang-key="saveButton">ุญูุธ</button>
          </div>
        </section>

        <section id="chat-panel" class="chat-panel p-6 rounded-3xl">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-2xl font-bold text-white" data-lang-key="chatTitle">ุดุงุช GPT ูุชูุฏูู</h2>
            <div class="flex items-center gap-2 text-xs text-gray-400">
              <span class="hidden md:inline" data-lang-key="chatHint">ูุฏุนู ุงูุณูุงู ูุงูุตูุฑ โข ุงุฎุชุฑ ุงููุฒููุฏ ูู ุงูุฃุนูู</span>
            </div>
          </div>

          <div id="chat-messages" class="chat-messages bg-gray-900/40 rounded-lg border border-gray-700"></div>

          <div class="mt-4">
            <textarea id="chat-input" rows="3" class="w-full p-3 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="ุงูุชุจ ุฑุณุงูุชู..." data-lang-key="chatPlaceholder"></textarea>

            <input type="file" id="chat-image-upload" accept="image/*" class="hidden" multiple>
            <div id="chat-image-preview-container" class="hidden mt-3 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
              <div id="chat-image-previews-wrapper" class="flex flex-wrap gap-3"></div>
            </div>

            <div class="flex items-center gap-3 mt-3">
              <button id="chat-upload-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="uploadImageChatBtn">ุฅุฑูุงู ุตูุฑ</button>
              <button id="chat-clear-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="clearChat">ุชูุฑูุบ ุงููุญุงุฏุซุฉ</button>
               <div class="ml-auto flex items-center gap-2">
                 <div id="chat-loading" class="hidden loading-animation w-6 h-6 border-2 rounded-full"></div>
                <button id="chat-send-btn" class="px-6 py-2 button-style rounded-lg font-semibold" data-lang-key="sendButton">ุฅุฑุณุงู</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
        <!-- ููุญุฉ ุชุญูู ุงููุณุคูู -->
    <div id="admin-panel" class="hidden mt-6 p-6 bg-gray-900 rounded-2xl shadow-inner border border-gray-700">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="pendingRequestsTitle">ุทูุจุงุช ุงูุฏุฎูู ุงููุนููุฉ</h2>
      <div id="requests-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="noPendingRequests">ูุง ุชูุฌุฏ ุทูุจุงุช ูุนููุฉ ุญุงูููุง.</p>
      </div>
      <h2 class="text-2xl font-bold text-white mb-4 mt-8" data-lang-key="manageUsersTitle">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h2>
      <div id="users-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="loadingUsers">ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...</p>
      </div>
    </div>
  </div>

  <!-- ููุงูุฐ ููุจุซูุฉ -->
  <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" style="background-color: rgba(12,21,33,0.8); backdrop-filter: blur(4px);">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm" style="background-color:#1f2937; border:1px solid #334155; box-shadow:0 8px 25px rgba(0,0,0,0.4)">
      <div class="text-center">
        <p id="modal-text" class="text-lg text-white mb-4"></p>
        <button id="close-modal-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="okButton">ููุงูู</button>
      </div>
    </div>
  </div>

  <div id="invincible-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" style="background-color: rgba(12,21,33,0.8); backdrop-filter: blur(4px);">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-lg" style="background-color:#1f2937; border:1px solid #334155; box-shadow:0 8px 25px rgba(0,0,0,0.4)">
      <div class="text-center">
        <h3 class="text-2xl font-bold text-green-400 mb-4" data-lang-key="highConvictionModalTitle">ุชูุตูุฉ ุฐุงุช ููุงุนุฉ ุนุงููุฉ</h3>
        <p class="text-gray-300 mb-6" data-lang-key="highConvictionModalText">ุชุญูููุงุชู ูุจููุฉ ุนูู ุจูุงูุงุช ูุง ุญุตุฑ ููุงุ ููุฐู ุงูุชูุตูุฉ ุชุชูุชุน ุจุฃุนูู ููุงุนุฉ ููููุฉ. ููุน ุฐููุ ูุง ููุฌุฏ ุฃู ุถูุงู ูููุฌุงุญ ูู ุงูุณูู. ูู ุฃูุช ุฌุงูุฒ ูููุถู ูุฏูุงูุ</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-invincible-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full transition-transform	duration-200 transform hover:scale-105" data-lang-key="yesImReady">ูุนูุ ุฃูุง ุฌุงูุฒ</button>
          <button id="cancel-invincible-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">ุฅูุบุงุก</button>
        </div>
      </div>
    </div>
  </div>
    <div id="confirm-delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" style="background-color: rgba(12,21,33,0.8); backdrop-filter: blur(4px);">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm" style="background-color:#1f2937; border:1px solid #334155; box-shadow:0 8px 25px rgba(0,0,0,0.4)">
      <div class="text-center">
        <h3 class="text-xl font-bold text-red-400 mb-4" data-lang-key="confirmDeleteTitle">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p id="confirm-delete-text" class="text-lg text-white mb-6" data-lang-key="confirmDeleteText">ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="yesDelete">ูุนู, ุญุฐู</button>
          <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">ุฅูุบุงุก</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ุณูุฑูุจุช ุงูุชุทุจูู -->
  <script type="module">
    // Firebase & Google AI + App logic (with High-Load + Fast Mode + Ultra/Pro/Super Synth)

    // Firebase (CDN) - v12.2.1
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // --- ูุชุบูุฑุงุช ุงูุชุทุจูู ---
    let userId = null;
    let userRole = 'user';
    let currentImagesData = []; // analysis images
    let currentChatImagesData = []; // chat images
    const MAX_RETRIES = 3;
    let userToDeleteId = null;
    const appId = 'default-app-id';
    let currentLanguage = localStorage.getItem('appLang') || 'ar';

    // High-load & fast mode
    let fastModeEnabled = JSON.parse(localStorage.getItem('fastModeEnabled') ?? 'true');
    let highLoadEnabled = JSON.parse(localStorage.getItem('highLoadEnabled') ?? 'true');

    // Ultra AI levels (auto)
    const aiPowerEnabled = true; // ููุฒุฉ ูููุณ ุฒุฑ - ููุนูุฉ ุฏุงุฆููุง
    const AI_POWER_LEVEL = 'auto'; // auto: ultra/ultra-pro/super-ultra based on conditions

    // Abort controllers
    let analysisAbortController = null;
    let chatAbortController = null;

    // Status data
    const latencyHistory = [];
    const MAX_LATENCY_HISTORY = 10;
        // ุชุฑุฌูุงุช
    const translations = {
      'ar': {
        pageTitle: 'JO AI',
        featuresTitle: 'ุงูููุฒุงุช',
        feature1: 'ุฑุคู ุงูุณูู ุงูุญูุฉ โ ุชุชุจุน ุงูุฃุณุนุงุฑุ ุงููููุฉ ุงูุณูููุฉุ FDVุ ูุญุงููู ุงูุฑููุฒ.',
        feature2: 'ุชุญูููุงุช ุงูุฑููุฒ โ ุชุญููู ุงูุนุฑุถุ ุงูุชุตุงุฏูุงุช ุงูุฑููุฒุ ูุฌุฏุงูู ุงููุชุญ.',
        feature3: 'ุฑุคู ูุฏุนููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู โ ุงูุชุดุงู ุงูุงุชุฌุงูุงุชุ ุงููุนูููุงุช.',
        feature4: 'ุชุญููู ููู ูุฃุณุงุณู โ ุชูููู ุงุณุชูุฑุงุฑ ุงูุฃุณุนุงุฑุ ุงููุฎุงุทุฑุ ูููุงุท ุงูุฏุฎูู.',
        feature5: 'ุงูุชุจุงุฏู ูุงูุณูููุฉ โ ุณุฑุฏ ุงูุชุจุงุฏูุงุชุ ุฏุฑุฌุงุช ุงูุณูููุฉุ ูุงููุญุงูุธ ุงููุฏุนููุฉ.',
        feature6: 'ุชุชุจุน ุงููุฌุชูุน โ ูุฑุงูุจุฉ ุงูุชูุงุนู ุนูู ุชููุชุฑุ ุชูุบุฑุงูุ ูุฏูุณููุฑุฏ.',
        feature7: 'ุชูุงุฑูุฑ ุงูุฃูู ูุงูุชุฏููู โ ุชุณููุท ุงูุถูุก ุนูู ุฏุฑุฌุงุช ุงูุฃูุงู ูุงูุชุฏูููุงุช ุงูุณุงุจูุฉ.',
        loginButton: 'ุชุณุฌูู ุงูุฏุฎูู',
        loginToJOUAI: 'ุชุณุฌูู ุงูุฏุฎูู ุฅูู JO AI',
        usernameLabel: 'ุงุณู ุงููุณุชุฎุฏู:',
        passwordLabel: 'ูููุฉ ุงููุฑูุฑ:',
        loginSubmit: 'ุชุณุฌูู ุงูุฏุฎูู',

        contactAdminTitle: 'ุชูุงุตู ูุน ุงููุณุคูู',
        contactAdminDesc: 'ุจุญุงุฌุฉ ููุณุงุนุฏุฉ ุฃู ููุงููุฉ ุฃุณุฑุนุ ุชูุงุตู ุนุจุฑ:',
        instagramLabel: 'ุฅูุณุชุบุฑุงู',
        whatsappLabel: 'ูุงุชุณุงุจ',

        aiPowerTitle: 'ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Ultra AI (ููุฒุฉ)',
        aiPowerDesc: 'ูุถุน ูุงุฆู ูุฌูุน ุชููุงุฆููุง ุจูู Gemini ูOpenAI ููุทุจูู ุชูููุญูุง ุฐุงุชููุง ูุจู ุงูุฅุฎุฑุงุฌุ ูุชุญุณูู ุงูุฏูุฉ ูุงููุถูุญ. ููุนูู ุฏุงุฆููุง โ ููุณ ุฒุฑูุง.',
        aiPowerHint: 'ุชูุจูู: ุงูุฃุฏุงุก ุนุงูู ููู ูุง ููุฌุฏ ุถูุงูุงุช ูููุชุงุฆุฌุ ููุฐู ููุณุช ูุตูุญุฉ ูุงููุฉ.',
        aiUltra: 'Ultra AI',
        aiUltraPro: 'Ultra AI Pro',
        aiSuperUltra: 'Super Ultra AI',
        aiAlwaysOn: 'ููุนูู ุฏุงุฆููุง',

        aiProTitle: 'ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Ultra AI Pro (ููุฒุฉ)',
        aiProDesc: 'ูุณุฎุฉ ุงุญุชุฑุงููุฉ ุชูุญุณูู Ultra AI ุจุชูุฑูุฑ ุชูููุญ ูุฒุฏูุฌ ููุญุต ุงุชุณุงู ูุจู ุงูุฅุฎุฑุงุฌ. ุชููุนูู ุชููุงุฆููุง ุนูุฏ ุชูุนูู ุงูุชูุฑุจู ูุชููุฑ ููุชุงุญู Gemini ูOpenAI.',
        aiSuperTitle: 'ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: Super Ultra AI (ููุฒุฉ)',
        aiSuperDesc: 'ุฃูุตู ูุถุน: ุฏูุฌ ูุณูุฏุงุช ูุชุนุฏุฏ + ุชุฏููู ููุงุฆู ุตุงุฑู ูุชูููู ุงูุฃุฎุทุงุก ูุตูู ุงูุจููุฉ. ูููุนูู ุชููุงุฆููุง ูุน ูุถุน ุงูุชูุฑุจู ูุฃูุถุงุน ุงูุณุฑุนุฉ ุงูุนุงููุฉ.',

        refineSystemPrompt: 'ุฃูุช ูุญุฑูู ุชูููุญ ูุชุญุณูู ููุฅุฌุงุจุงุช ุจุงุณู "JO AI". ูููุชู: ุฏูุฌ ุงููุณูุฏุงุชุ ูุดู ูุชุตุญูุญ ุงูุชูุงูุถุงุช/ุงูุฃุฎุทุงุกุ ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุ ูุฅุฎุฑุงุฌ ุฌูุงุจ ููุงุฆู ููุฌุฒ ููุงุถุญ ูุงุจู ููุชูููุฐ ุนูุฏ ุงูุฅููุงู. ูุง ุชูุธูุฑ ุฎุทูุงุช ุงูุชูููุฑ ููุง ุชุนูููุงุช ุฌุงูุจูุฉ.',
        refineUserPrefix: 'ุงุฏูุฌ ุงููุณูุฏุชูู ุงูุขุชูุชูู ูู ุฌูุงุจ ูุงุญุฏ ููุงุฆู ููุญุณููุ ูุตุญูุญ ุฃู ุฎุทุฃ ุธุงูุฑ. ุฃุนุทูู ุงูุฌูุงุจ ุงูููุงุฆู ููุท ุฏูู ุฅุธูุงุฑ ุงููุณูุฏุงุช ุฃู ุงูุดุฑุญ:',
        verifySystemPrompt: 'ุฃูุช "JO AI" ูุฏูู ููุงุฆู ููุฅุฌุงุจุงุช. ูููุชู: ุงูุชุญูู ูู ุงูุงุชุณุงูุ ุฅุฒุงูุฉ ุงูุญุดูุ ุชุจุณูุท ูุตูุงุบุฉ ูุฎุฑุฌุงุช ูุงุถุญุฉ ูุงุจูุฉ ููุชูููุฐุ ุฏูู ูุดู ุฎุทูุงุช ุงูุชูููุฑ.',
        verifyUserPrefix: 'ุฑุงุฌุน ุงููุณูุฏุฉ ุงูุชุงููุฉ ูุฑุงุฌุนุฉ ููุงุฆูุฉ: ุงุฎุชุตุฑูุงุ ุซุจูุช ุงูุญูุงุฆู ุงูุธุงูุฑุฉุ ูุชุฃูุฏ ูู ูุฌูุฏ ุนูุงููู/ููุงุท ูุงุถุญุฉ. ุฃุนูุฏ ุงููุงุชุฌ ุงูููุงุฆู ููุท:',

        waitingForApprovalTitle: 'ูู ุงูุชุธุงุฑ ุงูููุงููุฉ',
        waitingForApprovalText: 'ุชู ุฅุฑุณุงู ุทูุจ ุงูุฏุฎูู ุงูุฎุงุต ุจู. ูุฑุฌู ุงูุงูุชุธุงุฑ ุญุชู ุชุชู ุงูููุงููุฉ ุนููู ูู ูุจู ุงููุณุคูู.',
        mainAppSubtitle: 'ุฃุฏุงุฉ ุชุญููู ุงูุณูู ุงููุฏุนููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู',
        idPrefix: 'ุงููุนุฑู: ',
        apiKeyLabel: 'ููุชุงุญ API:',
        apiKeyPlaceholder: 'ุฃุฏุฎู ููุชุงุญ API ุงูุฎุงุต ุจู ูู Google AI Studio',
        providerLabel: 'ููููุฑ ุงููููุฐุฌ:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'ููุชุงุญ OpenAI:',
        openaiNote: 'ูู ูุธูุฑ ูุฐุง ุงูุญูู ุฅูุง ุนูุฏ ุงุฎุชูุงุฑ OpenAI.',
        inputQueryPlaceholder: 'ุงุณุฃููู ุนู ุงูุณูู... ุฃู ุดูุก. ุฃูุง ุฃุนุฑู ุงูุฅุฌุงุจุฉ.',
        tradingStyleLabel: 'ุทุฑููุฉ ุงููุนุจ:',
        scalpingOption: 'ุณูุงูุจููุฌ (Scalping)',
        swingOption: 'ุณูููุบ (Swing)',
        investmentOption: 'ุงุณุชุซูุงุฑ (Investment)',
        schoolLabel: 'ุงููุฏุฑุณุฉ ุงูุชุญููููุฉ:',
        schoolICT: 'ูุฏุฑุณุฉ ICT',
        schoolSMC: 'ูุฏุฑุณุฉ SMC',
        schoolTime: 'ุงููุฏุฑุณุฉ ุงูุฒูููุฉ',
        schoolElliott: 'ุงููุฏุฑุณุฉ ุงูููุฌูุฉ (ุฅูููุช)',
        technicalAnalysisBtn: 'ุชุญููู ููู',
        fundamentalAnalysisBtn: 'ุชุญููู ุฃุณุงุณู',
        directTradeBtn: 'ุชูุตูุฉ ุชุฏุงูู',
        highConvictionBtn: 'ุชูุตูุฉ ุฐุงุช ููุงุนุฉ ุนุงููุฉ',
        uploadImageBtn: 'ุชุญููู ุตูุฑ',
        saveButton: 'ุญูุธ',
        pendingRequestsTitle: 'ุทูุจุงุช ุงูุฏุฎูู ุงููุนููุฉ',
        noPendingRequests: 'ูุง ุชูุฌุฏ ุทูุจุงุช ูุนููุฉ ุญุงูููุง.',
        manageUsersTitle: 'ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู',
        loadingUsers: 'ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...',
        okButton: 'ููุงูู',
        highConvictionModalTitle: 'ุชูุตูุฉ ุฐุงุช ููุงุนุฉ ุนุงููุฉ',
        highConvictionModalText: 'ุชุญูููุงุชู ูุจููุฉ ุนูู ุจูุงูุงุช ูุง ุญุตุฑ ููุงุ ููุฐู ุงูุชูุตูุฉ ุชุชูุชุน ุจุฃุนูู ููุงุนุฉ ููููุฉ. ููุน ุฐููุ ูุง ููุฌุฏ ุฃู ุถูุงู ูููุฌุงุญ ูู ุงูุณูู. ูู ุฃูุช ุฌุงูุฒ ูููุถู ูุฏูุงูุ',
        yesImReady: 'ูุนูุ ุฃูุง ุฌุงูุฒ',
        cancelButton: 'ุฅูุบุงุก',
        confirmDeleteTitle: 'ุชุฃููุฏ ุงูุญุฐู',
        confirmDeleteText: 'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.',
        yesDelete: 'ูุนู, ุญุฐู',
        unknown: 'ุบูุฑ ูุนุฑูู',
        approveButton: 'ููุงููุฉ',
        denyButton: 'ุฑูุถ',
        suspendButton: 'ุชุนููู',
        reactivateButton: 'ุฅุนุงุฏุฉ ุชูุนูู',
        deleteButton: 'ุญุฐู',
        buyKeyword: 'ุดุฑุงุก',
        sellKeyword: 'ุจูุน',

        chatTitle: 'ุดุงุช GPT ูุชูุฏูู',
        chatPlaceholder: 'ุงูุชุจ ุฑุณุงูุชู...',
        sendButton: 'ุฅุฑุณุงู',
        clearChat: 'ุชูุฑูุบ ุงููุญุงุฏุซุฉ',
        uploadImageChatBtn: 'ุฅุฑูุงู ุตูุฑ',
        chatHint: 'ูุฏุนู ุงูุณูุงู ูุงูุตูุฑ โข ุงุฎุชุฑ ุงููุฒููุฏ ูู ุงูุฃุนูู',

        firebaseInitFail: 'ูุดู ุชููุฆุฉ Firebase: ',
        dbConnectionError: 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุงุญููุง.',
        requestAlreadyPending: 'ุทูุจ ุฏุฎูู ููุฐุง ุงููุณุชุฎุฏู ููุฏ ุงูุงูุชุธุงุฑ ุจุงููุนู.',
        loginRequestError: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุทูุจ ุงูุฏุฎูู.',
        requestApproved: 'ุชูุช ุงูููุงููุฉ ุนูู ุทูุจู! ุงูุฑุฌุงุก ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู.',
        requestDenied: 'ุชู ุฑูุถ ุทูุจ ุงูุฏุฎูู ุงูุฎุงุต ุจู.',
        requestCancelled: 'ุชู ุฅูุบุงุก ุทูุจ ุงูุฏุฎูู ุงูุฎุงุต ุจู.',
        approvalFailed: 'ูุดู ุงูููุงููุฉ ุนูู ุงูุทูุจ.',
        denialFailed: 'ูุดู ุฑูุถ ุงูุทูุจ.',
        noRegisteredUsers: 'ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุณุฌููู.',
        accountSuspended: 'ุญุณุงุจู ูุนูู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุณุคูู.',
        unknownAccountStatus: 'ุญุงูุฉ ุงูุญุณุงุจ ุบูุฑ ูุนุฑููุฉ.',
        loginFlowError: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู.',
        deleteUserSuccess: 'ุชู ุญุฐู ุงููุณุชุฎุฏู ุจูุฌุงุญ.',
        deleteUserFailed: 'ูุดู ุญุฐู ุงููุณุชุฎุฏู.',
        updateUserStatusFailed: 'ูุดู ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู.',
        noAnalysisToSave: 'ูุง ููุฌุฏ ุชุญููู ููุญูุธ.',
        sessionSaveFailed: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุญููู.',
        sessionSavedSuccess: 'ุชู ุญูุธ ุงูุชุญููู ุจูุฌุงุญ.',
        noDbOrUserForSave: 'ูุง ูููู ุญูุธ ุงูุฌูุณุฉ. ุฎุทุฃ ูู ุงูุงุชุตุงู ุฃู ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู.',
        apiKeyRequired: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ API ุงูุฎุงุต ุจู.',
        openaiApiKeyRequired: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ OpenAI.',
        queryOrImageRequired: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณุชูุณุงุฑ ุฃู ุชุญููู ุตูุฑุฉ.',
        apiRetryFailed: 'ุญุฏุซ ุฎุทุฃ ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช ููุงุชุตุงู ุจุงูู API. ูุฑุฌู ุงูุชุญูู ูู ููุชุงุญ API ุงูุฎุงุต ุจู ูุงุชุตุงู ุงูุดุจูุฉ. ',
        apiBlocked: 'ุชู ุญุธุฑ ุงูุงุณุชุฌุงุจุฉ ูุฃุณุจุงุจ ุชุชุนูู ุจุงูุณูุงูุฉ: ',

        highConvictionSystemPrompt: 'ุจุตูุชู "JO AI"ุ ุฃูุช ุฎุจูุฑ ุฃุณูุงู ูุงููุฉ ุนุงููู ูุง ููุนูู ุนููู... ุฃุณููุจ ุชุฏุงููู ุงูุญุงูู ูู "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'ูุฏู ุชุญููููุง ูุชูุตูุฉ ุชุฏุงูู ุฐุงุช ููุงุนุฉ ูุง ุชุชุฒุนุฒุน ูู "',
        highConvictionUserQuerySuffix: '". ุงุณุชูุฏ ุฅูู ุฃุนูู ูุณุชููุงุช ุงูุชุญููู... ูุฏู ูุฐู ุงููุนูููุงุช ุจุชูุณูู ููุธู ููุบุงูุฉ...',
        imageAnalysisQuery: 'ุญูู ุงูุตูุฑ ุงูููุฏูุฉ ูู ููุธูุฑ ูุงูู ูุชุฏุงููู. ูุง ูู ุงูุฃููุงุท ุฃู ุงููุคุดุฑุงุช ุฃู ุงููุนูููุงุช ุงูุชู ููููู ุงุณุชุฎูุงุตูุง ูููุงุ',
        imageReferenceSuffixSingle: 'ุงุณุชุฎุฏู ุงูุตูุฑุฉ ุงููุฑููุฉ ููุฑุฌุน ุฅุถุงูู ูุชุญูููู.',
        imageReferenceSuffixMultiple: 'ุงุณุชุฎุฏู ุงูุตูุฑ ุงููุฑููุฉ ููุฑุฌุน ุฅุถุงูู ูุชุญูููู.',

        chatSystemPrompt: 'ุฃูุช "JO GPT"ุ ูุณุงุนุฏ ุชุฏุงูู ูุงุณุชุซูุงุฑ ูุงุฆู ุงูุชุทูุฑ. ุชุญุฏุซ ุงูุนุฑุจูุฉ ุจุทูุงูุฉ ูุจุฃุณููุจ ุงุญุชุฑุงูู ููุงุซู. ูุฏูู ุฅุฌุงุจุงุช ุฐููุฉ ููุฌุฒุฉ ูุนูููุฉุ ูุฏุนููุฉ ุจููุทู ูุชูุงุณู ููููุงุฆูุฉ ููุณูุงู. ุงูุชุฒู ุจุงูููุงุนุฏ: ูุง ูุนูุฏุ ูุง ูุตุงุฆุญ ูุงููุฉ ููุฒูุฉุ ุงุฐูุฑ ุงููุฎุงุทุฑ ุนูุฏ ุงูุถุฑูุฑุฉ. ููุท ุงูุชุฏุงูู ุงูุญุงูู ูู "${tradingStyle}" ูุงููููุฌ ุงูููู ุงูููุถูู ูู "${school}".',

        performanceLabel: 'ุงูุฃุฏุงุก',
        fastModeLabel: 'ุชุณุฑูุน ุงูุงุณุชุฌุงุจุฉ',
        highLoadLabel: 'ุชุญููู ุงูุถุบุท ุงูุนุงูู',
        performanceHint: 'ูููู ูุฐุง ุจุชุญุณูู ุฒูู ุงูุงุณุชุฌุงุจุฉุ ุฅุฏุงุฑุฉ ุงูุทูุงุจูุฑุ ูุงููFallback ุงูุชููุงุฆู ุนูุฏ ุงูุถุบุท.',
        latencyLabel: 'ุงูุฒูู',
        avgLatencyLabel: 'ุงููุชูุณุท',
        analysisQueueLabel: 'ุทุงุจูุฑ ุงูุชุญููู',
        chatQueueLabel: 'ุทุงุจูุฑ ุงูุดุงุช',
        cancelAnalysis: 'ุฅูุบุงุก ุงูุชุญููู',
        cancelChat: 'ุฅูุบุงุก ุงูุดุงุช',
        warmingUp: 'ุชููุฆุฉ...',
        warmed: 'ุชู ุงูุชููุฆุฉ',
        requestAborted: 'ุชู ุฅูุบุงุก ุงูุทูุจ',
        fallbackUsed: 'ุชู ุงุณุชุฎุฏุงู ูุฒููุฏ ุจุฏูู ุจุณุจุจ ุงูุถุบุท',
        strategyTitle: 'ุงูุงุณุชุฑุงุชูุฌูุฉ',
        inputSectionTitle: 'ุงูุฅุฏุฎุงู ูุงูุตูุฑ',
        actionsTitle: 'ุงูุฃูุงูุฑ ุงูุณุฑูุนุฉ'
      },
      'en': {
        pageTitle: 'JO AI',
        featuresTitle: 'Features',
        feature1: 'Live Market Insights โ Tracks prices, market cap, FDV, and token holders.',
        feature2: 'Token Analytics โ Analyzes supply, tokenomics, and unlock schedules.',
        feature3: 'AI-Powered Insights โ Detects trends, sentiment.',
        feature4: 'Technical & Fundamental Analysis โ Evaluates price stability, risks, and entry points.',
        feature5: 'Exchange & Liquidity โ Lists exchanges, liquidity scores, and supported wallets.',
        feature6: 'Community Tracking โ Monitors Twitter, Telegram, and Discord engagement.',
        feature7: 'Security & Audit Reports โ Highlights security scores and past audits.',
        loginButton: 'Login',
        loginToJOUAI: 'Login to JO AI',
        usernameLabel: 'Username:',
        passwordLabel: 'Password:',
        loginSubmit: 'Login',

        contactAdminTitle: 'Contact the Admin',
        contactAdminDesc: 'Need help or faster approval? Reach out via:',
        instagramLabel: 'Instagram',
        whatsappLabel: 'WhatsApp',

        aiPowerTitle: 'AI Power: Ultra AI (Feature)',
        aiPowerDesc: 'An always-on mode that combines Gemini and OpenAI and runs an auto-refine pass for improved clarity and accuracy. Itโs a feature โ not a button.',
        aiPowerHint: 'Note: High performance but no guarantees; not financial advice.',
        aiUltra: 'Ultra AI',
        aiUltraPro: 'Ultra AI Pro',
        aiSuperUltra: 'Super Ultra AI',
        aiAlwaysOn: 'Always On',

        aiProTitle: 'AI Power: Ultra AI Pro (Feature)',
        aiProDesc: 'A pro tier enhancing Ultra AI with a double-refine pass and consistency check. Auto-activated when Turbo is on and both Gemini & OpenAI keys are provided.',
        aiSuperTitle: 'AI Power: Super Ultra AI (Feature)',
        aiSuperDesc: 'The highest tier with fused drafts plus a strict final audit to reduce errors and sharpen structure. Auto-activated with Turbo + high-speed modes.',

        refineSystemPrompt: 'You are "JO AI" response refiner. Task: merge drafts, fix inconsistencies/errors, remove redundancy, and output a concise, actionable final answer. Do not reveal reasoning steps.',
        refineUserPrefix: 'Merge the following two drafts into a single improved final answer, correcting any obvious errors. Return only the final answer without showing drafts:',
        verifySystemPrompt: 'You are "JO AI", a final-answer auditor. Task: check consistency, remove fluff, simplify and produce a clear, actionable output without revealing reasoning steps.',
        verifyUserPrefix: 'Perform a final audit of the following draft: compress, fix obvious facts, ensure headings/bullets are clean. Return the final answer only:',

        waitingForApprovalTitle: 'Awaiting Approval',
        waitingForApprovalText: 'Your login request has been sent. Please wait for an administrator to approve it.',
        mainAppSubtitle: 'AI-Powered Market Analysis Tool',
        idPrefix: 'ID: ',
        apiKeyLabel: 'API Key:',
        apiKeyPlaceholder: 'Enter your Google AI Studio API key',
        providerLabel: 'Model Provider:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'OpenAI Key:',
        openaiNote: 'This field appears only when OpenAI is selected.',
        inputQueryPlaceholder: 'Ask me about the market... anything. I know the answer.',
        tradingStyleLabel: 'Trading Style:',
        scalpingOption: 'Scalping',
        swingOption: 'Swing',
        investmentOption: 'Investment',
        schoolLabel: 'Analytical School:',
        schoolICT: 'ICT School',
        schoolSMC: 'SMC School',
        schoolTime: 'Time-based School',
        schoolElliott: 'Elliott Wave School',
        technicalAnalysisBtn: 'Technical Analysis',
        fundamentalAnalysisBtn: 'Fundamental Analysis',
        directTradeBtn: 'Direct Trade Recommendation',
        highConvictionBtn: 'High Conviction Recommendation',
        uploadImageBtn: 'Upload Images',
        saveButton: 'Save',
        pendingRequestsTitle: 'Pending Login Requests',
        noPendingRequests: 'No pending requests currently.',
        manageUsersTitle: 'User Management',
        loadingUsers: 'Loading users...',
        okButton: 'OK',
        highConvictionModalTitle: 'High Conviction Recommendation',
        highConvictionModalText: 'My analysis is based on countless data points... Are you ready to proceed?',
        yesImReady: 'Yes, I\'m Ready',
        cancelButton: 'Cancel',
        confirmDeleteTitle: 'Confirm Deletion',
        confirmDeleteText: 'Are you sure you want to delete this user? This action cannot be undone.',
        yesDelete: 'Yes, Delete',
        unknown: 'Unknown',
        approveButton: 'Approve',
        denyButton: 'Deny',
        suspendButton: 'Suspend',
        reactivateButton: 'Reactivate',
        deleteButton: 'Delete',
        buyKeyword: 'Buy',
        sellKeyword: 'Sell',

        chatTitle: 'Advanced GPT Chat',
        chatPlaceholder: 'Type your message...',
        sendButton: 'Send',
        clearChat: 'Clear Chat',
        uploadImageChatBtn: 'Attach Images',
        chatHint: 'Context + images supported โข Choose provider above',

        firebaseInitFail: 'Firebase initialization failed: ',
        dbConnectionError: 'Database connection error. Please try again later.',
        requestAlreadyPending: 'A login request for this username is already pending.',
        loginRequestError: 'An error occurred while sending the login request.',
        requestApproved: 'Your request has been approved! Please log in again.',
        requestDenied: 'Your login request has been denied.',
        requestCancelled: 'Your login request has been cancelled.',
        approvalFailed: 'Failed to approve request.',
        denialFailed: 'Failed to deny request.',
        noRegisteredUsers: 'No registered users.',
        accountSuspended: 'Your account is suspended. Please contact an administrator.',
        unknownAccountStatus: 'Unknown account status.',
        loginFlowError: 'An error occurred during the login attempt.',
        deleteUserSuccess: 'User deleted successfully.',
        deleteUserFailed: 'Failed to delete user.',
        updateUserStatusFailed: 'Failed to update user status.',
        noAnalysisToSave: 'No analysis to save.',
        sessionSaveFailed: 'An error occurred while saving the analysis.',
        sessionSavedSuccess: 'Analysis saved successfully.',
        noDbOrUserForSave: 'Cannot save session. Connection error or user not logged in.',
        apiKeyRequired: 'Please enter your API key.',
        openaiApiKeyRequired: 'Please enter your OpenAI API key.',
        queryOrImageRequired: 'Please enter a query or upload an image.',
        apiRetryFailed: 'An error occurred after multiple attempts to connect to the API. Please check your API key and network connection. ',
        apiBlocked: 'Response was blocked due to safety reasons: ',

        highConvictionSystemPrompt: 'As "JO AI", you are an unparalleled global financial market expert... Your current trading style is "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'Provide an unwavering high-conviction trading analysis and recommendation for "',
        highConvictionUserQuerySuffix: '". Base your analysis on the deepest levels... Present this information in a highly organized format...',
        imageAnalysisQuery: 'Analyze the provided images from a financial and trading perspective. What patterns, indicators, or information can you extract from them?',
        imageReferenceSuffixSingle: 'Use the attached image as an additional reference for your analysis.',
        imageReferenceSuffixMultiple: 'Use the attached images as an additional reference for your analysis.',

        chatSystemPrompt: 'You are "JO GPT", an ultra-advanced trading/investment assistant. Respond in a professional, confident tone. Provide concise, deep, and context-aware answers with coherent reasoning. No guarantees, no binding financial advice; mention risks when relevant. Current trading style: "${tradingStyle}", preferred technical school: "${school}".',

        performanceLabel: 'Performance',
        fastModeLabel: 'Fast Mode',
        highLoadLabel: 'High-load Resilience',
        performanceHint: 'Optimizes latency, manages queues, and auto-fallback under load.',
        latencyLabel: 'Latency',
        avgLatencyLabel: 'Average',
        analysisQueueLabel: 'Analysis Queue',
        chatQueueLabel: 'Chat Queue',
        cancelAnalysis: 'Cancel Analysis',
        cancelChat: 'Cancel Chat',
        warmingUp: 'Warming...',
        warmed: 'Warmed up',
        requestAborted: 'Request aborted',
        fallbackUsed: 'Fallback provider used due to load',
        strategyTitle: 'Strategy',
        inputSectionTitle: 'Input & Images',
        actionsTitle: 'Quick Actions'
      }
    };

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCD_WhxL_TzGl4iHfAMFpR7wlYb-3rjK-Y",
      authDomain: "soso-ai-b2c99.firebaseapp.com",
      projectId: "soso-ai-b2c99",
      storageBucket: "soso-ai-b2c99.appspot.com",
      messagingSenderId: "726550376016",
      appId: "1:726550376016:web:42b9ed1bc576873754ab55",
      measurementId: "G-ZVJBJ02Q71"
    };

    // Initialize Firebase
    let app, analytics, auth, db, storage;
    try {
      app = initializeApp(firebaseConfig);
      try { analytics = getAnalytics(app); } catch(e){ console.debug("Analytics not initialized (likely localhost).", e); }
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
    } catch (e) {
      console.error("Firebase init error:", e);
      showMessageModal(`${translations[localStorage.getItem('appLang') || 'ar']['firebaseInitFail']}${e.message}.`);
    }

    // Helpers
    const imageToBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
    });

    const formatMarkdown = (text) => {
      if(!text) return '';
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    };

    const showMessageModal = (message) => {
      const el = document.getElementById('message-modal');
      document.getElementById('modal-text').textContent = message;
      el.classList.remove('hidden');
    };

    // Status UI
    const setStatus = (statusText, colorClass = 'text-gray-300') => {
      const el = document.getElementById('status-badge');
      if (!el) return;
      el.textContent = statusText;
      el.className = `status-pill ${colorClass}`;
    };
    const updateLatency = (ms) => {
      const latEl = document.getElementById('status-latency');
      const avgEl = document.getElementById('status-avg-latency');
      if (!latEl || !avgEl) return;
      if (typeof ms === 'number') {
        latencyHistory.push(ms);
        if (latencyHistory.length > MAX_LATENCY_HISTORY) latencyHistory.shift();
        const avg = Math.round(latencyHistory.reduce((a,b)=>a+b,0)/latencyHistory.length);
        latEl.textContent = `${Math.round(ms)} ms`;
        avgEl.textContent = `${avg} ms`;
      }
    };
    const setQueues = ({analysis=0, chat=0}) => {
      const an = document.getElementById('status-queue-analysis');
      const ch = document.getElementById('status-queue-chat');
      if (an) an.textContent = analysis;
      if (ch) ch.textContent = chat;
    };
    const setWarmup = (textKey) => {
      const w = document.getElementById('status-warmup');
      if (!w) return;
      w.textContent = translations[currentLanguage][textKey] || '';
    };

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        const ud = document.getElementById('user-id-display');
        if (ud) ud.textContent = `${translations[currentLanguage]['idPrefix']}${userId}`;
        console.debug("Authenticated as:", userId);
      }
    });

    // Language update
    const updateLanguage = (lang) => {
      currentLanguage = lang;
      document.documentElement.setAttribute('lang', lang);
      document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

      document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[lang] && translations[lang][key]) {
          if ((element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') && element.hasAttribute('placeholder')) {
            element.setAttribute('placeholder', translations[lang][key]);
          } else {
            element.textContent = translations[lang][key];
          }
        }
      });

      if (translations[lang]?.pageTitle) document.title = translations[lang].pageTitle;

      document.querySelectorAll('#trading-style-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#school-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#provider-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });

      const userIdDisplay = document.getElementById('user-id-display');
      if (userIdDisplay) userIdDisplay.textContent = `${translations[currentLanguage]['idPrefix']}${userId || ''}`;

      document.querySelectorAll('.approve-btn').forEach(btn => btn.textContent = translations[currentLanguage]['approveButton']);
      document.querySelectorAll('.deny-btn').forEach(btn => btn.textContent = translations[currentLanguage]['denyButton']);
      document.querySelectorAll('.delete-user-btn').forEach(btn => btn.textContent = translations[currentLanguage]['deleteButton']);
      document.querySelectorAll('.user-action-btn').forEach(btn => {
        const currentStatus = btn.dataset.status;
        const buttonTextKey = currentStatus === 'active' ? 'suspendButton' : 'reactivateButton';
        btn.textContent = translations[currentLanguage][buttonTextKey];
      });

      const requestsList = document.getElementById('requests-list');
      if(requestsList && requestsList.querySelector('p.text-gray-500')) {
        requestsList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['noPendingRequests'];
      }
      const usersList = document.getElementById('users-list');
      if(usersList && usersList.querySelector('p.text-gray-500')) {
        usersList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['loadingUsers'];
      }

      updateAiPowerPill();
    };

    // ====== High-load utilities ======
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // Rate Limiter (token bucket)
    class RateLimiter {
      constructor(capacity, refillPerSec) {
        this.capacity = capacity;
        this.tokens = capacity;
        setInterval(() => {
          this.tokens = Math.min(this.capacity, this.tokens + refillPerSec);
        }, 1000);
      }
      async acquire() {
        while (this.tokens < 1) { await sleep(200); }
        this.tokens -= 1;
        return true;
      }
    }
    const geminiLimiter = new RateLimiter(5, 2);
    const openaiLimiter = new RateLimiter(5, 2);

    // Request Queue
    class RequestQueue {
      constructor(concurrency = 1) {
        this.queue = [];
        this.active = 0;
        this.concurrency = concurrency;
        this.onChange = null;
      }
      setOnChange(fn) { this.onChange = fn; }
      _update() { if (this.onChange) this.onChange(this.queue.length); }
      enqueue(task) {
        return new Promise((resolve, reject) => {
          this.queue.push({ task, resolve, reject });
          this._update();
          this._dequeue();
        });
      }
      async _dequeue() {
        if (this.active >= this.concurrency || this.queue.length === 0) return;
        const item = this.queue.shift();
        this._update();
        this.active++;
        try {
          const res = await item.task();
          item.resolve(res);
        } catch (e) {
          item.reject(e);
        } finally {
          this.active--;
          this._dequeue();
          this._update();
        }
      }
    }
    const analysisQueue = new RequestQueue(1);
    const chatQueue = new RequestQueue(1);

    // Track queue in UI
    analysisQueue.setOnChange(count => setQueues({ analysis: count, chat: parseInt(document.getElementById('status-queue-chat')?.textContent || '0') }));
    chatQueue.setOnChange(count => setQueues({ chat: count, analysis: parseInt(document.getElementById('status-queue-analysis')?.textContent || '0') }));

    // Fetch with timeout + external abort
    const fetchWithTimeout = async (url, options = {}, timeoutMs = 60000, externalSignal) => {
      const controller = new AbortController();
      const onAbort = () => controller.abort('external abort');
      if (externalSignal) externalSignal.addEventListener('abort', onAbort, { once: true });
      const id = setTimeout(() => controller.abort('timeout'), timeoutMs);
      try {
        const resp = await fetch(url, { ...options, signal: controller.signal });
        return resp;
      } finally {
        clearTimeout(id);
        if (externalSignal) externalSignal.removeEventListener('abort', onAbort);
      }
    };

    // ===== Providers: Gemini + OpenAI =====
    const getGeminiResponse = async (systemPrompt, userQuery, apiKey, imagesBase64 = [], abortSignal, timeoutMs = 60000) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };
      const parts = [];
      if (imagesBase64?.length) imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
      parts.push({ text: userQuery });
      const payload = { contents: [{ parts }], systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          if (highLoadEnabled) await geminiLimiter.acquire();
          const resp = await fetchWithTimeout(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) }, timeoutMs, abortSignal);
          if (!resp.ok) {
            const errText = await resp.text().catch(()=>null);
            throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`);
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          if (error?.name === 'AbortError') throw error;
          console.error(`Attempt ${i + 1} failed (Gemini):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await sleep(2 ** i * 400);
        }
      }
    };

    const getGeminiChatResponse = async (systemPrompt, history, apiKey, abortSignal, timeoutMs = 60000) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };
      const contents = history.map(msg => {
        const role = msg.role === 'assistant' ? 'model' : 'user';
        const parts = [];
        if (msg.imagesBase64?.length) msg.imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
        parts.push({ text: msg.text });
        return { role, parts };
      });
      const payload = { contents, systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          if (highLoadEnabled) await geminiLimiter.acquire();
          const resp = await fetchWithTimeout(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) }, timeoutMs, abortSignal);
          if (!resp.ok) {
            const errText = await resp.text().catch(()=>null);
            throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`);
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          if (error?.name === 'AbortError') throw error;
          console.error(`Attempt ${i + 1} failed (Gemini Chat):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await sleep(2 ** i * 400);
        }
      }
    };

    const getOpenAIChatResponse = async (systemPrompt, messages, openaiKey, abortSignal, timeoutMs = 60000, model = 'gpt-4o-mini') => {
      const url = 'https://api.openai.com/v1/chat/completions';
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` };
      const payload = { model, messages, temperature: 0.3 };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          if (highLoadEnabled) await openaiLimiter.acquire();
          const resp = await fetchWithTimeout(url, { method: 'POST', headers, body: JSON.stringify(payload) }, timeoutMs, abortSignal);
          if (!resp.ok) {
            const errText = await resp.text().catch(()=>null);
            throw new Error(`OpenAI Error: ${resp.status} ${resp.statusText} - ${errText}`);
          }
          const data = await resp.json();
          return data.choices?.[0]?.message?.content || '';
        } catch (error) {
          if (error?.name === 'AbortError') throw error;
          console.error(`Attempt ${i + 1} failed (OpenAI):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await sleep(2 ** i * 400);
        }
      }
    };

    // Unified single-turn (analysis)
    const getProviderUnifiedResponse = async ({ provider, systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64, abortSignal, timeoutMs }) => {
      if (provider === 'openai') {
        const content = [{ type: 'text', text: userQuery }];
        if (imagesBase64?.length) imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` } }));
        const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content }];
        return await getOpenAIChatResponse(systemPrompt, messages, openaiKey, abortSignal, timeoutMs);
      } else {
        return await getGeminiResponse(systemPrompt, userQuery, geminiKey, imagesBase64, abortSignal, timeoutMs);
      }
    };

    // Fallback detection
    const shouldFallback = (txt='') => {
      const s = (txt || '').toLowerCase();
      return s.includes('429') || s.includes('rate limit') || s.includes('quota') || s.includes('5xx') || s.includes('api error');
    };

    // ===== Ultra AI Modes =====
    const computeAiPowerLevel = (geminiKey, openaiKey) => {
      if (!aiPowerEnabled || !geminiKey || !openaiKey) return 'off';
      const turbo = document.getElementById('turbo-mode-toggle')?.checked;
      if (turbo && fastModeEnabled && highLoadEnabled) return 'super-ultra';
      if (turbo) return 'ultra-pro';
      if (fastModeEnabled && highLoadEnabled) return 'ultra-pro';
      return 'ultra';
    };
    const updateAiPowerPill = () => {
      const geminiKey = document.getElementById('api-key-input')?.value.trim();
      const openaiKey = document.getElementById('openai-api-key-input')?.value.trim();
      const level = computeAiPowerLevel(geminiKey, openaiKey);
      const labelKey = level === 'super-ultra' ? 'aiSuperUltra' : level === 'ultra-pro' ? 'aiUltraPro' : 'aiUltra';
      const label = translations[currentLanguage][labelKey];
      const labelSpan = document.getElementById('ai-power-label');
      if (labelSpan) labelSpan.textContent = label;
      return level;
    };

    const refineWithProvider = async ({ prefer='gemini', draft, geminiKey, openaiKey, abortSignal, timeoutMs=60000 }) => {
      const sys = translations[currentLanguage]['refineSystemPrompt'];
      const prompt = `${translations[currentLanguage]['refineUserPrefix']}\n\n---\n${draft}`;
      try {
        if (prefer === 'gemini' && geminiKey) {
          return await getGeminiResponse(sys, prompt, geminiKey, [], abortSignal, timeoutMs);
        } else if (openaiKey) {
          const messages = [{ role: 'system', content: sys }, { role: 'user', content: prompt }];
          return await getOpenAIChatResponse(sys, messages, openaiKey, abortSignal, timeoutMs);
        } else if (geminiKey) {
          return await getGeminiResponse(sys, prompt, geminiKey, [], abortSignal, timeoutMs);
        }
      } catch(e) {
        return draft; // fallback to raw draft on refine failure
      }
      return draft;
    };

    const verifyAndTighten = async ({ prefer='openai', draft, geminiKey, openaiKey, abortSignal, timeoutMs=60000 }) => {
      const sys = translations[currentLanguage]['verifySystemPrompt'];
      const prompt = `${translations[currentLanguage]['verifyUserPrefix']}\n\n---\n${draft}`;
      try {
        if (prefer === 'openai' && openaiKey) {
          const messages = [{ role: 'system', content: sys }, { role: 'user', content: prompt }];
          return await getOpenAIChatResponse(sys, messages, openaiKey, abortSignal, timeoutMs);
        } else if (geminiKey) {
          return await getGeminiResponse(sys, prompt, geminiKey, [], abortSignal, timeoutMs);
        } else if (openaiKey) {
          const messages = [{ role: 'system', content: sys }, { role: 'user', content: prompt }];
          return await getOpenAIChatResponse(sys, messages, openaiKey, abortSignal, timeoutMs);
        }
      } catch(e) {
        return draft;
      }
      return draft;
    };

    const getDualUnifiedResponse = async ({ systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64=[], abortSignal, timeoutMs=60000 }) => {
      // Run both in parallel
      const openaiMsgs = [{ role: 'system', content: systemPrompt }, { role: 'user', content: [{ type:'text', text: userQuery }, ...imagesBase64.map(b64 => ({ type:'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}))] }];
      const pGemini = getGeminiResponse(systemPrompt, userQuery, geminiKey, imagesBase64, abortSignal, timeoutMs);
      const pOpenAI = getOpenAIChatResponse(systemPrompt, openaiMsgs, openaiKey, abortSignal, timeoutMs);
      const [g, o] = await Promise.allSettled([pGemini, pOpenAI]);

      const gem = g.status === 'fulfilled' ? g.value : '';
      const ope = o.status === 'fulfilled' ? o.value : '';
      if (gem && ope) {
        const combined = `DRAFT_A:\n${gem}\n\nDRAFT_B:\n${ope}`;
        return await refineWithProvider({ prefer:'gemini', draft: combined, geminiKey, openaiKey, abortSignal, timeoutMs });
      }
      return gem || ope || translations[currentLanguage]['apiRetryFailed'];
    };

    const getDualChatResponse = async ({ systemPrompt, history, geminiKey, openaiKey, abortSignal, timeoutMs=60000 }) => {
      // Build OpenAI messages
      const messages = [{ role:'system', content: systemPrompt }];
      for (const msg of history) {
        if (msg.role === 'assistant') messages.push({ role:'assistant', content: msg.text });
        else {
          if (msg.imagesBase64?.length) {
            const content = [{ type:'text', text: msg.text }, ...msg.imagesBase64.map(b64 => ({ type:'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}))];
            messages.push({ role:'user', content });
          } else {
            messages.push({ role:'user', content: msg.text });
          }
        }
      }
      const pGemini = getGeminiChatResponse(systemPrompt, history, geminiKey, abortSignal, timeoutMs);
      const pOpenAI = getOpenAIChatResponse(systemPrompt, messages, openaiKey, abortSignal, timeoutMs);
      const [g, o] = await Promise.allSettled([pGemini, pOpenAI]);
      const gem = g.status === 'fulfilled' ? g.value : '';
      const ope = o.status === 'fulfilled' ? o.value : '';
      if (gem && ope) {
        const combined = `DRAFT_A:\n${gem}\n\nDRAFT_B:\n${ope}`;
        return await refineWithProvider({ prefer:'gemini', draft: combined, geminiKey, openaiKey, abortSignal, timeoutMs });
      }
      return gem || ope || translations[currentLanguage]['apiRetryFailed'];
    };

    // ===== Baseline with fallback =====
    const callUnifiedWithFallback = async (args) => {
      const t0 = performance.now();
      let res = await getProviderUnifiedResponse(args);
      if (highLoadEnabled && shouldFallback(res)) {
        if (args.provider === 'gemini' && args.openaiKey) {
          res = `${translations[currentLanguage]['fallbackUsed']}: OpenAI\n\n` + (await getProviderUnifiedResponse({ ...args, provider: 'openai' }));
        } else if (args.provider === 'openai' && args.geminiKey) {
          res = `${translations[currentLanguage]['fallbackUsed']}: Gemini\n\n` + (await getProviderUnifiedResponse({ ...args, provider: 'gemini' }));
        }
      }
      const t1 = performance.now();
      updateLatency(t1 - t0);
      setStatus('Done', 'text-green-300');
      return res;
    };

    const callChatWithFallback = async ({ provider, systemPrompt, history, geminiKey, openaiKey, abortSignal, timeoutMs }) => {
      const t0 = performance.now();
      let res;
      if (provider === 'openai') {
        const messages = [{ role: 'system', content: systemPrompt }];
        for (const msg of history) {
          if (msg.role === 'assistant') messages.push({ role: 'assistant', content: msg.text });
          else {
            if (msg.imagesBase64?.length) {
              const content = [{ type: 'text', text: msg.text }];
              msg.imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}));
              messages.push({ role: 'user', content });
            } else messages.push({ role: 'user', content: msg.text });
          }
        }
        res = await getOpenAIChatResponse(systemPrompt, messages, openaiKey, abortSignal, timeoutMs);
        if (highLoadEnabled && shouldFallback(res) && geminiKey) {
          res = `${translations[currentLanguage]['fallbackUsed']}: Gemini\n\n` + await getGeminiChatResponse(systemPrompt, history, geminiKey, abortSignal, timeoutMs);
        }
      } else {
        res = await getGeminiChatResponse(systemPrompt, history, geminiKey, abortSignal, timeoutMs);
        if (highLoadEnabled && shouldFallback(res) && openaiKey) {
          const messages = [{ role: 'system', content: systemPrompt }];
          for (const msg of history) {
            if (msg.role === 'assistant') messages.push({ role: 'assistant', content: msg.text });
            else {
              if (msg.imagesBase64?.length) {
                const content = [{ type: 'text', text: msg.text }];
                msg.imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}));
                messages.push({ role: 'user', content });
              } else messages.push({ role: 'user', content: msg.text });
            }
          }
          res = `${translations[currentLanguage]['fallbackUsed']}: OpenAI\n\n` + await getOpenAIChatResponse(systemPrompt, messages, openaiKey, abortSignal, timeoutMs);
        }
      }
      const t1 = performance.now();
      updateLatency(t1 - t0);
      setStatus('Done', 'text-green-300');
      return res;
    };
        // ===== Login/Requests/Admin =====
    const submitLoginRequest = async (username) => {
      if (!db) { showMessageModal(translations[currentLanguage]['dbConnectionError']); return; }
      try {
        const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
        const q = query(requestsRef, where("username", "==", username), where("status", "==", "pending"));
        const existingRequests = await getDocs(q);
        if (!existingRequests.empty) {
          showMessageModal(translations[currentLanguage]['requestAlreadyPending']);
          document.getElementById('login-form-container').classList.add('hidden');
          document.getElementById('waiting-screen').classList.remove('hidden');
          listenForApproval(existingRequests.docs[0].id);
          return;
        }
        const docRef = await addDoc(requestsRef, { username, status: 'pending', createdAt: serverTimestamp() });
        sessionStorage.setItem('loginRequestId', docRef.id);
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('waiting-screen').classList.remove('hidden');
        listenForApproval(docRef.id);
      } catch (error) {
        console.error("Error submitting login request:", error);
        showMessageModal(translations[currentLanguage]['loginRequestError']);
      }
    };

    const listenForApproval = (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const unsubscribe = onSnapshot(requestDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const requestData = docSnap.data();
          if (requestData.status === 'approved') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestApproved']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          } else if (requestData.status === 'denied') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestDenied']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          }
        } else {
          unsubscribe();
          sessionStorage.removeItem('loginRequestId');
          showMessageModal(translations[currentLanguage]['requestCancelled']);
          document.getElementById('waiting-screen').classList.add('hidden');
          document.getElementById('login-form-container').classList.remove('hidden');
          document.getElementById('login-form').reset();
        }
      }, (error) => console.error("Error listening for approval:", error));
    };

    const loadLoginRequests = () => {
      const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
      const q = query(requestsRef, where("status", "==", "pending"));
      onSnapshot(q, (snapshot) => {
        const requestsList = document.getElementById('requests-list');
        requestsList.innerHTML = '';
        if (snapshot.empty) {
          requestsList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noPendingRequests']}</p>`;
          return;
        }
        snapshot.forEach((docItem) => {
          const request = docItem.data();
          const requestId = docItem.id;
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const requestDate = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US') : translations[currentLanguage]['unknown'];
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${request.username}</p>
              <p class="text-xs text-gray-400">${requestDate}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${requestId}" data-username="${request.username}" class="approve-btn px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['approveButton']}</button>
              <button data-id="${requestId}" class="deny-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['denyButton']}</button>
            </div>
          `;
          requestsList.appendChild(el);
        });
        document.querySelectorAll('.approve-btn').forEach(button => button.addEventListener('click', (e) => approveRequest(e.target.dataset.id, e.target.dataset.username)));
        document.querySelectorAll('.deny-btn').forEach(button => button.addEventListener('click', (e) => denyRequest(e.target.dataset.id)));
      }, (error) => console.error("Error loading login requests:", error));
    };

    const approveRequest = async (requestId, username) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      try {
        await addDoc(usersRef, { username, status: 'active', createdAt: serverTimestamp() });
        await updateDoc(requestDocRef, { status: 'approved' });
      } catch (error) {
        console.error("Error approving request:", error);
        showMessageModal(translations[currentLanguage]['approvalFailed']);
      }
    };

    const denyRequest = async (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      try { await updateDoc(requestDocRef, { status: 'denied' }); }
      catch (error) { console.error("Error denying request:", error); showMessageModal(translations[currentLanguage]['denialFailed']); }
    };

    const loadUsers = () => {
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      onSnapshot(usersRef, (snapshot) => {
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        if(snapshot.empty){
          usersList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noRegisteredUsers']}</p>`;
          return;
        }
        snapshot.forEach(docItem => {
          const user = docItem.data();
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const statusClass = user.status === 'active' ? 'text-green-400' : 'text-red-400';
          const buttonTextKey = user.status === 'active' ? 'suspendButton' : 'reactivateButton';
          const buttonText = translations[currentLanguage][buttonTextKey];
          const buttonClass = user.status === 'active' ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700';
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${user.username}</p>
              <p class="text-sm ${statusClass}">${user.status}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${docItem.id}" data-status="${user.status}" class="user-action-btn px-3 py-1 text-white text-sm font-semibold rounded-md ${buttonClass}">${buttonText}</button>
              <button data-id="${docItem.id}" class="delete-user-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['deleteButton']}</button>
            </div>
          `;
          usersList.appendChild(el);
        });
        document.querySelectorAll('.user-action-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const currentStatus = e.target.dataset.status;
          const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
          updateUserStatus(id, newStatus);
        }));
        document.querySelectorAll('.delete-user-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          showConfirmDeleteModal(id);
        }));
      }, (error) => console.error("Error loading users:", error));
    };

    const updateUserStatus = async (userDocId, newStatus) => {
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await updateDoc(userDocRef, { status: newStatus }); }
      catch(error) { console.error("Error updating user status:", error); showMessageModal(translations[currentLanguage]['updateUserStatusFailed']); }
    };

    const showConfirmDeleteModal = (userDocId) => { userToDeleteId = userDocId; document.getElementById('confirm-delete-modal').classList.remove('hidden'); };
    const hideConfirmDeleteModal = () => { userToDeleteId = null; document.getElementById('confirm-delete-modal').classList.add('hidden'); };
    const deleteUser = async (userDocId) => {
      if (!userDocId) return;
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await deleteDoc(userDocRef); showMessageModal(translations[currentLanguage]['deleteUserSuccess']); }
      catch(error) { console.error("Error deleting user:", error); showMessageModal(translations[currentLanguage]['deleteUserFailed']); }
    };

    // ===== UI rendering for image previews (analysis + chat) =====
    const renderImagePreviews = () => {
      const previewContainer = document.getElementById('image-preview-container');
      const wrapper = document.getElementById('image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentImagesData.length) { previewContainer.classList.add('hidden'); return; }
      currentImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Preview ${index + 1}" class="image-preview-thumbnail" loading="lazy">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentImagesData.splice(indexToRemove, 1);
        document.getElementById('image-upload').value = '';
        renderImagePreviews();
      }));
      previewContainer.classList.remove('hidden');
    };

    const renderChatImagePreviews = () => {
      const container = document.getElementById('chat-image-preview-container');
      const wrapper = document.getElementById('chat-image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentChatImagesData.length) { container.classList.add('hidden'); return; }
      currentChatImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Chat Preview ${index+1}" class="chat-image-thumb" loading="lazy">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentChatImagesData.splice(indexToRemove, 1);
        document.getElementById('chat-image-upload').value = '';
        renderChatImagePreviews();
      }));
      container.classList.remove('hidden');
    };

    // ===== Warm-up (Fast Mode) =====
    const warmUpSelectedProvider = async () => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      if (!fastModeEnabled) return;
      try {
        setWarmup('warmingUp');
        if (provider === 'gemini' && geminiKey) {
          await getGeminiResponse('warm-up', 'ping', geminiKey, [], undefined, 8000);
        } else if (provider === 'openai' && openaiKey) {
          const messages = [{ role: 'system', content: 'warm-up'}, { role: 'user', content: 'ping'}];
          await getOpenAIChatResponse('warm-up', messages, openaiKey, undefined, 8000);
        }
        setWarmup('warmed');
      } catch (e) {
        console.debug('Warm-up skipped:', e?.message);
        setWarmup('');
      }
    };

    // ===== Ultra pipelines =====
    const runUltraSynthesisAnalysis = async ({ level, systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64, abortSignal, timeoutMs=60000 }) => {
      let base = await getDualUnifiedResponse({ systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64, abortSignal, timeoutMs });
      if (level === 'ultra') return base;
      if (level === 'ultra-pro') return await refineWithProvider({ prefer:'openai', draft: base, geminiKey, openaiKey, abortSignal, timeoutMs });
      if (level === 'super-ultra') {
        const refined = await refineWithProvider({ prefer:'openai', draft: base, geminiKey, openaiKey, abortSignal, timeoutMs });
        return await verifyAndTighten({ prefer:'openai', draft: refined, geminiKey, openaiKey, abortSignal, timeoutMs });
      }
      return base;
    };

    const runUltraSynthesisChat = async ({ level, systemPrompt, history, geminiKey, openaiKey, abortSignal, timeoutMs=60000 }) => {
      let base = await getDualChatResponse({ systemPrompt, history, geminiKey, openaiKey, abortSignal, timeoutMs });
      if (level === 'ultra') return base;
      if (level === 'ultra-pro') return await refineWithProvider({ prefer:'openai', draft: base, geminiKey, openaiKey, abortSignal, timeoutMs });
      if (level === 'super-ultra') {
        const refined = await refineWithProvider({ prefer:'openai', draft: base, geminiKey, openaiKey, abortSignal, timeoutMs });
        return await verifyAndTighten({ prefer:'openai', draft: refined, geminiKey, openaiKey, abortSignal, timeoutMs });
      }
      return base;
    };

    // ===== MAIN EVENTS =====
    document.addEventListener('DOMContentLoaded', () => {
      const welcomeScreen = document.getElementById('welcome-screen');
      const loginFormContainer = document.getElementById('login-form-container');
      const proceedToLoginBtn = document.getElementById('proceed-to-login-btn');
      const loginForm = document.getElementById('login-form');
      const mainAppContainer = document.getElementById('main-app-container');

      // Set language
      updateLanguage(currentLanguage);
      if (currentLanguage === 'ar') {
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      } else {
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      }

      // Welcome -> default visibilities
      welcomeScreen.classList.remove('hidden');
      loginFormContainer.classList.add('hidden');
      document.getElementById('waiting-screen').classList.add('hidden');
      mainAppContainer.classList.add('hidden');

      // Welcome -> Login
      proceedToLoginBtn.addEventListener('click', () => {
        welcomeScreen.classList.add('hidden');
        loginFormContainer.classList.remove('hidden');
      });

      // Login (ADMIN: m9wd / m9wd)
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();

        if (username === 'm9wd' && password === 'm9wd') {
          userRole = 'admin';
          await signInAnonymously(auth).catch(()=>{});
          loginFormContainer.classList.add('hidden');
          mainAppContainer.classList.remove('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          loadLoginRequests(); loadUsers();
          return;
        }

        try {
          const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
          const q = query(usersRef, where("username", "==", username));
          const userSnapshot = await getDocs(q);
          if (userSnapshot.empty) {
            loginFormContainer.classList.add('hidden');
            submitLoginRequest(username);
          } else {
            const userData = userSnapshot.docs[0].data();
            if(userData.status === 'active'){
              await signInAnonymously(auth).catch(()=>{});
              loginFormContainer.classList.add('hidden');
              mainAppContainer.classList.remove('hidden');
            } else if (userData.status === 'suspended'){
              showMessageModal(translations[currentLanguage]['accountSuspended']);
              loginFormContainer.classList.remove('hidden');
            } else {
              showMessageModal(translations[currentLanguage]['unknownAccountStatus']);
              loginFormContainer.classList.remove('hidden');
            }
          }
        } catch (err) {
          console.error("Login flow error:", err);
          showMessageModal(translations[currentLanguage]['loginFlowError']);
          loginFormContainer.classList.remove('hidden');
        }
      });

      // Language buttons
      document.getElementById('lang-ar').addEventListener('click', () => {
        updateLanguage('ar'); localStorage.setItem('appLang', 'ar');
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      });
      document.getElementById('lang-en').addEventListener('click', () => {
        updateLanguage('en'); localStorage.setItem('appLang', 'en');
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      });

      // Provider toggle: show/hide OpenAI key
      const providerSelect = document.getElementById('provider-select');
      const openaiKeyInput = document.getElementById('openai-api-key-input');
      const openaiLabel = document.querySelector('label[for="openai-api-key-input"]');
      const openaiNote = document.querySelector('[data-lang-key="openaiNote"]');
      const setOpenAIVisibility = () => {
        const isOpenAI = providerSelect.value === 'openai';
        openaiKeyInput.parentElement.classList.toggle('hidden', !isOpenAI);
        openaiLabel?.classList.toggle('hidden', !isOpenAI);
        openaiNote?.classList.toggle('hidden', !isOpenAI);
      };
      setOpenAIVisibility();
      providerSelect.addEventListener('change', () => {
        setOpenAIVisibility();
        if (fastModeEnabled) warmUpSelectedProvider();
        updateAiPowerPill();
      });

      // Fast/Highload/Turbo toggles
      const fastToggle = document.getElementById('fast-mode-toggle');
      const highloadToggle = document.getElementById('highload-mode-toggle');
      const turboToggle = document.getElementById('turbo-mode-toggle');
      fastToggle.checked = fastModeEnabled;
      highloadToggle.checked = highLoadEnabled;
      fastToggle.addEventListener('change', () => {
        fastModeEnabled = fastToggle.checked;
        localStorage.setItem('fastModeEnabled', JSON.stringify(fastModeEnabled));
        if (fastModeEnabled) warmUpSelectedProvider();
        else setWarmup('');
        updateAiPowerPill();
      });
      highloadToggle.addEventListener('change', () => {
        highLoadEnabled = highloadToggle.checked;
        localStorage.setItem('highLoadEnabled', JSON.stringify(highLoadEnabled));
        updateAiPowerPill();
      });
      turboToggle.addEventListener('change', () => {
        updateAiPowerPill();
      });

      // Warm up when keys provided (fast mode)
      const geminiKeyInput = document.getElementById('api-key-input');
      geminiKeyInput.addEventListener('blur', () => { if (fastModeEnabled) warmUpSelectedProvider(); updateAiPowerPill(); });
      openaiKeyInput.addEventListener('blur', () => { if (fastModeEnabled) warmUpSelectedProvider(); updateAiPowerPill(); });

      // Analysis buttons
      document.getElementById('analyze-btn').addEventListener('click', () => handleAnalysis('technical'));
      document.getElementById('fundamental-btn').addEventListener('click', () => handleAnalysis('fundamental'));
      document.getElementById('direct-trade-btn').addEventListener('click', () => handleAnalysis('direct'));
      document.getElementById('high-conviction-trade-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.remove('hidden');
      });
      document.getElementById('confirm-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
        handleAnalysis('high-conviction');
      });
      document.getElementById('cancel-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
      });
      document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('message-modal').classList.add('hidden');
      });

      // Cancel buttons
      document.getElementById('cancel-analysis-btn').addEventListener('click', () => {
        if (analysisAbortController) { analysisAbortController.abort('user'); showMessageModal(translations[currentLanguage]['requestAborted']); setStatus('Idle', 'text-gray-300'); }
      });
      document.getElementById('cancel-chat-btn').addEventListener('click', () => {
        if (chatAbortController) { chatAbortController.abort('user'); showMessageModal(translations[currentLanguage]['requestAborted']); setStatus('Idle', 'text-gray-300'); }
      });

      // Analysis image upload
      document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('image-upload').click());
      document.getElementById('image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentImagesData.push(...newImageData);
          renderImagePreviews();
        }
      });

      // Save (disabled)
      document.getElementById('save-btn').addEventListener('click', () => {
        const query = document.getElementById('input-query').value.trim();
        const analysis = document.getElementById('output-text').innerText;
        if(query && analysis){
          showMessageModal("ุชู ุฅุฒุงูุฉ ูุธููุฉ ุงูุญูุธ ูู ูุฐุง ุงูุฅุตุฏุงุฑ");
        } else {
          showMessageModal(translations[currentLanguage]['noAnalysisToSave']);
        }
      });

      document.getElementById('confirm-delete-btn').addEventListener('click', () => { deleteUser(userToDeleteId); hideConfirmDeleteModal(); });
      document.getElementById('cancel-delete-btn').addEventListener('click', hideConfirmDeleteModal);

      // Chat events
      document.getElementById('chat-upload-btn').addEventListener('click', () => document.getElementById('chat-image-upload').click());
      document.getElementById('chat-image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentChatImagesData.push(...newImageData);
          renderChatImagePreviews();
        }
      });
      document.getElementById('chat-clear-btn').addEventListener('click', () => {
        chatHistory.length = 0;
        renderChatMessages();
        currentChatImagesData.length = 0;
        renderChatImagePreviews();
      });
      document.getElementById('chat-send-btn').addEventListener('click', handleChatSend);

      // Initialize AI pill
      updateAiPowerPill();
    });

    // ===== Analysis handler =====
    const handleAnalysis = async (analysisType) => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const queryText = document.getElementById('input-query').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const outputText = document.getElementById('output-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const mainAppContainer = document.getElementById('main-app-container');

      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }
      if (!queryText && currentImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }

      if (analysisAbortController) analysisAbortController.abort('new request');
      analysisAbortController = new AbortController();

      loadingSpinner.classList.remove('hidden');
      outputText.innerHTML = '';
      const aiLevel = computeAiPowerLevel(geminiKey, openaiKey);
      const levelKey = aiLevel === 'super-ultra' ? 'aiSuperUltra' : aiLevel === 'ultra-pro' ? 'aiUltraPro' : 'aiUltra';
      setStatus(aiLevel !== 'off' ? `${translations[currentLanguage][levelKey]}...` : 'Processing...', 'text-yellow-300');
      mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade');
      mainAppContainer.classList.add('bg-default');

      let systemPrompt = '';
      let fullQuery = '';
      if (analysisType === 'high-conviction') {
        systemPrompt = translations[currentLanguage]['highConvictionSystemPrompt']
                        .replace('${tradingStyle}', tradingStyle)
                      + (currentLanguage === 'ar'
                          ? ` ุงูุชุฑููุฒ ุงููููุฌู: "${school}".`
                          : ` Methodological focus: "${school}".`);
      } else if (currentLanguage === 'ar') {
        systemPrompt = `ุฃูุช "JO AI"ุ ุฎุจูุฑ ุชุญููู ุฃุณูุงู ูุงููุฉ ูุชูุฑุณ. ุชุชุญุฏุซ ุงูุนุฑุจูุฉ ุจุงุญุชุฑุงู ูุซูุฉ. ูุฏูู ุชุญูููุงุช ุฏูููุฉ ูููุฌุฒุฉ ูุงุจูุฉ ููุชูููุฐ. ุฃุณููุจ ุงูุชุฏุงูู: "${tradingStyle}". ุงููุฏุฑุณุฉ ุงูุชุญููููุฉ: "${school}".`;
      } else {
        systemPrompt = `You are "JO AI", a seasoned market analyst. Provide accurate, concise, actionable analyses. Trading style: "${tradingStyle}". Analytical school: "${school}".`;
      }

      if (currentLanguage === 'ar') {
        switch (analysisType) {
          case 'technical':
            fullQuery = `ุจุตูุชู ุฎุจูุฑ ุชุญููู ููู ููู ูุฏุฑุณุฉ "${school}", ูุฏูู ุชุญููููุง ููููุง ูู "${queryText}" ูุชูุงูููุง ูุน ุฃุณููุจ "${tradingStyle}". ุฑููุฒ ุนูู ุงูุจููุฉ ุงูุณุนุฑูุฉุ ุงูุณูููุฉุ ููุงุทู ุงูุทูุจ/ุงูุนุฑุถุ ูุณุชููุงุช ุงูุฏุนู/ุงูููุงููุฉุ ูุงูููุงุณุงุช ุงูุฒูููุฉ ุฅู ูุฒู.`;
            break;
          case 'fundamental':
            fullQuery = `ูุฏูู ุชุญููููุง ุฃุณุงุณููุง ูู "${queryText}" ูุน ุฅุจุฑุงุฒ ุงูุนูุงูู ุงููููุฉ ูุงููุงููุฉ. ุฅู ููุฌุฏ ุชุฏุงุฎู ูุน ูุฏุฑุณุฉ "${school}" ูุงุฐูุฑ ููู ูููู ุฃู ุชูููู ุงูุตูุฑุฉ ุงููููุฉ. ุงูุฃุณููุจ: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `ูุฏูู ุชูุตูุฉ ุชุฏุงูู ูุจุงุดุฑุฉ (ุดุฑุงุก/ุจูุน/ุงูุชุธุงุฑ) ูู "${queryText}" ูุน ููุงุท ุฏุฎูู/ุฎุฑูุฌ ูููู ุฎุณุงุฑุฉ ูุญุฏุฏุฉุ ูุฑุงุนู ูููุฌ "${school}" ูุฃุณููุจ "${tradingStyle}". ุถุน ุงูุชูุตูุฉ ูู ุจุฏุงูุฉ ุงูุฑุฏ.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} ุงุณุชุฎุฏู ูููุฌ "${school}" ูุฒูุงุฏุฉ ุฏูุฉ ููุงุท ุงููุฑุงุฑ.`;
            break;
        }
      } else {
        switch (analysisType) {
          case 'technical':
            fullQuery = `As a technical analyst using the "${school}" methodology, provide a technical analysis for "${queryText}" aligned with "${tradingStyle}". Emphasize structure, liquidity, supply/demand zones, S/R, and time metrics if applicable.`;
            break;
          case 'fundamental':
            fullQuery = `Provide a fundamental analysis for "${queryText}". If applicable, mention how the "${school}" approach complements the technical picture. Style: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `Provide a direct trade recommendation (buy/sell/hold) for "${queryText}" with specific entries/exits/stop-loss, aligned with the "${school}" methodology and "${tradingStyle}" style. Put the recommendation at the top.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} Leverage "${school}" to refine decision levels.`;
            break;
        }
      }

      if (currentImagesData.length > 0) {
        if (!queryText) {
          fullQuery = translations[currentLanguage]['imageAnalysisQuery'] + (currentLanguage === 'ar' ? ` ูุทุจูู ูุจุงุฏุฆ "${school}".` : ` and apply "${school}" principles.`);
        } else {
          const suffixKey = currentImagesData.length === 1 ? 'imageReferenceSuffixSingle' : 'imageReferenceSuffixMultiple';
          fullQuery += ` ${translations[currentLanguage][suffixKey]}`;
        }
      }

      const imagesBase64 = currentImagesData.map(d => d.base64);
      const task = async () => {
        try {
          let result;
          if (aiLevel !== 'off') {
            const t0 = performance.now();
            result = await runUltraSynthesisAnalysis({
              level: aiLevel, systemPrompt, userQuery: fullQuery, geminiKey, openaiKey, imagesBase64, abortSignal: analysisAbortController.signal, timeoutMs: 60000
            });
            const t1 = performance.now();
            updateLatency(t1 - t0);
            setStatus('Done', 'text-green-300');
          } else {
            result = await callUnifiedWithFallback({
              provider, systemPrompt, userQuery: fullQuery, geminiKey, openaiKey, imagesBase64, abortSignal: analysisAbortController.signal, timeoutMs: 60000
            });
          }
          document.getElementById('output-text').innerHTML = formatMarkdown(result);
          if (result.includes(translations[currentLanguage]['buyKeyword'])) {
            mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-green-trade');
          } else if (result.includes(translations[currentLanguage]['sellKeyword'])) {
            mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-red-trade');
          } else {
            mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade'); mainAppContainer.classList.add('bg-default');
          }
        } catch (e) {
          if (e?.name === 'AbortError') showMessageModal(translations[currentLanguage]['requestAborted']);
          else showMessageModal((e && e.message) || 'Error');
        } finally {
          document.getElementById('loading-spinner').classList.add('hidden');
          setStatus('Idle', 'text-gray-300');
        }
      };

      analysisQueue.enqueue(task);
    };

    // ===== Chat logic =====
    const chatHistory = []; // { role: 'user'|'assistant', text: string, imagesBase64?: [] }

    const renderChatMessages = () => {
      const box = document.getElementById('chat-messages');
      box.innerHTML = '';
      chatHistory.forEach(msg => {
        const row = document.createElement('div');
        row.className = `chat-row ${msg.role}`;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant'}`;
        bubble.innerHTML = formatMarkdown(msg.text || '');
        row.appendChild(bubble);
        if (msg.imagesBase64?.length) {
          const thumbs = document.createElement('div');
          thumbs.className = 'mt-2 flex gap-2';
          msg.imagesBase64.forEach(b64 => {
            const img = document.createElement('img');
            img.src = `data:image/jpeg;base64,${b64}`;
            img.className = 'chat-image-thumb';
            img.loading = 'lazy';
            thumbs.appendChild(img);
          });
          row.appendChild(thumbs);
        }
        box.appendChild(row);
      });
      box.scrollTop = box.scrollHeight;
    };

    const handleChatSend = async () => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const chatInput = document.getElementById('chat-input');
      const text = chatInput.value.trim();
      const chatLoading = document.getElementById('chat-loading');

      if (!text && currentChatImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }
      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }

      if (chatAbortController) chatAbortController.abort('new chat');
      chatAbortController = new AbortController();

      const systemPrompt = translations[currentLanguage]['chatSystemPrompt']
                            .replace('${tradingStyle}', tradingStyle)
                            .replace('${school}', school);

      const imagesBase64 = currentChatImagesData.map(d => d.base64);
      chatHistory.push({ role: 'user', text, imagesBase64 });
      renderChatMessages();

      chatInput.value = '';
      currentChatImagesData.length = 0;
      renderChatImagePreviews();

      const aiLevel = computeAiPowerLevel(geminiKey, openaiKey);
      const levelKey = aiLevel === 'super-ultra' ? 'aiSuperUltra' : aiLevel === 'ultra-pro' ? 'aiUltraPro' : 'aiUltra';
      chatLoading.classList.remove('hidden');
      setStatus(aiLevel !== 'off' ? `${translations[currentLanguage][levelKey]}...` : 'Processing...', 'text-yellow-300');

      const task = async () => {
        try {
          let assistantReply;
          if (aiLevel !== 'off') {
            const t0 = performance.now();
            assistantReply = await runUltraSynthesisChat({
              level: aiLevel, systemPrompt, history: chatHistory, geminiKey, openaiKey, abortSignal: chatAbortController.signal, timeoutMs: 60000
            });
            const t1 = performance.now();
            updateLatency(t1 - t0);
            setStatus('Done', 'text-green-300');
          } else {
            assistantReply = await callChatWithFallback({
              provider, systemPrompt, history: chatHistory, geminiKey, openaiKey, abortSignal: chatAbortController.signal, timeoutMs: 60000
            });
          }
          chatHistory.push({ role: 'assistant', text: assistantReply });
          renderChatMessages();
        } catch (e) {
          if (e?.name === 'AbortError') showMessageModal(translations[currentLanguage]['requestAborted']);
          else showMessageModal((e && e.message) || 'Error');
        } finally {
          chatLoading.classList.add('hidden');
          setStatus('Idle', 'text-gray-300');
        }
      };

      chatQueue.enqueue(task);
    };

    // Expose for debug
    window._JOAI = { chatHistory };
  </script>
</body>
</html>
