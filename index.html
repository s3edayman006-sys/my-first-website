<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-lang-key="pageTitle">JO AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0c1521; }
    .container { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    #main-app-container.container { background-color: initial; }

    .control-panel { background: linear-gradient(135deg, #1A2033 0%, #171E2D 100%); border: 1px solid #334155; }
    .button-style {
      background: linear-gradient(145deg, #0f172a 0%, #0c1521 100%); color: white;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden;
      border: 1px solid #4ade80; box-shadow: 0 0 10px #4ade8050;
    }
    .button-style:hover { background: linear-gradient(145deg, #1c2742 0%, #151d2e 100%); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
    .button-style:active { transform: translateY(1px); }
    .button-style::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 300%; height: 300%;
      background-color: rgba(255,255,255,0.15); transition: all 0.6s ease-in-out; border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
    }
    .button-style:hover::before { transform: translate(-50%, -50%) scale(1); }
    .modal-overlay { background-color: rgba(12, 21, 33, 0.8); backdrop-filter: blur(4px); }
    .modal-content { background-color: #1f2937; border: 1px solid #334155; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
    .loading-animation { border-top-color: #4ade80; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .glowing-shadow { box-shadow: 0 0 15px rgba(255,255,255,0.1), 0 0 30px rgba(74,222,128,0.2), 0 0 45px rgba(74,222,128,0.1); }
    .glowing-shadow-green { box-shadow: 0 0 15px rgba(74, 222, 128, 0.2), 0 0 30px rgba(74, 222, 128, 0.1), 0 0 45px rgba(74, 222, 128, 0.05); }
    .glowing-shadow-green:hover { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4), 0 0 40px rgba(74, 222, 128, 0.2), 0 0 60px rgba(74, 222, 128, 0.1); }

    /* Background themes */
    .bg-default {
      background-color: #1f2937;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(74, 222, 128, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(74, 222, 128, 0.08) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(74, 222, 128, 0.03) 0%, rgba(74, 222, 128, 0.03) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(74, 222, 128, 0.03) 0%, rgba(74, 222, 128, 0.03) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }
    .bg-green-trade {
      background-color: #064e3b;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(74, 222, 128, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(74, 222, 128, 0.15) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(74, 222, 128, 0.05) 0%, rgba(74, 222, 128, 0.05) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(74, 222, 128, 0.05) 0%, rgba(74, 222, 128, 0.05) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }
    .bg-red-trade {
      background-color: #7f1d1d;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(252, 165, 165, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(252, 165, 165, 0.1) 0%, transparent 40%),
        repeating-linear-gradient(0deg, rgba(252, 165, 165, 0.03) 0%, rgba(252, 165, 165, 0.03) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(252, 165, 165, 0.03) 0%, rgba(252, 165, 165, 0.03) 1px, transparent 1px, transparent 20px);
      background-size: cover; background-position: center center; background-repeat: no-repeat;
      transition: background-color 0.5s ease-in-out;
    }

    /* Multi-image preview (shared) */
    .image-preview-thumbnail { width: 100px; height: 100px; object-fit: cover; border-radius: 0.5rem; border: 2px solid #374151; }
    .remove-image-btn {
      position: absolute; top: -0.5rem; left: -0.5rem;
      background-color: #ef4444; color: white; border-radius: 9999px; width: 1.75rem; height: 1.75rem;
      display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;
    }
    html[dir="ltr"] .remove-image-btn { left: auto; right: -0.5rem; }
    .remove-image-btn:hover { transform: scale(1.1); }

    /* Chat panel styles */
    .chat-panel { background: linear-gradient(135deg, #121a29 0%, #0f1522 100%); border: 1px solid #334155; }
    .chat-messages { max-height: 420px; overflow-y: auto; padding: 0.75rem; }
    .chat-bubble {
      display: inline-block; padding: 0.6rem 0.8rem; border-radius: 0.75rem; line-height: 1.4; font-size: 0.95rem;
      border: 1px solid #303b50;
    }
    .chat-bubble-user { background: #0b1220; color: #e5e7eb; }
    .chat-bubble-assistant { background: #122033; color: #d1d5db; }
    .chat-row { margin: 0.4rem 0; }
    .chat-row.user { text-align: end; }
    .chat-row.assistant { text-align: start; }
    .chat-image-thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #374151; }
  </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center justify-center text-white">
    <!-- أزرار تبديل اللغة -->
  <div class="fixed top-4 right-4 z-50 flex gap-2">
    <button id="lang-ar" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">العربية</button>
    <button id="lang-en" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-semibold text-sm transition-colors duration-200">English</button>
  </div>

  <!-- الشاشة الترحيبية -->
  <div id="welcome-screen" class="min-h-screen w-full flex flex-col items-center justify-center p-4 text-white bg-gradient-to-br from-[#0c1521] to-[#1a2033] via-[#10192a]">
    <div class="container max-w-4xl p-8 rounded-3xl glowing-shadow text-center md:text-right relative overflow-hidden">
      <div class="relative z-10">
        <h1 class="text-4xl lg:text-5xl font-extrabold mb-8 text-green-400">JO AI <span class="text-gray-200" data-lang-key="featuresTitle">Features</span></h1>
        <ul class="space-y-4 text-lg md:text-xl text-right">
          <li class="flex items-start md:items-center"><span class="text-yellow-400 text-2xl ml-3">🔍</span><span class="font-medium text-gray-300" data-lang-key="feature1">Live Market Insights – Tracks prices, market cap, FDV, and token holders.</span></li>
          <li class="flex items-start md:items-center"><span class="text-blue-400 text-2xl ml-3">📈</span><span class="font-medium text-gray-300" data-lang-key="feature2">Token Analytics – Analyzes supply, tokenomics, and unlock schedules.</span></li>
          <li class="flex items-start md:items-center"><span class="text-purple-400 text-2xl ml-3">💡</span><span class="font-medium text-gray-300" data-lang-key="feature3">AI-Powered Insights – Detects trends, sentiment.</span></li>
          <li class="flex items-start md:items-center"><span class="text-green-400 text-2xl ml-3">📊</span><span class="font-medium text-gray-300" data-lang-key="feature4">Technical & Fundamental Analysis – Evaluates price stability, risks, and entry points.</span></li>
          <li class="flex items-start md:items-center"><span class="text-orange-400 text-2xl ml-3">💼</span><span class="font-medium text-gray-300" data-lang-key="feature5">Exchange & Liquidity – Lists exchanges, liquidity scores, and supported wallets.</span></li>
          <li class="flex items-start md:items-center"><span class="text-pink-400 text-2xl ml-3">🌐</span><span class="font-medium text-gray-300" data-lang-key="feature6">Community Tracking – Monitors Twitter, Telegram, and Discord engagement.</span></li>
          <li class="flex items-start md:items-center"><span class="text-red-400 text-2xl ml-3">🔒</span><span class="font-medium text-gray-300" data-lang-key="feature7">Security & Audit Reports – Highlights security scores and past audits.</span></li>
        </ul>
        <button id="proceed-to-login-btn" class="button-style mt-12 px-8 py-4 text-xl rounded-full font-bold glowing-shadow-green" data-lang-key="loginButton">تسجيل الدخول</button>
      </div>
    </div>
  </div>

  <!-- شاشة تسجيل الدخول -->
  <div id="login-form-container" class="hidden w-full max-w-sm">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2" data-lang-key="loginToJOUAI">تسجيل الدخول إلى JO AI</h1>
      </div>
      <form id="login-form" class="space-y-6">
        <div>
          <label for="username-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="usernameLabel">اسم المستخدم:</label>
          <input type="text" id="username-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <div>
          <label for="password-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="passwordLabel">كلمة المرور:</label>
          <input type="password" id="password-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" required />
        </div>
        <button type="submit" class="w-full p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="loginSubmit">تسجيل الدخول</button>
      </form>
    </div>
  </div>

  <!-- شاشة انتظار الموافقة -->
  <div id="waiting-screen" class="hidden w-full max-w-sm text-center">
    <div class="container p-8 rounded-3xl glowing-shadow">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="waitingForApprovalTitle">في انتظار الموافقة</h2>
      <p class="text-gray-400" data-lang-key="waitingForApprovalText">تم إرسال طلب الدخول الخاص بك. يرجى الانتظار حتى تتم الموافقة عليه من قبل المسؤول.</p>
      <div class="mt-6"><div class="loading-animation w-12 h-12 border-4 rounded-full mx-auto"></div></div>
    </div>
  </div>
    <!-- الحاوية الرئيسية -->
  <div id="main-app-container" class="container w-full max-w-4xl p-8 rounded-3xl glowing-shadow hidden bg-default">
    <!-- رأس الصفحة -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">JO AI</h1>
      <p class="text-gray-400" data-lang-key="mainAppSubtitle">أداة تحليل السوق المدعومة بالذكاء الاصطناعي</p>
      <p id="user-id-display" class="text-xs text-gray-500 mt-2" data-lang-key="idPrefix">المعرف: </p>
    </div>

    <!-- لوحة التحكم في التداول -->
    <div class="control-panel p-6 rounded-3xl mb-6">
      <!-- مزوّد النموذج + المفاتيح -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="provider-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="providerLabel">موفّر النموذج:</label>
          <select id="provider-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
            <option value="gemini" selected data-lang-key="providerGemini">Google Gemini</option>
            <option value="openai" data-lang-key="providerOpenAI">OpenAI (ChatGPT)</option>
          </select>
        </div>
        <div>
          <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="apiKeyLabel">مفتاح API:</label>
          <input type="text" id="api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="أدخل مفتاح API الخاص بك من Google AI Studio" data-lang-key="apiKeyPlaceholder" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="openai-api-key-input" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="openaiApiKeyLabel">مفتاح OpenAI:</label>
          <input type="password" id="openai-api-key-input" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-500" placeholder="أدخل مفتاح OpenAI (اختياري)" />
          <p class="text-xs text-gray-500 mt-1" data-lang-key="openaiNote">لن يظهر هذا الحقل إلا عند اختيار OpenAI.</p>
        </div>
      </div>

      <!-- إدخال النص والصور -->
      <div class="grid grid-cols-1 gap-6">
        <div>
          <textarea id="input-query" rows="4" class="w-full p-4 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="اسألني عن السوق... أي شيء. أنا أعرف الإجابة." data-lang-key="inputQueryPlaceholder"></textarea>
          <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
          <div id="image-preview-container" class="hidden mt-4 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
            <div id="image-previews-wrapper" class="flex flex-wrap gap-4"></div>
          </div>
        </div>

        <!-- طريقة اللعب + المدرسة التحليلية -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="trading-style-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="tradingStyleLabel">طريقة اللعب:</label>
            <select id="trading-style-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
              <option value="سكالبينج" data-lang-key="scalpingOption">سكالبينج (Scalping)</option>
              <option value="سوينغ" selected data-lang-key="swingOption">سوينغ (Swing)</option>
              <option value="استثمار" data-lang-key="investmentOption">استثمار (Investment)</option>
            </select>
          </div>
          <div>
            <label for="school-select" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="schoolLabel">المدرسة التحليلية:</label>
            <select id="school-select" class="w-full p-3 text-sm text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300">
              <option value="ICT" selected data-lang-key="schoolICT">مدرسة ICT</option>
              <option value="SMC" data-lang-key="schoolSMC">مدرسة SMC</option>
              <option value="الزمنية" data-lang-key="schoolTime">المدرسة الزمنية</option>
              <option value="الموجية (إليوت)" data-lang-key="schoolElliott">المدرسة الموجية (إليوت)</option>
            </select>
          </div>
        </div>

        <!-- أزرار التحكم -->
        <div>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <button id="analyze-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="technicalAnalysisBtn">تحليل فني</button>
            <button id="fundamental-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="fundamentalAnalysisBtn">تحليل أساسي</button>
            <button id="direct-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="directTradeBtn">توصية تداول</button>
            <button id="high-conviction-trade-btn" class="p-3 button-style rounded-lg font-semibold shadow-md" data-lang-key="highConvictionBtn">توصية ذات قناعة عالية</button>
          </div>
          <div class="mt-4 flex justify-center gap-3">
            <button id="upload-btn" class="w-2/3 p-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105" data-lang-key="uploadImageBtn">تحميل صور</button>
          </div>
        </div>
      </div>
    </div>

    <!-- قسم مخرجات التحليل -->
    <div id="output-section" class="relative bg-gray-800 rounded-lg p-4 min-h-[200px] border border-gray-700 shadow-inner">
      <div id="loading-spinner" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        <div class="loading-animation w-12 h-12 border-4 rounded-full"></div>
      </div>
      <div id="output-text" class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed"></div>
      <div class="flex justify-end mt-4">
        <button id="save-btn" class="hidden px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold text-sm rounded-lg transition-all duration-300 transform hover:scale-105" data-lang-key="saveButton">حفظ</button>
      </div>
    </div>

    <!-- لوحة الشات المتقدّم -->
    <div id="chat-panel" class="chat-panel p-6 rounded-3xl mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-white" data-lang-key="chatTitle">شات GPT متقدّم</h2>
        <div class="flex items-center gap-2 text-xs text-gray-400">
          <span class="hidden md:inline" data-lang-key="chatHint">يدعم السياق والصور • اختر المزوّد من الأعلى</span>
        </div>
      </div>

      <div id="chat-messages" class="chat-messages bg-gray-900/40 rounded-lg border border-gray-700"></div>

      <div class="mt-4">
        <textarea id="chat-input" rows="3" class="w-full p-3 text-gray-100 bg-gray-900 rounded-lg outline-none border border-gray-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300 placeholder-gray-400" placeholder="اكتب رسالتك..." data-lang-key="chatPlaceholder"></textarea>

        <!-- مرفقات صور الشات -->
        <input type="file" id="chat-image-upload" accept="image/*" class="hidden" multiple>
        <div id="chat-image-preview-container" class="hidden mt-3 p-2 rounded-lg border border-gray-700 bg-gray-900/50">
          <div id="chat-image-previews-wrapper" class="flex flex-wrap gap-3"></div>
        </div>

        <div class="flex items-center gap-3 mt-3">
          <button id="chat-upload-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="uploadImageChatBtn">إرفاق صور</button>
          <button id="chat-clear-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300" data-lang-key="clearChat">تفريغ المحادثة</button>
          <div class="ml-auto flex items-center gap-2">
            <div id="chat-loading" class="hidden loading-animation w-6 h-6 border-2 rounded-full"></div>
            <button id="chat-send-btn" class="px-6 py-2 button-style rounded-lg font-semibold" data-lang-key="sendButton">إرسال</button>
          </div>
        </div>
      </div>
    </div>

    <!-- لوحة تحكم المسؤول -->
    <div id="admin-panel" class="hidden mt-6 p-6 bg-gray-900 rounded-2xl shadow-inner border border-gray-700">
      <h2 class="text-2xl font-bold text-white mb-4" data-lang-key="pendingRequestsTitle">طلبات الدخول المعلقة</h2>
      <div id="requests-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="noPendingRequests">لا توجد طلبات معلقة حاليًا.</p>
      </div>
      <h2 class="text-2xl font-bold text-white mb-4 mt-8" data-lang-key="manageUsersTitle">إدارة المستخدمين</h2>
      <div id="users-list" class="space-y-4">
        <p class="text-gray-500" data-lang-key="loadingUsers">جاري تحميل المستخدمين...</p>
      </div>
    </div>
  </div>
    <!-- نموذج الرسالة -->
  <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <div class="text-center">
        <p id="modal-text" class="text-lg text-white mb-4"></p>
        <button id="close-modal-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="okButton">موافق</button>
      </div>
    </div>
  </div>

  <!-- نموذج تأكيد التوصية ذات القناعة العالية -->
  <div id="invincible-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-lg">
      <div class="text-center">
        <h3 class="text-2xl font-bold text-green-400 mb-4" data-lang-key="highConvictionModalTitle">توصية ذات قناعة عالية</h3>
        <p class="text-gray-300 mb-6" data-lang-key="highConvictionModalText">تحليلاتي مبنية على بيانات لا حصر لها، وهذه التوصية تتمتع بأعلى قناعة ممكنة. ومع ذلك، لا يوجد أي ضمان للنجاح في السوق. هل أنت جاهز للمضي قدماً؟</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-invincible-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="yesImReady">نعم، أنا جاهز</button>
          <button id="cancel-invincible-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">إلغاء</button>
        </div>
      </div>
    </div>
  </div>

  <!-- نموذج تأكيد الحذف -->
  <div id="confirm-delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <div class="text-center">
        <h3 class="text-xl font-bold text-red-400 mb-4" data-lang-key="confirmDeleteTitle">تأكيد الحذف</h3>
        <p id="confirm-delete-text" class="text-lg text-white mb-6" data-lang-key="confirmDeleteText">هل أنت متأكد أنك تريد حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="yesDelete">نعم, حذف</button>
          <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full transition-transform duration-200 transform hover:scale-105" data-lang-key="cancelButton">إلغاء</button>
        </div>
      </div>
    </div>
  </div>
    <script type="module">
    // Firebase & Google AI + App logic (with Chat + School + Providers)

    // Firebase (CDN) - v12.2.1
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // --- متغيرات التطبيق ---
    let userId = null;
    let userRole = 'user';
    let currentImagesData = []; // analysis images
    let currentChatImagesData = []; // chat images
    const MAX_RETRIES = 3;
    let userToDeleteId = null;
    const appId = 'default-app-id';
    let currentLanguage = localStorage.getItem('appLang') || 'ar';

    // ترجمات
    const translations = {
      'ar': {
        pageTitle: 'JO AI',
        featuresTitle: 'الميزات',
        feature1: 'رؤى السوق الحية – تتبع الأسعار، القيمة السوقية، FDV، وحاملي الرموز.',
        feature2: 'تحليلات الرموز – تحليل العرض، اقتصاديات الرموز، وجداول الفتح.',
        feature3: 'رؤى مدعومة بالذكاء الاصطناعي – اكتشاف الاتجاهات، المعنويات.',
        feature4: 'تحليل فني وأساسي – تقييم استقرار الأسعار، المخاطر، ونقاط الدخول.',
        feature5: 'التبادل والسيولة – سرد التبادلات، درجات السيولة، والمحافظ المدعومة.',
        feature6: 'تتبع المجتمع – مراقبة التفاعل على تويتر، تلغرام، وديسكورد.',
        feature7: 'تقارير الأمن والتدقيق – تسليط الضوء على درجات الأمان والتدقيقات السابقة.',
        loginButton: 'تسجيل الدخول',
        loginToJOUAI: 'تسجيل الدخول إلى JO AI',
        usernameLabel: 'اسم المستخدم:',
        passwordLabel: 'كلمة المرور:',
        loginSubmit: 'تسجيل الدخول',
        waitingForApprovalTitle: 'في انتظار الموافقة',
        waitingForApprovalText: 'تم إرسال طلب الدخول الخاص بك. يرجى الانتظار حتى تتم الموافقة عليه من قبل المسؤول.',
        mainAppSubtitle: 'أداة تحليل السوق المدعومة بالذكاء الاصطناعي',
        idPrefix: 'المعرف: ',
        apiKeyLabel: 'مفتاح API:',
        apiKeyPlaceholder: 'أدخل مفتاح API الخاص بك من Google AI Studio',
        providerLabel: 'موفّر النموذج:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'مفتاح OpenAI:',
        openaiNote: 'لن يظهر هذا الحقل إلا عند اختيار OpenAI.',
        inputQueryPlaceholder: 'اسألني عن السوق... أي شيء. أنا أعرف الإجابة.',
        tradingStyleLabel: 'طريقة اللعب:',
        scalpingOption: 'سكالبينج (Scalping)',
        swingOption: 'سوينغ (Swing)',
        investmentOption: 'استثمار (Investment)',
        schoolLabel: 'المدرسة التحليلية:',
        schoolICT: 'مدرسة ICT',
        schoolSMC: 'مدرسة SMC',
        schoolTime: 'المدرسة الزمنية',
        schoolElliott: 'المدرسة الموجية (إليوت)',
        technicalAnalysisBtn: 'تحليل فني',
        fundamentalAnalysisBtn: 'تحليل أساسي',
        directTradeBtn: 'توصية تداول',
        highConvictionBtn: 'توصية ذات قناعة عالية',
        uploadImageBtn: 'تحميل صور',
        saveButton: 'حفظ',
        pendingRequestsTitle: 'طلبات الدخول المعلقة',
        noPendingRequests: 'لا توجد طلبات معلقة حاليًا.',
        manageUsersTitle: 'إدارة المستخدمين',
        loadingUsers: 'جاري تحميل المستخدمين...',
        okButton: 'موافق',
        highConvictionModalTitle: 'توصية ذات قناعة عالية',
        highConvictionModalText: 'تحليلاتي مبنية على بيانات لا حصر لها، وهذه التوصية تتمتع بأعلى قناعة ممكنة. ومع ذلك، لا يوجد أي ضمان للنجاح في السوق. هل أنت جاهز للمضي قدماً؟',
        yesImReady: 'نعم، أنا جاهز',
        cancelButton: 'إلغاء',
        confirmDeleteTitle: 'تأكيد الحذف',
        confirmDeleteText: 'هل أنت متأكد أنك تريد حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.',
        yesDelete: 'نعم, حذف',
        unknown: 'غير معروف',
        approveButton: 'موافقة',
        denyButton: 'رفض',
        suspendButton: 'تعليق',
        reactivateButton: 'إعادة تفعيل',
        deleteButton: 'حذف',
        buyKeyword: 'شراء',
        sellKeyword: 'بيع',

        // شات
        chatTitle: 'شات GPT متقدّم',
        chatPlaceholder: 'اكتب رسالتك...',
        sendButton: 'إرسال',
        clearChat: 'تفريغ المحادثة',
        uploadImageChatBtn: 'إرفاق صور',
        chatHint: 'يدعم السياق والصور • اختر المزوّد من الأعلى',

        // رسائل وأخطاء
        firebaseInitFail: 'فشل تهيئة Firebase: ',
        dbConnectionError: 'خطأ في الاتصال بقاعدة البيانات. الرجاء المحاولة لاحقًا.',
        requestAlreadyPending: 'طلب دخول لهذا المستخدم قيد الانتظار بالفعل.',
        loginRequestError: 'حدث خطأ أثناء إرسال طلب الدخول.',
        requestApproved: 'تمت الموافقة على طلبك! الرجاء تسجيل الدخول مرة أخرى.',
        requestDenied: 'تم رفض طلب الدخول الخاص بك.',
        requestCancelled: 'تم إلغاء طلب الدخول الخاص بك.',
        approvalFailed: 'فشل الموافقة على الطلب.',
        denialFailed: 'فشل رفض الطلب.',
        noRegisteredUsers: 'لا يوجد مستخدمون مسجلون.',
        accountSuspended: 'حسابك معلق. يرجى التواصل مع المسؤول.',
        unknownAccountStatus: 'حالة الحساب غير معروفة.',
        loginFlowError: 'حدث خطأ أثناء محاولة تسجيل الدخول.',
        deleteUserSuccess: 'تم حذف المستخدم بنجاح.',
        deleteUserFailed: 'فشل حذف المستخدم.',
        updateUserStatusFailed: 'فشل تحديث حالة المستخدم.',
        noAnalysisToSave: 'لا يوجد تحليل للحفظ.',
        sessionSaveFailed: 'حدث خطأ أثناء حفظ التحليل.',
        sessionSavedSuccess: 'تم حفظ التحليل بنجاح.',
        noDbOrUserForSave: 'لا يمكن حفظ الجلسة. خطأ في الاتصال أو المستخدم غير مسجل.',
        apiKeyRequired: 'الرجاء إدخال مفتاح API الخاص بك.',
        openaiApiKeyRequired: 'الرجاء إدخال مفتاح OpenAI.',
        queryOrImageRequired: 'الرجاء إدخال استفسار أو تحميل صورة.',
        apiRetryFailed: 'حدث خطأ بعد عدة محاولات للاتصال بالـ API. يرجى التحقق من مفتاح API الخاص بك واتصال الشبكة. ',
        apiBlocked: 'تم حظر الاستجابة لأسباب تتعلق بالسلامة: ',

        // Prompts
        highConvictionSystemPrompt: 'بصفتك "JO AI"، أنت خبير أسواق مالية عالمي لا يُعلى عليه... أسلوب تداولك الحالي هو "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'قدم تحليلًا وتوصية تداول ذات قناعة لا تتزعزع لـ "',
        highConvictionUserQuerySuffix: '". استند إلى أعمق مستويات التحليل الفني والأساسي... قدم هذه المعلومات بتنسيق منظم للغاية...',
        imageAnalysisQuery: 'حلل الصور المقدمة من منظور مالي وتداولي. ما هي الأنماط أو المؤشرات أو المعلومات التي يمكنك استخلاصها منها؟',
        imageReferenceSuffixSingle: 'استخدم الصورة المرفقة كمرجع إضافي لتحليلك.',
        imageReferenceSuffixMultiple: 'استخدم الصور المرفقة كمرجع إضافي لتحليلك.',

        // Chat system prompt
        chatSystemPrompt: 'أنت "JO GPT"، مساعد تداول واستثمار فائق التطور. تحدث العربية بطلاقة وبأسلوب احترافي وواثق. قدّم إجابات ذكية موجزة وعميقة، مدعومة بمنطق متماسك ومُلائمة للسياق. التزم بالقواعد: لا وعود، لا نصائح مالية ملزمة، اذكر المخاطر عند الضرورة. نمط التداول الحالي هو "${tradingStyle}" والمنهج الفني المفضّل هو "${school}".'
      },
      'en': {
        pageTitle: 'JO AI',
        featuresTitle: 'Features',
        feature1: 'Live Market Insights – Tracks prices, market cap, FDV, and token holders.',
        feature2: 'Token Analytics – Analyzes supply, tokenomics, and unlock schedules.',
        feature3: 'AI-Powered Insights – Detects trends, sentiment.',
        feature4: 'Technical & Fundamental Analysis – Evaluates price stability, risks, and entry points.',
        feature5: 'Exchange & Liquidity – Lists exchanges, liquidity scores, and supported wallets.',
        feature6: 'Community Tracking – Monitors Twitter, Telegram, and Discord engagement.',
        feature7: 'Security & Audit Reports – Highlights security scores and past audits.',
        loginButton: 'Login',
        loginToJOUAI: 'Login to JO AI',
        usernameLabel: 'Username:',
        passwordLabel: 'Password:',
        loginSubmit: 'Login',
        waitingForApprovalTitle: 'Awaiting Approval',
        waitingForApprovalText: 'Your login request has been sent. Please wait for an administrator to approve it.',
        mainAppSubtitle: 'AI-Powered Market Analysis Tool',
        idPrefix: 'ID: ',
        apiKeyLabel: 'API Key:',
        apiKeyPlaceholder: 'Enter your Google AI Studio API key',
        providerLabel: 'Model Provider:',
        providerGemini: 'Google Gemini',
        providerOpenAI: 'OpenAI (ChatGPT)',
        openaiApiKeyLabel: 'OpenAI Key:',
        openaiNote: 'This field appears only when OpenAI is selected.',
        inputQueryPlaceholder: 'Ask me about the market... anything. I know the answer.',
        tradingStyleLabel: 'Trading Style:',
        scalpingOption: 'Scalping',
        swingOption: 'Swing',
        investmentOption: 'Investment',
        schoolLabel: 'Analytical School:',
        schoolICT: 'ICT School',
        schoolSMC: 'SMC School',
        schoolTime: 'Time-based School',
        schoolElliott: 'Elliott Wave School',
        technicalAnalysisBtn: 'Technical Analysis',
        fundamentalAnalysisBtn: 'Fundamental Analysis',
        directTradeBtn: 'Direct Trade Recommendation',
        highConvictionBtn: 'High Conviction Recommendation',
        uploadImageBtn: 'Upload Images',
        saveButton: 'Save',
        pendingRequestsTitle: 'Pending Login Requests',
        noPendingRequests: 'No pending requests currently.',
        manageUsersTitle: 'User Management',
        loadingUsers: 'Loading users...',
        okButton: 'OK',
        highConvictionModalTitle: 'High Conviction Recommendation',
        highConvictionModalText: 'My analysis is based on countless data points... Are you ready to proceed?',
        yesImReady: 'Yes, I\'m Ready',
        cancelButton: 'Cancel',
        confirmDeleteTitle: 'Confirm Deletion',
        confirmDeleteText: 'Are you sure you want to delete this user? This action cannot be undone.',
        yesDelete: 'Yes, Delete',
        unknown: 'Unknown',
        approveButton: 'Approve',
        denyButton: 'Deny',
        suspendButton: 'Suspend',
        reactivateButton: 'Reactivate',
        deleteButton: 'Delete',
        buyKeyword: 'Buy',
        sellKeyword: 'Sell',

        // Chat
        chatTitle: 'Advanced GPT Chat',
        chatPlaceholder: 'Type your message...',
        sendButton: 'Send',
        clearChat: 'Clear Chat',
        uploadImageChatBtn: 'Attach Images',
        chatHint: 'Context + images supported • Choose provider above',

        // Errors
        firebaseInitFail: 'Firebase initialization failed: ',
        dbConnectionError: 'Database connection error. Please try again later.',
        requestAlreadyPending: 'A login request for this username is already pending.',
        loginRequestError: 'An error occurred while sending the login request.',
        requestApproved: 'Your request has been approved! Please log in again.',
        requestDenied: 'Your login request has been denied.',
        requestCancelled: 'Your login request has been cancelled.',
        approvalFailed: 'Failed to approve request.',
        denialFailed: 'Failed to deny request.',
        noRegisteredUsers: 'No registered users.',
        accountSuspended: 'Your account is suspended. Please contact an administrator.',
        unknownAccountStatus: 'Unknown account status.',
        loginFlowError: 'An error occurred during the login attempt.',
        deleteUserSuccess: 'User deleted successfully.',
        deleteUserFailed: 'Failed to delete user.',
        updateUserStatusFailed: 'Failed to update user status.',
        noAnalysisToSave: 'No analysis to save.',
        sessionSaveFailed: 'An error occurred while saving the analysis.',
        sessionSavedSuccess: 'Analysis saved successfully.',
        noDbOrUserForSave: 'Cannot save session. Connection error or user not logged in.',
        apiKeyRequired: 'Please enter your API key.',
        openaiApiKeyRequired: 'Please enter your OpenAI API key.',
        queryOrImageRequired: 'Please enter a query or upload an image.',
        apiRetryFailed: 'An error occurred after multiple attempts to connect to the API. Please check your API key and network connection. ',
        apiBlocked: 'Response was blocked due to safety reasons: ',

        highConvictionSystemPrompt: 'As "JO AI", you are an unparalleled global financial market expert... Your current trading style is "${tradingStyle}".',
        highConvictionUserQueryPrefix: 'Provide an unwavering high-conviction trading analysis and recommendation for "',
        highConvictionUserQuerySuffix: '". Base your analysis on the deepest levels... Present this information in a highly organized format...',
        imageAnalysisQuery: 'Analyze the provided images from a financial and trading perspective. What patterns, indicators, or information can you extract from them?',
        imageReferenceSuffixSingle: 'Use the attached image as an additional reference for your analysis.',
        imageReferenceSuffixMultiple: 'Use the attached images as an additional reference for your analysis.',

        chatSystemPrompt: 'You are "JO GPT", an ultra-advanced trading/investment assistant. Respond in a professional, confident tone. Provide concise, deep, and context-aware answers with coherent reasoning. No guarantees, no binding financial advice; mention risks when relevant. Current trading style: "${tradingStyle}", preferred technical school: "${school}".'
      }
    };

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCD_WhxL_TzGl4iHfAMFpR7wlYb-3rjK-Y",
      authDomain: "soso-ai-b2c99.firebaseapp.com",
      projectId: "soso-ai-b2c99",
      storageBucket: "soso-ai-b2c99.appspot.com",
      messagingSenderId: "726550376016",
      appId: "1:726550376016:web:42b9ed1bc576873754ab55",
      measurementId: "G-ZVJBJ02Q71"
    };

    // Initialize Firebase
    let app, analytics, auth, db, storage;
    try {
      app = initializeApp(firebaseConfig);
      try { analytics = getAnalytics(app); } catch(e){ console.debug("Analytics not initialized (likely localhost).", e); }
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
    } catch (e) {
      console.error("Firebase init error:", e);
      showMessageModal(`${translations[localStorage.getItem('appLang') || 'ar']['firebaseInitFail']}${e.message}.`);
    }

    // Helpers
    const imageToBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
    });

    const formatMarkdown = (text) => {
      if(!text) return '';
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    };

    const showMessageModal = (message) => {
      const el = document.getElementById('message-modal');
      document.getElementById('modal-text').textContent = message;
      el.classList.remove('hidden');
    };

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        const ud = document.getElementById('user-id-display');
        if (ud) ud.textContent = `${translations[currentLanguage]['idPrefix']}${userId}`;
        console.debug("Authenticated as:", userId);
      }
    });

    // Language update
    const updateLanguage = (lang) => {
      currentLanguage = lang;
      document.documentElement.setAttribute('lang', lang);
      document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

      document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[lang] && translations[lang][key]) {
          if ((element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') && element.hasAttribute('placeholder')) {
            element.setAttribute('placeholder', translations[lang][key]);
          } else {
            element.textContent = translations[lang][key];
          }
        }
      });

      // Document title
      if (translations[lang]?.pageTitle) document.title = translations[lang].pageTitle;

      // Update select options
      document.querySelectorAll('#trading-style-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#school-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });
      document.querySelectorAll('#provider-select option').forEach(option => {
        const key = option.getAttribute('data-lang-key');
        if (translations[lang]?.[key]) option.textContent = translations[lang][key];
      });

      const userIdDisplay = document.getElementById('user-id-display');
      if (userIdDisplay) userIdDisplay.textContent = `${translations[currentLanguage]['idPrefix']}${userId || ''}`;

      // Update admin button labels
      document.querySelectorAll('.approve-btn').forEach(btn => btn.textContent = translations[currentLanguage]['approveButton']);
      document.querySelectorAll('.deny-btn').forEach(btn => btn.textContent = translations[currentLanguage]['denyButton']);
      document.querySelectorAll('.delete-user-btn').forEach(btn => btn.textContent = translations[currentLanguage]['deleteButton']);
      document.querySelectorAll('.user-action-btn').forEach(btn => {
        const currentStatus = btn.dataset.status;
        const buttonTextKey = currentStatus === 'active' ? 'suspendButton' : 'reactivateButton';
        btn.textContent = translations[currentLanguage][buttonTextKey];
      });

      const requestsList = document.getElementById('requests-list');
      if(requestsList && requestsList.querySelector('p.text-gray-500')) {
        requestsList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['noPendingRequests'];
      }
      const usersList = document.getElementById('users-list');
      if(usersList && usersList.querySelector('p.text-gray-500')) {
        usersList.querySelector('p.text-gray-500').textContent = translations[currentLanguage]['loadingUsers'];
      }
    };

    // ===== Providers: Gemini + OpenAI =====
    // Gemini single-turn (analysis)
    const getGeminiResponse = async (systemPrompt, userQuery, apiKey, imagesBase64 = []) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };

      const parts = [];
      if (imagesBase64?.length) {
        imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
      }
      parts.push({ text: userQuery });

      const payload = { contents: [{ parts }], systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          console.error(`Attempt ${i + 1} failed:`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // Gemini multi-turn (chat)
    const getGeminiChatResponse = async (systemPrompt, history, apiKey) => {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };

      // Convert history -> contents
      const contents = history.map(msg => {
        const role = msg.role === 'assistant' ? 'model' : 'user';
        const parts = [];
        if (msg.imagesBase64?.length) {
          msg.imagesBase64.forEach(b64 => parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }));
        }
        parts.push({ text: msg.text });
        return { role, parts };
      });

      const payload = { contents, systemInstruction: { parts: [{ text: systemPrompt }] } };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`API Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const result = await resp.json();
          if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
          const blockReason = result.candidates?.[0]?.finishReason;
          return `${translations[currentLanguage]['apiBlocked']}${blockReason || 'unknown'}.`;
        } catch (error) {
          console.error(`Attempt ${i + 1} failed (Gemini Chat):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // OpenAI chat (analysis + chat)
    const getOpenAIChatResponse = async (systemPrompt, messages, openaiKey, model = 'gpt-4o-mini') => {
      const url = 'https://api.openai.com/v1/chat/completions';
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` };
      const payload = { model, messages, temperature: 0.3 };

      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!resp.ok) {
            let errText = await resp.text().catch(()=>null);
            try { const errorBody = JSON.parse(errText || '{}'); throw new Error(`OpenAI Error: ${resp.status} ${resp.statusText} - ${JSON.stringify(errorBody)}`); }
            catch (e) { throw new Error(`OpenAI Error: ${resp.status} ${resp.statusText} - ${errText}`); }
          }
          const data = await resp.json();
          return data.choices?.[0]?.message?.content || '';
        } catch (error) {
          console.error(`Attempt ${i + 1} failed (OpenAI):`, error);
          if (i === MAX_RETRIES - 1) return `${translations[currentLanguage]['apiRetryFailed']}(${error.message})`;
          await new Promise(r => setTimeout(r, 2 ** i * 1000));
        }
      }
    };

    // Unified provider for analysis
    const getProviderUnifiedResponse = async ({ provider, systemPrompt, userQuery, geminiKey, openaiKey, imagesBase64 }) => {
      if (provider === 'openai') {
        const content = [{ type: 'text', text: userQuery }];
        if (imagesBase64?.length) {
          imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` } }));
        }
        const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content }];
        return await getOpenAIChatResponse(systemPrompt, messages, openaiKey);
      } else {
        return await getGeminiResponse(systemPrompt, userQuery, geminiKey, imagesBase64);
      }
    };

    // ===== Login/Requests/Admin (unchanged except for language hooks) =====
    const submitLoginRequest = async (username) => {
      if (!db) { showMessageModal(translations[currentLanguage]['dbConnectionError']); return; }
      try {
        const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
        const q = query(requestsRef, where("username", "==", username), where("status", "==", "pending"));
        const existingRequests = await getDocs(q);
        if (!existingRequests.empty) {
          showMessageModal(translations[currentLanguage]['requestAlreadyPending']);
          document.getElementById('login-form-container').classList.add('hidden');
          document.getElementById('waiting-screen').classList.remove('hidden');
          listenForApproval(existingRequests.docs[0].id);
          return;
        }
        const docRef = await addDoc(requestsRef, { username, status: 'pending', createdAt: serverTimestamp() });
        sessionStorage.setItem('loginRequestId', docRef.id);
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('waiting-screen').classList.remove('hidden');
        listenForApproval(docRef.id);
      } catch (error) {
        console.error("Error submitting login request:", error);
        showMessageModal(translations[currentLanguage]['loginRequestError']);
      }
    };

    const listenForApproval = (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const unsubscribe = onSnapshot(requestDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const requestData = docSnap.data();
          if (requestData.status === 'approved') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestApproved']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          } else if (requestData.status === 'denied') {
            unsubscribe();
            sessionStorage.removeItem('loginRequestId');
            showMessageModal(translations[currentLanguage]['requestDenied']);
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('login-form').reset();
          }
        } else {
          unsubscribe();
          sessionStorage.removeItem('loginRequestId');
          showMessageModal(translations[currentLanguage]['requestCancelled']);
          document.getElementById('waiting-screen').classList.add('hidden');
          document.getElementById('login-form-container').classList.remove('hidden');
          document.getElementById('login-form').reset();
        }
      }, (error) => console.error("Error listening for approval:", error));
    };

    const loadLoginRequests = () => {
      const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'login_requests');
      const q = query(requestsRef, where("status", "==", "pending"));
      onSnapshot(q, (snapshot) => {
        const requestsList = document.getElementById('requests-list');
        requestsList.innerHTML = '';
        if (snapshot.empty) {
          requestsList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noPendingRequests']}</p>`;
          return;
        }
        snapshot.forEach((docItem) => {
          const request = docItem.data();
          const requestId = docItem.id;
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const requestDate = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US') : translations[currentLanguage]['unknown'];
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${request.username}</p>
              <p class="text-xs text-gray-400">${requestDate}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${requestId}" data-username="${request.username}" class="approve-btn px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['approveButton']}</button>
              <button data-id="${requestId}" class="deny-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['denyButton']}</button>
            </div>
          `;
          requestsList.appendChild(el);
        });
        document.querySelectorAll('.approve-btn').forEach(button => button.addEventListener('click', (e) => approveRequest(e.target.dataset.id, e.target.dataset.username)));
        document.querySelectorAll('.deny-btn').forEach(button => button.addEventListener('click', (e) => denyRequest(e.target.dataset.id)));
      }, (error) => console.error("Error loading login requests:", error));
    };

    const approveRequest = async (requestId, username) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      try {
        await addDoc(usersRef, { username, status: 'active', createdAt: serverTimestamp() });
        await updateDoc(requestDocRef, { status: 'approved' });
      } catch (error) {
        console.error("Error approving request:", error);
        showMessageModal(translations[currentLanguage]['approvalFailed']);
      }
    };

    const denyRequest = async (requestId) => {
      const requestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'login_requests', requestId);
      try { await updateDoc(requestDocRef, { status: 'denied' }); }
      catch (error) { console.error("Error denying request:", error); showMessageModal(translations[currentLanguage]['denialFailed']); }
    };

    const loadUsers = () => {
      const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
      onSnapshot(usersRef, (snapshot) => {
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        if(snapshot.empty){
          usersList.innerHTML = `<p class="text-gray-500">${translations[currentLanguage]['noRegisteredUsers']}</p>`;
          return;
        }
        snapshot.forEach(docItem => {
          const user = docItem.data();
          const el = document.createElement('div');
          el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
          const statusClass = user.status === 'active' ? 'text-green-400' : 'text-red-400';
          const buttonTextKey = user.status === 'active' ? 'suspendButton' : 'reactivateButton';
          const buttonText = translations[currentLanguage][buttonTextKey];
          const buttonClass = user.status === 'active' ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700';
          el.innerHTML = `
            <div>
              <p class="font-semibold text-white">${user.username}</p>
              <p class="text-sm ${statusClass}">${user.status}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${docItem.id}" data-status="${user.status}" class="user-action-btn px-3 py-1 text-white text-sm font-semibold rounded-md ${buttonClass}">${buttonText}</button>
              <button data-id="${docItem.id}" class="delete-user-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md">${translations[currentLanguage]['deleteButton']}</button>
            </div>
          `;
          usersList.appendChild(el);
        });
        document.querySelectorAll('.user-action-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const currentStatus = e.target.dataset.status;
          const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
          updateUserStatus(id, newStatus);
        }));
        document.querySelectorAll('.delete-user-btn').forEach(button => button.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          showConfirmDeleteModal(id);
        }));
      }, (error) => console.error("Error loading users:", error));
    };

    const updateUserStatus = async (userDocId, newStatus) => {
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await updateDoc(userDocRef, { status: newStatus }); }
      catch(error) { console.error("Error updating user status:", error); showMessageModal(translations[currentLanguage]['updateUserStatusFailed']); }
    };

    const showConfirmDeleteModal = (userDocId) => { userToDeleteId = userDocId; document.getElementById('confirm-delete-modal').classList.remove('hidden'); };
    const hideConfirmDeleteModal = () => { userToDeleteId = null; document.getElementById('confirm-delete-modal').classList.add('hidden'); };
    const deleteUser = async (userDocId) => {
      if (!userDocId) return;
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
      try { await deleteDoc(userDocRef); showMessageModal(translations[currentLanguage]['deleteUserSuccess']); }
      catch(error) { console.error("Error deleting user:", error); showMessageModal(translations[currentLanguage]['deleteUserFailed']); }
    };

    // ===== UI rendering for image previews (analysis + chat) =====
    const renderImagePreviews = () => {
      const previewContainer = document.getElementById('image-preview-container');
      const wrapper = document.getElementById('image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentImagesData.length) { previewContainer.classList.add('hidden'); return; }
      currentImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Preview ${index + 1}" class="image-preview-thumbnail">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentImagesData.splice(indexToRemove, 1);
        document.getElementById('image-upload').value = '';
        renderImagePreviews();
      }));
      previewContainer.classList.remove('hidden');
    };

    const renderChatImagePreviews = () => {
      const container = document.getElementById('chat-image-preview-container');
      const wrapper = document.getElementById('chat-image-previews-wrapper');
      wrapper.innerHTML = '';
      if (!currentChatImagesData.length) { container.classList.add('hidden'); return; }
      currentChatImagesData.forEach((imageData, index) => {
        const el = document.createElement('div');
        el.className = 'relative';
        el.innerHTML = `
          <img src="${URL.createObjectURL(imageData.file)}" alt="Chat Preview ${index+1}" class="chat-image-thumb">
          <button data-index="${index}" class="remove-image-btn" title="Remove image">&times;</button>
        `;
        wrapper.appendChild(el);
      });
      wrapper.querySelectorAll('.remove-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
        currentChatImagesData.splice(indexToRemove, 1);
        document.getElementById('chat-image-upload').value = '';
        renderChatImagePreviews();
      }));
      container.classList.remove('hidden');
    };

    // ===== MAIN EVENTS =====
    document.addEventListener('DOMContentLoaded', () => {
      const welcomeScreen = document.getElementById('welcome-screen');
      const loginFormContainer = document.getElementById('login-form-container');
      const proceedToLoginBtn = document.getElementById('proceed-to-login-btn');
      const loginForm = document.getElementById('login-form');
      const mainAppContainer = document.getElementById('main-app-container');

      // Set language
      updateLanguage(currentLanguage);
      if (currentLanguage === 'ar') {
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      } else {
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      }

      // Show welcome
      welcomeScreen.classList.remove('hidden');
      loginFormContainer.classList.add('hidden');
      document.getElementById('waiting-screen').classList.add('hidden');
      mainAppContainer.classList.add('hidden');

      // Welcome -> Login
      proceedToLoginBtn.addEventListener('click', () => {
        welcomeScreen.classList.add('hidden');
        loginFormContainer.classList.remove('hidden');
      });

      // Login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();

        if (username === 'admin' && password === 'admin') {
          userRole = 'admin';
          await signInAnonymously(auth).catch(()=>{});
          loginFormContainer.classList.add('hidden');
          mainAppContainer.classList.remove('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          loadLoginRequests(); loadUsers();
          return;
        }

        try {
          const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
          const q = query(usersRef, where("username", "==", username));
          const userSnapshot = await getDocs(q);
          if (userSnapshot.empty) {
            loginFormContainer.classList.add('hidden');
            submitLoginRequest(username);
          } else {
            const userData = userSnapshot.docs[0].data();
            if(userData.status === 'active'){
              await signInAnonymously(auth).catch(()=>{});
              loginFormContainer.classList.add('hidden');
              mainAppContainer.classList.remove('hidden');
            } else if (userData.status === 'suspended'){
              showMessageModal(translations[currentLanguage]['accountSuspended']);
              loginFormContainer.classList.remove('hidden');
            } else {
              showMessageModal(translations[currentLanguage]['unknownAccountStatus']);
              loginFormContainer.classList.remove('hidden');
            }
          }
        } catch (err) {
          console.error("Login flow error:", err);
          showMessageModal(translations[currentLanguage]['loginFlowError']);
          loginFormContainer.classList.remove('hidden');
        }
      });

      // Language buttons
      document.getElementById('lang-ar').addEventListener('click', () => {
        updateLanguage('ar'); localStorage.setItem('appLang', 'ar');
        document.getElementById('lang-ar').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-en').classList.replace('bg-blue-600', 'bg-gray-600');
      });
      document.getElementById('lang-en').addEventListener('click', () => {
        updateLanguage('en'); localStorage.setItem('appLang', 'en');
        document.getElementById('lang-en').classList.replace('bg-gray-600', 'bg-blue-600');
        document.getElementById('lang-ar').classList.replace('bg-blue-600', 'bg-gray-600');
      });

      // Provider toggle: show/hide OpenAI key
      const providerSelect = document.getElementById('provider-select');
      const openaiKeyInput = document.getElementById('openai-api-key-input');
      const openaiLabel = document.querySelector('label[for="openai-api-key-input"]');
      const openaiNote = document.querySelector('[data-lang-key="openaiNote"]');
      const setOpenAIVisibility = () => {
        const isOpenAI = providerSelect.value === 'openai';
        openaiKeyInput.parentElement.classList.toggle('hidden', !isOpenAI);
        openaiLabel?.classList.toggle('hidden', !isOpenAI);
        openaiNote?.classList.toggle('hidden', !isOpenAI);
      };
      setOpenAIVisibility();
      providerSelect.addEventListener('change', setOpenAIVisibility);

      // Analysis buttons
      document.getElementById('analyze-btn').addEventListener('click', () => handleAnalysis('technical'));
      document.getElementById('fundamental-btn').addEventListener('click', () => handleAnalysis('fundamental'));
      document.getElementById('direct-trade-btn').addEventListener('click', () => handleAnalysis('direct'));
      document.getElementById('high-conviction-trade-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.remove('hidden');
      });
      document.getElementById('confirm-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
        handleAnalysis('high-conviction');
      });
      document.getElementById('cancel-invincible-btn').addEventListener('click', () => {
        document.getElementById('invincible-modal').classList.add('hidden');
      });
      document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('message-modal').classList.add('hidden');
      });

      // Analysis image upload
      document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('image-upload').click());
      document.getElementById('image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentImagesData.push(...newImageData);
          renderImagePreviews();
        }
      });

      // Save (disabled)
      document.getElementById('save-btn').addEventListener('click', () => {
        const query = document.getElementById('input-query').value.trim();
        const analysis = document.getElementById('output-text').innerText;
        if(query && analysis){
          showMessageModal("تم إزالة وظيفة الحفظ في هذا الإصدار");
        } else {
          showMessageModal(translations[currentLanguage]['noAnalysisToSave']);
        }
      });

      document.getElementById('confirm-delete-btn').addEventListener('click', () => { deleteUser(userToDeleteId); hideConfirmDeleteModal(); });
      document.getElementById('cancel-delete-btn').addEventListener('click', hideConfirmDeleteModal);

      // Chat events
      document.getElementById('chat-upload-btn').addEventListener('click', () => document.getElementById('chat-image-upload').click());
      document.getElementById('chat-image-upload').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (files.length > 0) {
          const newImages = Array.from(files);
          const conversionPromises = newImages.map(async (file) => ({ file, base64: await imageToBase64(file) }));
          const newImageData = await Promise.all(conversionPromises);
          currentChatImagesData.push(...newImageData);
          renderChatImagePreviews();
        }
      });
      document.getElementById('chat-clear-btn').addEventListener('click', () => {
        chatHistory.length = 0;
        renderChatMessages();
        currentChatImagesData.length = 0;
        renderChatImagePreviews();
      });
      document.getElementById('chat-send-btn').addEventListener('click', handleChatSend);
    });

    // ===== Analysis handler =====
    const handleAnalysis = async (analysisType) => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const queryText = document.getElementById('input-query').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const outputText = document.getElementById('output-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const mainAppContainer = document.getElementById('main-app-container');

      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }
      if (!queryText && currentImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }

      loadingSpinner.classList.remove('hidden');
      outputText.innerHTML = '';
      mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade');
      mainAppContainer.classList.add('bg-default');

      let systemPrompt = '';
      let fullQuery = '';

      if (analysisType === 'high-conviction') {
        systemPrompt = translations[currentLanguage]['highConvictionSystemPrompt']
                        .replace('${tradingStyle}', tradingStyle)
                      + (currentLanguage === 'ar'
                          ? ` التركيز المنهجي: "${school}".`
                          : ` Methodological focus: "${school}".`);
      } else if (currentLanguage === 'ar') {
        systemPrompt = `أنت "JO AI"، خبير تحليل أسواق مالية متمرس. تتحدث العربية باحتراف وثقة. قدّم تحليلات دقيقة وموجزة قابلة للتنفيذ. أسلوب التداول: "${tradingStyle}". المدرسة التحليلية: "${school}".`;
      } else {
        systemPrompt = `You are "JO AI", a seasoned market analyst. Provide accurate, concise, actionable analyses. Trading style: "${tradingStyle}". Analytical school: "${school}".`;
      }

      if (currentLanguage === 'ar') {
        switch (analysisType) {
          case 'technical':
            fullQuery = `بصفتك خبير تحليل فني وفق مدرسة "${school}", قدّم تحليلًا فنيًا لـ "${queryText}" متوافقًا مع أسلوب "${tradingStyle}". ركّز على البنية السعرية، السيولة، مناطق الطلب/العرض، مستويات الدعم/المقاومة، والقياسات الزمنية إن لزم.`;
            break;
          case 'fundamental':
            fullQuery = `قدّم تحليلًا أساسيًا لـ "${queryText}" مع إبراز العوامل الكلية والمالية. إن وُجد تداخل مع مدرسة "${school}" فاذكر كيف يمكن أن تُكمل الصورة الفنية. الأسلوب: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `قدّم توصية تداول مباشرة (شراء/بيع/انتظار) لـ "${queryText}" مع نقاط دخول/خروج ووقف خسارة محددة، وراعِ منهج "${school}" وأسلوب "${tradingStyle}". ضع التوصية في بداية الرد.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} استخدم منهج "${school}" لزيادة دقة نقاط القرار.`;
            break;
        }
      } else {
        switch (analysisType) {
          case 'technical':
            fullQuery = `As a technical analyst using the "${school}" methodology, provide a technical analysis for "${queryText}" aligned with "${tradingStyle}". Emphasize structure, liquidity, supply/demand zones, S/R, and time metrics if applicable.`;
            break;
          case 'fundamental':
            fullQuery = `Provide a fundamental analysis for "${queryText}". If applicable, mention how the "${school}" approach complements the technical picture. Style: "${tradingStyle}".`;
            break;
          case 'direct':
            fullQuery = `Provide a direct trade recommendation (buy/sell/hold) for "${queryText}" with specific entries/exits/stop-loss, aligned with the "${school}" methodology and "${tradingStyle}" style. Put the recommendation at the top.`;
            break;
          case 'high-conviction':
            fullQuery = `${translations[currentLanguage]['highConvictionUserQueryPrefix']}${queryText}${translations[currentLanguage]['highConvictionUserQuerySuffix']} Leverage "${school}" to refine decision levels.`;
            break;
        }
      }

      if (currentImagesData.length > 0) {
        if (!queryText) {
          fullQuery = translations[currentLanguage]['imageAnalysisQuery'] + (currentLanguage === 'ar' ? ` وطبّق مبادئ "${school}".` : ` and apply "${school}" principles.`);
        } else {
          const suffixKey = currentImagesData.length === 1 ? 'imageReferenceSuffixSingle' : 'imageReferenceSuffixMultiple';
          fullQuery += ` ${translations[currentLanguage][suffixKey]}`;
        }
      }

      const imagesBase64 = currentImagesData.map(d => d.base64);
      const result = await getProviderUnifiedResponse({
        provider: provider,
        systemPrompt: systemPrompt,
        userQuery: fullQuery,
        geminiKey: geminiKey,
        openaiKey: openaiKey,
        imagesBase64
      });

      loadingSpinner.classList.add('hidden');
      document.getElementById('output-text').innerHTML = formatMarkdown(result);

      if (result.includes(translations[currentLanguage]['buyKeyword'])) {
        mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-green-trade');
      } else if (result.includes(translations[currentLanguage]['sellKeyword'])) {
        mainAppContainer.classList.remove('bg-default'); mainAppContainer.classList.add('bg-red-trade');
      } else {
        mainAppContainer.classList.remove('bg-green-trade', 'bg-red-trade'); mainAppContainer.classList.add('bg-default');
      }
    };

    // ===== Chat logic =====
    const chatHistory = []; // { role: 'user'|'assistant', text: string, imagesBase64?: [] }

    const renderChatMessages = () => {
      const box = document.getElementById('chat-messages');
      box.innerHTML = '';
      chatHistory.forEach(msg => {
        const row = document.createElement('div');
        row.className = `chat-row ${msg.role}`;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant'}`;
        bubble.innerHTML = formatMarkdown(msg.text || '');
        row.appendChild(bubble);
        // show thumbs if exist
        if (msg.imagesBase64?.length) {
          const thumbs = document.createElement('div');
          thumbs.className = 'mt-2 flex gap-2';
          msg.imagesBase64.forEach(b64 => {
            const img = document.createElement('img');
            img.src = `data:image/jpeg;base64,${b64}`;
            img.className = 'chat-image-thumb';
            thumbs.appendChild(img);
          });
          row.appendChild(thumbs);
        }
        box.appendChild(row);
      });
      box.scrollTop = box.scrollHeight;
    };

    const handleChatSend = async () => {
      const provider = document.getElementById('provider-select').value;
      const geminiKey = document.getElementById('api-key-input').value.trim();
      const openaiKey = document.getElementById('openai-api-key-input').value.trim();
      const tradingStyle = document.getElementById('trading-style-select').value;
      const school = document.getElementById('school-select').value;
      const chatInput = document.getElementById('chat-input');
      const text = chatInput.value.trim();
      const chatLoading = document.getElementById('chat-loading');

      if (!text && currentChatImagesData.length === 0) { showMessageModal(translations[currentLanguage]['queryOrImageRequired']); return; }
      if (provider === 'openai' && !openaiKey) { showMessageModal(translations[currentLanguage]['openaiApiKeyRequired']); return; }
      if (provider === 'gemini' && !geminiKey) { showMessageModal(translations[currentLanguage]['apiKeyRequired']); return; }

      const systemPrompt = translations[currentLanguage]['chatSystemPrompt']
                            .replace('${tradingStyle}', tradingStyle)
                            .replace('${school}', school);

      // Push user message
      const imagesBase64 = currentChatImagesData.map(d => d.base64);
      chatHistory.push({ role: 'user', text, imagesBase64 });
      renderChatMessages();

      // Clear input and previews
      chatInput.value = '';
      currentChatImagesData.length = 0;
      renderChatImagePreviews();

      chatLoading.classList.remove('hidden');

      let assistantReply = '';
      if (provider === 'openai') {
        // Build OpenAI messages with multimodal last turn
        const messages = [{ role: 'system', content: systemPrompt }];
        for (const msg of chatHistory) {
          if (msg.role === 'assistant') {
            messages.push({ role: 'assistant', content: msg.text });
          } else {
            if (msg.imagesBase64?.length) {
              const content = [{ type: 'text', text: msg.text }];
              msg.imagesBase64.forEach(b64 => content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` }}));
              messages.push({ role: 'user', content });
            } else {
              messages.push({ role: 'user', content: msg.text });
            }
          }
        }
        assistantReply = await getOpenAIChatResponse(systemPrompt, messages, openaiKey);
      } else {
        // Gemini multi-turn
        assistantReply = await getGeminiChatResponse(systemPrompt, chatHistory, geminiKey);
      }

      chatLoading.classList.add('hidden');
      chatHistory.push({ role: 'assistant', text: assistantReply });
      renderChatMessages();
    };

    // ===== Expose some to window if needed (debug) =====
    window._JOAI = { chatHistory };

  </script>
</body>
</html>
